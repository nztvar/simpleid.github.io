<?xml version="1.0" encoding="iso-8859-1"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
  <html xmlns="http://www.w3.org/1999/xhtml">
		<head>
			<!-- template designed by Marco Von Ballmoos -->
			<title>File Source for index.php</title>
			<link rel="stylesheet" href="../media/stylesheet.css" />
			<meta http-equiv='Content-Type' content='text/html; charset=iso-8859-1'/>
		</head>
		<body>
						<h1>Source for file index.php</h1>
<p>Documentation is available at <a href="../simpleid/_www---index.php.html">index.php</a></p>
<div class="src-code">
<div class="src-code"><ol><li><div class="src-line"><a name="a1"></a><span class="src-php">&lt;?php&nbsp;</span></div></li>
<li><div class="src-line"><a name="a2"></a><span class="src-comm">/*</span></div></li>
<li><div class="src-line"><a name="a3"></a><span class="src-comm">&nbsp;*&nbsp;SimpleID</span></div></li>
<li><div class="src-line"><a name="a4"></a><span class="src-comm">&nbsp;*</span></div></li>
<li><div class="src-line"><a name="a5"></a><span class="src-comm">&nbsp;*&nbsp;Copyright&nbsp;(C)&nbsp;Kelvin&nbsp;Mo&nbsp;2007-8</span></div></li>
<li><div class="src-line"><a name="a6"></a><span class="src-comm">&nbsp;*</span></div></li>
<li><div class="src-line"><a name="a7"></a><span class="src-comm">&nbsp;*&nbsp;Includes&nbsp;code&nbsp;Drupal&nbsp;OpenID&nbsp;module&nbsp;(http://drupal.org/project/openid)</span></div></li>
<li><div class="src-line"><a name="a8"></a><span class="src-comm">&nbsp;*&nbsp;Rowan&nbsp;Kerr&nbsp;&lt;rowan@standardinteractive.com&gt;</span></div></li>
<li><div class="src-line"><a name="a9"></a><span class="src-comm">&nbsp;*&nbsp;James&nbsp;Walker&nbsp;&lt;james@bryght.com&gt;</span></div></li>
<li><div class="src-line"><a name="a10"></a><span class="src-comm">&nbsp;*</span></div></li>
<li><div class="src-line"><a name="a11"></a><span class="src-comm">&nbsp;*&nbsp;Copyright&nbsp;(C)&nbsp;Rowan&nbsp;Kerr&nbsp;and&nbsp;James&nbsp;Walker</span></div></li>
<li><div class="src-line"><a name="a12"></a><span class="src-comm">&nbsp;*</span></div></li>
<li><div class="src-line"><a name="a13"></a><span class="src-comm">&nbsp;*&nbsp;This&nbsp;program&nbsp;is&nbsp;free&nbsp;software;&nbsp;you&nbsp;can&nbsp;redistribute&nbsp;it&nbsp;and/or</span></div></li>
<li><div class="src-line"><a name="a14"></a><span class="src-comm">&nbsp;*&nbsp;modify&nbsp;it&nbsp;under&nbsp;the&nbsp;terms&nbsp;of&nbsp;the&nbsp;GNU&nbsp;General&nbsp;Public</span></div></li>
<li><div class="src-line"><a name="a15"></a><span class="src-comm">&nbsp;*&nbsp;License&nbsp;as&nbsp;published&nbsp;by&nbsp;the&nbsp;Free&nbsp;Software&nbsp;Foundation;&nbsp;either</span></div></li>
<li><div class="src-line"><a name="a16"></a><span class="src-comm">&nbsp;*&nbsp;version&nbsp;2&nbsp;of&nbsp;the&nbsp;License,&nbsp;or&nbsp;(at&nbsp;your&nbsp;option)&nbsp;any&nbsp;later&nbsp;version.</span></div></li>
<li><div class="src-line"><a name="a17"></a><span class="src-comm">&nbsp;*</span></div></li>
<li><div class="src-line"><a name="a18"></a><span class="src-comm">&nbsp;*&nbsp;This&nbsp;program&nbsp;is&nbsp;distributed&nbsp;in&nbsp;the&nbsp;hope&nbsp;that&nbsp;it&nbsp;will&nbsp;be&nbsp;useful,</span></div></li>
<li><div class="src-line"><a name="a19"></a><span class="src-comm">&nbsp;*&nbsp;but&nbsp;WITHOUT&nbsp;ANY&nbsp;WARRANTY;&nbsp;without&nbsp;even&nbsp;the&nbsp;implied&nbsp;warranty&nbsp;of</span></div></li>
<li><div class="src-line"><a name="a20"></a><span class="src-comm">&nbsp;*&nbsp;MERCHANTABILITY&nbsp;or&nbsp;FITNESS&nbsp;FOR&nbsp;A&nbsp;PARTICULAR&nbsp;PURPOSE.&nbsp;&nbsp;See&nbsp;the&nbsp;GNU</span></div></li>
<li><div class="src-line"><a name="a21"></a><span class="src-comm">&nbsp;*&nbsp;General&nbsp;Public&nbsp;License&nbsp;for&nbsp;more&nbsp;details.</span></div></li>
<li><div class="src-line"><a name="a22"></a><span class="src-comm">&nbsp;*</span></div></li>
<li><div class="src-line"><a name="a23"></a><span class="src-comm">&nbsp;*&nbsp;You&nbsp;should&nbsp;have&nbsp;received&nbsp;a&nbsp;copy&nbsp;of&nbsp;the&nbsp;GNU&nbsp;General&nbsp;Public</span></div></li>
<li><div class="src-line"><a name="a24"></a><span class="src-comm">&nbsp;*&nbsp;License&nbsp;along&nbsp;with&nbsp;this&nbsp;program;&nbsp;if&nbsp;not,&nbsp;write&nbsp;to&nbsp;the&nbsp;Free</span></div></li>
<li><div class="src-line"><a name="a25"></a><span class="src-comm">&nbsp;*&nbsp;Software&nbsp;Foundation,&nbsp;Inc.,&nbsp;675&nbsp;Mass&nbsp;Ave,&nbsp;Cambridge,&nbsp;MA&nbsp;02139,&nbsp;USA.</span></div></li>
<li><div class="src-line"><a name="a26"></a><span class="src-comm">&nbsp;*&nbsp;</span></div></li>
<li><div class="src-line"><a name="a27"></a><span class="src-comm">&nbsp;*&nbsp;$Id$</span></div></li>
<li><div class="src-line"><a name="a28"></a><span class="src-comm">&nbsp;*/</span></div></li>
<li><div class="src-line"><a name="a29"></a>&nbsp;</div></li>
<li><div class="src-line"><a name="a30"></a><span class="src-doc">/**</span></div></li>
<li><div class="src-line"><a name="a31"></a><span class="src-doc">&nbsp;*&nbsp;Main&nbsp;SimpleID&nbsp;file.</span></div></li>
<li><div class="src-line"><a name="a32"></a><span class="src-doc">&nbsp;*</span></div></li>
<li><div class="src-line"><a name="a33"></a><span class="src-doc">&nbsp;*&nbsp;</span><span class="src-doc-coretag">@package</span><span class="src-doc">&nbsp;simpleid</span></div></li>
<li><div class="src-line"><a name="a34"></a><span class="src-doc">&nbsp;*&nbsp;</span><span class="src-doc-coretag">@filesource</span></div></li>
<li><div class="src-line"><a name="a35"></a><span class="src-doc">&nbsp;*/</span></div></li>
<li><div class="src-line"><a name="a36"></a>&nbsp;</div></li>
<li><div class="src-line"><a name="a37"></a><span class="src-inc">include_once&nbsp;</span><span class="src-str">&quot;version.inc.php&quot;</span><span class="src-sym">;</span></div></li>
<li><div class="src-line"><a name="a38"></a><span class="src-inc">include_once&nbsp;</span><span class="src-str">&quot;locale.inc.php&quot;</span><span class="src-sym">;</span></div></li>
<li><div class="src-line"><a name="a39"></a>&nbsp;</div></li>
<li><div class="src-line"><a name="a40"></a><span class="src-comm">//&nbsp;Check&nbsp;if&nbsp;the&nbsp;configuration&nbsp;file&nbsp;has&nbsp;been&nbsp;defined</span></div></li>
<li><div class="src-line"><a name="a41"></a><span class="src-key">if&nbsp;</span><span class="src-sym">(</span><span class="src-sym">!</span><a href="http://www.php.net/file_exists">file_exists</a><span class="src-sym">(</span><span class="src-str">'config.php'</span><span class="src-sym">))&nbsp;</span><span class="src-sym">{</span></div></li>
<li><div class="src-line"><a name="a42"></a>&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-key">die</span><span class="src-sym">(</span><a href="../simpleid/_www---locale.inc.php.html#functiont">t</a><span class="src-sym">(</span><span class="src-str">'No&nbsp;configuration&nbsp;file&nbsp;found.&nbsp;&nbsp;See&nbsp;the&nbsp;&lt;a&nbsp;href=&quot;!url&quot;&gt;manual&lt;/a&gt;&nbsp;for&nbsp;instructions&nbsp;on&nbsp;how&nbsp;to&nbsp;set&nbsp;up&nbsp;a&nbsp;configuration&nbsp;file.'</span><span class="src-sym">,&nbsp;</span><span class="src-key">array</span><span class="src-sym">(</span><span class="src-str">'!url'&nbsp;</span>=&gt;&nbsp;<span class="src-str">'http://simpleid.koinic.net/documentation/getting-started'</span><span class="src-sym">)))</span><span class="src-sym">;</span></div></li>
<li><div class="src-line"><a name="a43"></a><span class="src-sym">}</span></div></li>
<li><div class="src-line"><a name="a44"></a>&nbsp;</div></li>
<li><div class="src-line"><a name="a45"></a><span class="src-inc">include_once&nbsp;</span><span class="src-str">&quot;config.php&quot;</span><span class="src-sym">;</span></div></li>
<li><div class="src-line"><a name="a46"></a><span class="src-inc">include_once&nbsp;</span><span class="src-str">&quot;config.default.php&quot;</span><span class="src-sym">;</span></div></li>
<li><div class="src-line"><a name="a47"></a><span class="src-inc">include_once&nbsp;</span><span class="src-str">&quot;log.inc.php&quot;</span><span class="src-sym">;</span></div></li>
<li><div class="src-line"><a name="a48"></a><span class="src-inc">include_once&nbsp;</span><span class="src-str">&quot;common.inc.php&quot;</span><span class="src-sym">;</span></div></li>
<li><div class="src-line"><a name="a49"></a><span class="src-inc">include_once&nbsp;</span><span class="src-str">&quot;simpleweb.inc.php&quot;</span><span class="src-sym">;</span></div></li>
<li><div class="src-line"><a name="a50"></a><span class="src-inc">include_once&nbsp;</span><span class="src-str">&quot;openid.inc.php&quot;</span><span class="src-sym">;</span></div></li>
<li><div class="src-line"><a name="a51"></a><span class="src-inc">include_once&nbsp;</span><span class="src-str">&quot;discovery.inc.php&quot;</span><span class="src-sym">;</span></div></li>
<li><div class="src-line"><a name="a52"></a><span class="src-inc">include_once&nbsp;</span><span class="src-str">&quot;user.inc.php&quot;</span><span class="src-sym">;</span></div></li>
<li><div class="src-line"><a name="a53"></a><span class="src-inc">include_once&nbsp;</span><span class="src-str">&quot;cache.inc.php&quot;</span><span class="src-sym">;</span></div></li>
<li><div class="src-line"><a name="a54"></a><span class="src-inc">include_once&nbsp;</span><span class="src-id">SIMPLEID_STORE&nbsp;</span>.&nbsp;<span class="src-str">&quot;.store.php&quot;</span><span class="src-sym">;</span></div></li>
<li><div class="src-line"><a name="a55"></a><span class="src-inc">include_once&nbsp;</span><span class="src-str">&quot;page.inc.php&quot;</span><span class="src-sym">;</span></div></li>
<li><div class="src-line"><a name="a56"></a><span class="src-inc">include_once&nbsp;</span><span class="src-str">&quot;lib/xtemplate.class.php&quot;</span><span class="src-sym">;</span></div></li>
<li><div class="src-line"><a name="a57"></a>&nbsp;</div></li>
<li><div class="src-line"><a name="a58"></a><a href="http://www.php.net/define">define</a><span class="src-sym">(</span><span class="src-str">'CACHE_DIR'</span><span class="src-sym">,&nbsp;</span><span class="src-id">SIMPLEID_CACHE_DIR</span><span class="src-sym">)</span><span class="src-sym">;</span></div></li>
<li><div class="src-line"><a name="a59"></a>&nbsp;</div></li>
<li><div class="src-line"><a name="a60"></a><span class="src-doc">/**</span></div></li>
<li><div class="src-line"><a name="a61"></a><span class="src-doc">&nbsp;*/</span></div></li>
<li><div class="src-line"><a name="a62"></a><a href="http://www.php.net/define">define</a><span class="src-sym">(</span><span class="src-str">'CHECKID_OK'</span><span class="src-sym">,&nbsp;</span><span class="src-num">127</span><span class="src-sym">)</span><span class="src-sym">;</span></div></li>
<li><div class="src-line"><a name="a63"></a><a href="http://www.php.net/define">define</a><span class="src-sym">(</span><span class="src-str">'CHECKID_RETURN_TO_SUSPECT'</span><span class="src-sym">,&nbsp;</span><span class="src-num">3</span><span class="src-sym">)</span><span class="src-sym">;</span></div></li>
<li><div class="src-line"><a name="a64"></a><a href="http://www.php.net/define">define</a><span class="src-sym">(</span><span class="src-str">'CHECKID_APPROVAL_REQUIRED'</span><span class="src-sym">,&nbsp;</span><span class="src-num">2</span><span class="src-sym">)</span><span class="src-sym">;</span></div></li>
<li><div class="src-line"><a name="a65"></a><a href="http://www.php.net/define">define</a><span class="src-sym">(</span><span class="src-str">'CHECKID_LOGIN_REQUIRED'</span><span class="src-sym">,&nbsp;</span>-<span class="src-num">1</span><span class="src-sym">)</span><span class="src-sym">;</span></div></li>
<li><div class="src-line"><a name="a66"></a><a href="http://www.php.net/define">define</a><span class="src-sym">(</span><span class="src-str">'CHECKID_IDENTITIES_NOT_MATCHING'</span><span class="src-sym">,&nbsp;</span>-<span class="src-num">2</span><span class="src-sym">)</span><span class="src-sym">;</span></div></li>
<li><div class="src-line"><a name="a67"></a><a href="http://www.php.net/define">define</a><span class="src-sym">(</span><span class="src-str">'CHECKID_IDENTITY_NOT_EXIST'</span><span class="src-sym">,&nbsp;</span>-<span class="src-num">3</span><span class="src-sym">)</span><span class="src-sym">;</span></div></li>
<li><div class="src-line"><a name="a68"></a><a href="http://www.php.net/define">define</a><span class="src-sym">(</span><span class="src-str">'CHECKID_PROTOCOL_ERROR'</span><span class="src-sym">,&nbsp;</span>-<span class="src-num">127</span><span class="src-sym">)</span><span class="src-sym">;</span></div></li>
<li><div class="src-line"><a name="a69"></a>&nbsp;</div></li>
<li><div class="src-line"><a name="a70"></a><a href="http://www.php.net/define">define</a><span class="src-sym">(</span><span class="src-str">'ASSOCIATION_PRIVATE'</span><span class="src-sym">,&nbsp;</span><span class="src-num">2</span><span class="src-sym">)</span><span class="src-sym">;</span></div></li>
<li><div class="src-line"><a name="a71"></a><a href="http://www.php.net/define">define</a><span class="src-sym">(</span><span class="src-str">'ASSOCIATION_SHARED'</span><span class="src-sym">,&nbsp;</span><span class="src-num">1</span><span class="src-sym">)</span><span class="src-sym">;</span></div></li>
<li><div class="src-line"><a name="a72"></a>&nbsp;</div></li>
<li><div class="src-line"><a name="a73"></a>&nbsp;</div></li>
<li><div class="src-line"><a name="a74"></a><span class="src-doc">/**</span></div></li>
<li><div class="src-line"><a name="a75"></a><span class="src-doc">&nbsp;*&nbsp;This&nbsp;variable&nbsp;holds&nbsp;the&nbsp;version&nbsp;of&nbsp;the&nbsp;OpenID&nbsp;specification&nbsp;associated&nbsp;with</span></div></li>
<li><div class="src-line"><a name="a76"></a><span class="src-doc">&nbsp;*&nbsp;the&nbsp;current&nbsp;OpenID&nbsp;request.&nbsp;&nbsp;This&nbsp;can&nbsp;be&nbsp;either&nbsp;</span><span class="src-doc-inlinetag">{@link&nbsp;OPENID_VERSION_1_1}</span></div></li>
<li><div class="src-line"><a name="a77"></a><span class="src-doc">&nbsp;*&nbsp;or&nbsp;</span><span class="src-doc-inlinetag">{@link&nbsp;OPENID_VERSION_2}</span><span class="src-doc">.</span></div></li>
<li><div class="src-line"><a name="a78"></a><span class="src-doc">&nbsp;*</span></div></li>
<li><div class="src-line"><a name="a79"></a><span class="src-doc">&nbsp;*&nbsp;</span><span class="src-doc-coretag">@global&nbsp;</span><span class="src-doc-type">float&nbsp;</span><span class="src-doc-var">$version&nbsp;</span></div></li>
<li><div class="src-line"><a name="a80"></a><span class="src-doc">&nbsp;*/</span></div></li>
<li><div class="src-line"><a name="a81"></a><span class="src-var">$version&nbsp;</span>=&nbsp;<span class="src-id"><a href="../simpleid/_www---openid.inc.php.html#defineOPENID_VERSION_1_1">OPENID_VERSION_1_1</a></span><span class="src-sym">;</span></div></li>
<li><div class="src-line"><a name="a82"></a>&nbsp;</div></li>
<li><div class="src-line"><a name="a83"></a><span class="src-doc">/**</span></div></li>
<li><div class="src-line"><a name="a84"></a><span class="src-doc">&nbsp;*&nbsp;This&nbsp;variable&nbsp;holds&nbsp;an&nbsp;instance&nbsp;of&nbsp;the&nbsp;XTemplate&nbsp;engine.</span></div></li>
<li><div class="src-line"><a name="a85"></a><span class="src-doc">&nbsp;*</span></div></li>
<li><div class="src-line"><a name="a86"></a><span class="src-doc">&nbsp;*&nbsp;</span><span class="src-doc-coretag">@global&nbsp;</span><span class="src-doc-type">object&nbsp;</span><span class="src-doc-var">$xtpl&nbsp;</span></div></li>
<li><div class="src-line"><a name="a87"></a><span class="src-doc">&nbsp;*/</span></div></li>
<li><div class="src-line"><a name="a88"></a><span class="src-var">$xtpl&nbsp;</span>=&nbsp;<span class="src-id">NULL</span><span class="src-sym">;</span></div></li>
<li><div class="src-line"><a name="a89"></a>&nbsp;</div></li>
<li><div class="src-line"><a name="a90"></a><span class="src-doc">/**</span></div></li>
<li><div class="src-line"><a name="a91"></a><span class="src-doc">&nbsp;*&nbsp;This&nbsp;variable&nbsp;holds&nbsp;the&nbsp;combined&nbsp;$_GET&nbsp;and&nbsp;$_POST&nbsp;superglobal&nbsp;arrays.</span></div></li>
<li><div class="src-line"><a name="a92"></a><span class="src-doc">&nbsp;*&nbsp;This&nbsp;is&nbsp;then&nbsp;passed&nbsp;through&nbsp;</span><span class="src-doc-inlinetag">{@link&nbsp;fix_http_request()}</span><span class="src-doc">.</span></div></li>
<li><div class="src-line"><a name="a93"></a><span class="src-doc">&nbsp;*</span></div></li>
<li><div class="src-line"><a name="a94"></a><span class="src-doc">&nbsp;*&nbsp;</span><span class="src-doc-coretag">@global&nbsp;</span><span class="src-doc-type">array&nbsp;</span><span class="src-doc-var">$GETPOST&nbsp;</span></div></li>
<li><div class="src-line"><a name="a95"></a><span class="src-doc">&nbsp;*/</span></div></li>
<li><div class="src-line"><a name="a96"></a><span class="src-var">$GETPOST&nbsp;</span>=&nbsp;<span class="src-key">array</span><span class="src-sym">(</span><span class="src-sym">)</span><span class="src-sym">;</span></div></li>
<li><div class="src-line"><a name="a97"></a>&nbsp;</div></li>
<li><div class="src-line"><a name="a98"></a><a href="../simpleid/_www---index.php.html#functionsimpleid_start">simpleid_start</a><span class="src-sym">(</span><span class="src-sym">)</span><span class="src-sym">;</span></div></li>
<li><div class="src-line"><a name="a99"></a>&nbsp;</div></li>
<li><div class="src-line"><a name="a100"></a><span class="src-doc">/**</span></div></li>
<li><div class="src-line"><a name="a101"></a><span class="src-doc">&nbsp;*&nbsp;Entry&nbsp;point&nbsp;for&nbsp;SimpleID.</span></div></li>
<li><div class="src-line"><a name="a102"></a><span class="src-doc">&nbsp;*</span></div></li>
<li><div class="src-line"><a name="a103"></a><span class="src-doc">&nbsp;*&nbsp;</span><span class="src-doc-coretag">@see</span><span class="src-doc">&nbsp;user_init()</span></div></li>
<li><div class="src-line"><a name="a104"></a><span class="src-doc">&nbsp;*/</span></div></li>
<li><div class="src-line"><a name="a105"></a><span class="src-key">function&nbsp;</span><a href="../simpleid/_www---index.php.html#functionsimpleid_start">simpleid_start</a><span class="src-sym">(</span><span class="src-sym">)&nbsp;</span><span class="src-sym">{</span></div></li>
<li><div class="src-line"><a name="a106"></a>&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-key">global&nbsp;</span><a href="../simpleid/_www---index.php.html#global$xtpl">$xtpl</a><span class="src-sym">,&nbsp;</span><a href="../simpleid/_www---index.php.html#global$GETPOST">$GETPOST</a><span class="src-sym">;</span></div></li>
<li><div class="src-line"><a name="a107"></a>&nbsp;&nbsp;&nbsp;&nbsp;</div></li>
<li><div class="src-line"><a name="a108"></a>&nbsp;&nbsp;&nbsp;&nbsp;<a href="../simpleid/_www---locale.inc.php.html#functionlocale_init">locale_init</a><span class="src-sym">(</span><span class="src-id"><a href="../simpleid/_www---config.php.dist.html#defineSIMPLEID_LOCALE">SIMPLEID_LOCALE</a></span><span class="src-sym">)</span><span class="src-sym">;</span></div></li>
<li><div class="src-line"><a name="a109"></a>&nbsp;</div></li>
<li><div class="src-line"><a name="a110"></a>&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-var">$xtpl&nbsp;</span>=&nbsp;<span class="src-key">new&nbsp;</span><span class="src-id"><a href="../XTemplate/XTemplate.html">XTemplate</a></span><span class="src-sym">(</span><span class="src-str">'html/template.xtpl'</span><span class="src-sym">)</span><span class="src-sym">;</span></div></li>
<li><div class="src-line"><a name="a111"></a>&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-var">$xtpl</span><span class="src-sym">-&gt;</span><span class="src-id">assign</span><span class="src-sym">(</span><span class="src-str">'version'</span><span class="src-sym">,&nbsp;</span><span class="src-id"><a href="../simpleid/_www---version.inc.php.html#defineSIMPLEID_VERSION">SIMPLEID_VERSION</a></span><span class="src-sym">)</span><span class="src-sym">;</span></div></li>
<li><div class="src-line"><a name="a112"></a>&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-var">$xtpl</span><span class="src-sym">-&gt;</span><span class="src-id">assign</span><span class="src-sym">(</span><span class="src-str">'base_path'</span><span class="src-sym">,&nbsp;</span><a href="../simpleid/_www---common.inc.php.html#functionget_base_path">get_base_path</a><span class="src-sym">(</span><span class="src-sym">))</span><span class="src-sym">;</span></div></li>
<li><div class="src-line"><a name="a113"></a>&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-var">$xtpl</span><span class="src-sym">-&gt;</span><span class="src-id">assign</span><span class="src-sym">(</span><span class="src-str">'footer_doc'</span><span class="src-sym">,&nbsp;</span><a href="../simpleid/_www---locale.inc.php.html#functiont">t</a><span class="src-sym">(</span><span class="src-str">'Documentation'</span><span class="src-sym">))</span><span class="src-sym">;</span></div></li>
<li><div class="src-line"><a name="a114"></a>&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-var">$xtpl</span><span class="src-sym">-&gt;</span><span class="src-id">assign</span><span class="src-sym">(</span><span class="src-str">'footer_support'</span><span class="src-sym">,&nbsp;</span><a href="../simpleid/_www---locale.inc.php.html#functiont">t</a><span class="src-sym">(</span><span class="src-str">'Support'</span><span class="src-sym">))</span><span class="src-sym">;</span></div></li>
<li><div class="src-line"><a name="a115"></a>&nbsp;&nbsp;&nbsp;&nbsp;</div></li>
<li><div class="src-line"><a name="a116"></a>&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-key">if&nbsp;</span><span class="src-sym">(</span><span class="src-sym">!</span><a href="http://www.php.net/is_dir">is_dir</a><span class="src-sym">(</span><span class="src-id"><a href="../simpleid/_www---config.php.dist.html#defineSIMPLEID_IDENTITIES_DIR">SIMPLEID_IDENTITIES_DIR</a></span><span class="src-sym">))&nbsp;</span><span class="src-sym">{</span></div></li>
<li><div class="src-line"><a name="a117"></a>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a href="../simpleid/_www---log.inc.php.html#functionlog_fatal">log_fatal</a><span class="src-sym">(</span><span class="src-str">'Identities&nbsp;directory&nbsp;not&nbsp;found.'</span><span class="src-sym">)</span><span class="src-sym">;</span></div></li>
<li><div class="src-line"><a name="a118"></a>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a href="../simpleid/_www---common.inc.php.html#functionindirect_fatal_error">indirect_fatal_error</a><span class="src-sym">(</span><a href="../simpleid/_www---locale.inc.php.html#functiont">t</a><span class="src-sym">(</span><span class="src-str">'Identities&nbsp;directory&nbsp;not&nbsp;found.&nbsp;&nbsp;See&nbsp;the&nbsp;&lt;a&nbsp;href=&quot;!url&quot;&gt;manual&lt;/a&gt;&nbsp;for&nbsp;instructions&nbsp;on&nbsp;how&nbsp;to&nbsp;set&nbsp;up&nbsp;SimpleID.'</span><span class="src-sym">,&nbsp;</span><span class="src-key">array</span><span class="src-sym">(</span><span class="src-str">'!url'&nbsp;</span>=&gt;&nbsp;<span class="src-str">'http://simpleid.koinic.net/documentation/getting-started'</span><span class="src-sym">)))</span><span class="src-sym">;</span></div></li>
<li><div class="src-line"><a name="a119"></a>&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-sym">}</span></div></li>
<li><div class="src-line"><a name="a120"></a>&nbsp;&nbsp;&nbsp;&nbsp;</div></li>
<li><div class="src-line"><a name="a121"></a>&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-key">if&nbsp;</span><span class="src-sym">(</span><span class="src-sym">!</span><a href="http://www.php.net/is_dir">is_dir</a><span class="src-sym">(</span><span class="src-id"><a href="../simpleid/_www---config.php.dist.html#defineSIMPLEID_CACHE_DIR">SIMPLEID_CACHE_DIR</a></span><span class="src-sym">)&nbsp;</span>||&nbsp;<span class="src-sym">!</span><a href="http://www.php.net/is_writeable">is_writeable</a><span class="src-sym">(</span><span class="src-id"><a href="../simpleid/_www---config.php.dist.html#defineSIMPLEID_CACHE_DIR">SIMPLEID_CACHE_DIR</a></span><span class="src-sym">))&nbsp;</span><span class="src-sym">{</span></div></li>
<li><div class="src-line"><a name="a122"></a>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a href="../simpleid/_www---log.inc.php.html#functionlog_fatal">log_fatal</a><span class="src-sym">(</span><span class="src-str">'Cache&nbsp;directory&nbsp;not&nbsp;found&nbsp;or&nbsp;not&nbsp;writeable.'</span><span class="src-sym">)</span><span class="src-sym">;</span></div></li>
<li><div class="src-line"><a name="a123"></a>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a href="../simpleid/_www---common.inc.php.html#functionindirect_fatal_error">indirect_fatal_error</a><span class="src-sym">(</span><a href="../simpleid/_www---locale.inc.php.html#functiont">t</a><span class="src-sym">(</span><span class="src-str">'Cache&nbsp;directory&nbsp;not&nbsp;found&nbsp;or&nbsp;not&nbsp;writeable.&nbsp;&nbsp;See&nbsp;the&nbsp;&lt;a&nbsp;href=&quot;!url&quot;&gt;manual&lt;/a&gt;&nbsp;for&nbsp;instructions&nbsp;on&nbsp;how&nbsp;to&nbsp;set&nbsp;up&nbsp;SimpleID.'</span><span class="src-sym">,&nbsp;</span><span class="src-key">array</span><span class="src-sym">(</span><span class="src-str">'!url'&nbsp;</span>=&gt;&nbsp;<span class="src-str">'http://simpleid.koinic.net/documentation/getting-started'</span><span class="src-sym">)))</span><span class="src-sym">;</span></div></li>
<li><div class="src-line"><a name="a124"></a>&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-sym">}</span></div></li>
<li><div class="src-line"><a name="a125"></a>&nbsp;&nbsp;&nbsp;&nbsp;</div></li>
<li><div class="src-line"><a name="a126"></a>&nbsp;&nbsp;&nbsp;&nbsp;</div></li>
<li><div class="src-line"><a name="a127"></a>&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-key">if&nbsp;</span><span class="src-sym">(</span><span class="src-sym">!</span><a href="http://www.php.net/is_dir">is_dir</a><span class="src-sym">(</span><span class="src-id"><a href="../simpleid/_www---config.php.dist.html#defineSIMPLEID_STORE_DIR">SIMPLEID_STORE_DIR</a></span><span class="src-sym">)&nbsp;</span>||&nbsp;<span class="src-sym">!</span><a href="http://www.php.net/is_writeable">is_writeable</a><span class="src-sym">(</span><span class="src-id"><a href="../simpleid/_www---config.php.dist.html#defineSIMPLEID_STORE_DIR">SIMPLEID_STORE_DIR</a></span><span class="src-sym">))&nbsp;</span><span class="src-sym">{</span></div></li>
<li><div class="src-line"><a name="a128"></a>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a href="../simpleid/_www---log.inc.php.html#functionlog_fatal">log_fatal</a><span class="src-sym">(</span><span class="src-str">'Store&nbsp;directory&nbsp;not&nbsp;found&nbsp;or&nbsp;not&nbsp;writeable.'</span><span class="src-sym">)</span><span class="src-sym">;</span></div></li>
<li><div class="src-line"><a name="a129"></a>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a href="../simpleid/_www---common.inc.php.html#functionindirect_fatal_error">indirect_fatal_error</a><span class="src-sym">(</span><a href="../simpleid/_www---locale.inc.php.html#functiont">t</a><span class="src-sym">(</span><span class="src-str">'Store&nbsp;directory&nbsp;not&nbsp;found&nbsp;or&nbsp;not&nbsp;writeable.&nbsp;&nbsp;See&nbsp;the&nbsp;&lt;a&nbsp;href=&quot;!url&quot;&gt;manual&lt;/a&gt;&nbsp;for&nbsp;instructions&nbsp;on&nbsp;how&nbsp;to&nbsp;set&nbsp;up&nbsp;SimpleID.'</span><span class="src-sym">,&nbsp;</span><span class="src-key">array</span><span class="src-sym">(</span><span class="src-str">'!url'&nbsp;</span>=&gt;&nbsp;<span class="src-str">'http://simpleid.koinic.net/documentation/getting-started'</span><span class="src-sym">)))</span><span class="src-sym">;</span></div></li>
<li><div class="src-line"><a name="a130"></a>&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-sym">}</span></div></li>
<li><div class="src-line"><a name="a131"></a>&nbsp;&nbsp;&nbsp;&nbsp;</div></li>
<li><div class="src-line"><a name="a132"></a>&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-key">if&nbsp;</span><span class="src-sym">((</span><span class="src-sym">@</span><a href="http://www.php.net/ini_get">ini_get</a><span class="src-sym">(</span><span class="src-str">'register_globals'</span><span class="src-sym">)&nbsp;</span>===&nbsp;<span class="src-num">1</span><span class="src-sym">)&nbsp;</span>||&nbsp;<span class="src-sym">(</span><span class="src-sym">@</span><a href="http://www.php.net/ini_get">ini_get</a><span class="src-sym">(</span><span class="src-str">'register_globals'</span><span class="src-sym">)&nbsp;</span>===&nbsp;<span class="src-str">'1'</span><span class="src-sym">)&nbsp;</span>||&nbsp;<span class="src-sym">(</span><a href="http://www.php.net/strtolower">strtolower</a><span class="src-sym">(</span><span class="src-sym">@</span><a href="http://www.php.net/ini_get">ini_get</a><span class="src-sym">(</span><span class="src-str">'register_globals'</span><span class="src-sym">))&nbsp;</span>==&nbsp;<span class="src-str">'on'</span><span class="src-sym">))&nbsp;</span><span class="src-sym">{</span></div></li>
<li><div class="src-line"><a name="a133"></a>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a href="../simpleid/_www---log.inc.php.html#functionlog_fatal">log_fatal</a><span class="src-sym">(</span><span class="src-str">'register_globals&nbsp;is&nbsp;enabled&nbsp;in&nbsp;PHP&nbsp;configuration.'</span><span class="src-sym">)</span><span class="src-sym">;</span></div></li>
<li><div class="src-line"><a name="a134"></a>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a href="../simpleid/_www---common.inc.php.html#functionindirect_fatal_error">indirect_fatal_error</a><span class="src-sym">(</span><a href="../simpleid/_www---locale.inc.php.html#functiont">t</a><span class="src-sym">(</span><span class="src-str">'register_globals&nbsp;is&nbsp;enabled&nbsp;in&nbsp;PHP&nbsp;configuration,&nbsp;which&nbsp;is&nbsp;not&nbsp;supported&nbsp;by&nbsp;SimpleID.&nbsp;&nbsp;See&nbsp;the&nbsp;&lt;a&nbsp;href=&quot;!url&quot;&gt;manual&lt;/a&gt;&nbsp;for&nbsp;further&nbsp;information.'</span><span class="src-sym">,&nbsp;</span><span class="src-key">array</span><span class="src-sym">(</span><span class="src-str">'!url'&nbsp;</span>=&gt;&nbsp;<span class="src-str">'http://simpleid.koinic.net/documentation/getting-started/system-requirements'</span><span class="src-sym">)))</span><span class="src-sym">;</span></div></li>
<li><div class="src-line"><a name="a135"></a>&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-sym">}</span></div></li>
<li><div class="src-line"><a name="a136"></a>&nbsp;&nbsp;&nbsp;&nbsp;</div></li>
<li><div class="src-line"><a name="a137"></a>&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-key">if&nbsp;</span><span class="src-sym">(</span><span class="src-sym">!</span><a href="../simpleid/_www---bignum.inc.php.html#functionbignum_loaded">bignum_loaded</a><span class="src-sym">(</span><span class="src-sym">))&nbsp;</span><span class="src-sym">{</span></div></li>
<li><div class="src-line"><a name="a138"></a>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a href="../simpleid/_www---log.inc.php.html#functionlog_fatal">log_fatal</a><span class="src-sym">(</span><span class="src-str">'gmp/bcmath&nbsp;PHP&nbsp;extension&nbsp;not&nbsp;loaded.'</span><span class="src-sym">)</span><span class="src-sym">;</span></div></li>
<li><div class="src-line"><a name="a139"></a>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a href="../simpleid/_www---common.inc.php.html#functionindirect_fatal_error">indirect_fatal_error</a><span class="src-sym">(</span><a href="../simpleid/_www---locale.inc.php.html#functiont">t</a><span class="src-sym">(</span><span class="src-str">'One&nbsp;or&nbsp;more&nbsp;required&nbsp;PHP&nbsp;extensions&nbsp;(%extension)&nbsp;is&nbsp;not&nbsp;loaded.&nbsp;&nbsp;See&nbsp;the&nbsp;&lt;a&nbsp;href=&quot;!url&quot;&gt;manual&lt;/a&gt;&nbsp;for&nbsp;further&nbsp;information&nbsp;on&nbsp;system&nbsp;requirements.'</span><span class="src-sym">,&nbsp;</span><span class="src-key">array</span><span class="src-sym">(</span><span class="src-str">'%extension'&nbsp;</span>=&gt;&nbsp;<span class="src-str">'gmp/bcmath'</span><span class="src-sym">,&nbsp;</span><span class="src-str">'!url'&nbsp;</span>=&gt;&nbsp;<span class="src-str">'http://simpleid.koinic.net/documentation/getting-started/system-requirements'</span><span class="src-sym">)))</span><span class="src-sym">;</span></div></li>
<li><div class="src-line"><a name="a140"></a>&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-sym">}</span></div></li>
<li><div class="src-line"><a name="a141"></a>&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-key">if&nbsp;</span><span class="src-sym">(</span><span class="src-sym">!</span><a href="http://www.php.net/function_exists">function_exists</a><span class="src-sym">(</span><span class="src-str">'preg_match'</span><span class="src-sym">))&nbsp;</span><span class="src-sym">{</span></div></li>
<li><div class="src-line"><a name="a142"></a>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a href="../simpleid/_www---log.inc.php.html#functionlog_fatal">log_fatal</a><span class="src-sym">(</span><span class="src-str">'pcre&nbsp;PHP&nbsp;extension&nbsp;not&nbsp;loaded.'</span><span class="src-sym">)</span><span class="src-sym">;</span></div></li>
<li><div class="src-line"><a name="a143"></a>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a href="../simpleid/_www---common.inc.php.html#functionindirect_fatal_error">indirect_fatal_error</a><span class="src-sym">(</span><a href="../simpleid/_www---locale.inc.php.html#functiont">t</a><span class="src-sym">(</span><span class="src-str">'One&nbsp;or&nbsp;more&nbsp;required&nbsp;PHP&nbsp;extensions&nbsp;(%extension)&nbsp;is&nbsp;not&nbsp;loaded.&nbsp;&nbsp;See&nbsp;the&nbsp;&lt;a&nbsp;href=&quot;!url&quot;&gt;manual&lt;/a&gt;&nbsp;for&nbsp;further&nbsp;information&nbsp;on&nbsp;system&nbsp;requirements.'</span><span class="src-sym">,&nbsp;</span><span class="src-key">array</span><span class="src-sym">(</span><span class="src-str">'%extension'&nbsp;</span>=&gt;&nbsp;<span class="src-str">'pcre'</span><span class="src-sym">,&nbsp;</span><span class="src-str">'!url'&nbsp;</span>=&gt;&nbsp;<span class="src-str">'http://simpleid.koinic.net/documentation/getting-started/system-requirements'</span><span class="src-sym">)))</span><span class="src-sym">;</span></div></li>
<li><div class="src-line"><a name="a144"></a>&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-sym">}</span></div></li>
<li><div class="src-line"><a name="a145"></a>&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-key">if&nbsp;</span><span class="src-sym">(</span><span class="src-sym">!</span><a href="http://www.php.net/function_exists">function_exists</a><span class="src-sym">(</span><span class="src-str">'session_start'</span><span class="src-sym">))&nbsp;</span><span class="src-sym">{</span></div></li>
<li><div class="src-line"><a name="a146"></a>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a href="../simpleid/_www---log.inc.php.html#functionlog_fatal">log_fatal</a><span class="src-sym">(</span><span class="src-str">'session&nbsp;PHP&nbsp;extension&nbsp;not&nbsp;loaded.'</span><span class="src-sym">)</span><span class="src-sym">;</span></div></li>
<li><div class="src-line"><a name="a147"></a>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a href="../simpleid/_www---common.inc.php.html#functionindirect_fatal_error">indirect_fatal_error</a><span class="src-sym">(</span><a href="../simpleid/_www---locale.inc.php.html#functiont">t</a><span class="src-sym">(</span><span class="src-str">'One&nbsp;or&nbsp;more&nbsp;required&nbsp;PHP&nbsp;extensions&nbsp;(%extension)&nbsp;is&nbsp;not&nbsp;loaded.&nbsp;&nbsp;See&nbsp;the&nbsp;&lt;a&nbsp;href=&quot;!url&quot;&gt;manual&lt;/a&gt;&nbsp;for&nbsp;further&nbsp;information&nbsp;on&nbsp;system&nbsp;requirements.'</span><span class="src-sym">,&nbsp;</span><span class="src-key">array</span><span class="src-sym">(</span><span class="src-str">'%extension'&nbsp;</span>=&gt;&nbsp;<span class="src-str">'session'</span><span class="src-sym">,&nbsp;</span><span class="src-str">'!url'&nbsp;</span>=&gt;&nbsp;<span class="src-str">'http://simpleid.koinic.net/documentation/getting-started/system-requirements'</span><span class="src-sym">)))</span><span class="src-sym">;</span></div></li>
<li><div class="src-line"><a name="a148"></a>&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-sym">}</span></div></li>
<li><div class="src-line"><a name="a149"></a>&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-key">if&nbsp;</span><span class="src-sym">(</span><span class="src-sym">!</span><a href="http://www.php.net/function_exists">function_exists</a><span class="src-sym">(</span><span class="src-str">'xml_parser_create_ns'</span><span class="src-sym">))&nbsp;</span><span class="src-sym">{</span></div></li>
<li><div class="src-line"><a name="a150"></a>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a href="../simpleid/_www---log.inc.php.html#functionlog_fatal">log_fatal</a><span class="src-sym">(</span><span class="src-str">'xml&nbsp;PHP&nbsp;extension&nbsp;not&nbsp;loaded.'</span><span class="src-sym">)</span><span class="src-sym">;</span></div></li>
<li><div class="src-line"><a name="a151"></a>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a href="../simpleid/_www---common.inc.php.html#functionindirect_fatal_error">indirect_fatal_error</a><span class="src-sym">(</span><a href="../simpleid/_www---locale.inc.php.html#functiont">t</a><span class="src-sym">(</span><span class="src-str">'One&nbsp;or&nbsp;more&nbsp;required&nbsp;PHP&nbsp;extensions&nbsp;(%extension)&nbsp;is&nbsp;not&nbsp;loaded.&nbsp;&nbsp;See&nbsp;the&nbsp;&lt;a&nbsp;href=&quot;!url&quot;&gt;manual&lt;/a&gt;&nbsp;for&nbsp;further&nbsp;information&nbsp;on&nbsp;system&nbsp;requirements.'</span><span class="src-sym">,&nbsp;</span><span class="src-key">array</span><span class="src-sym">(</span><span class="src-str">'%extension'&nbsp;</span>=&gt;&nbsp;<span class="src-str">'xml'</span><span class="src-sym">,&nbsp;</span><span class="src-str">'!url'&nbsp;</span>=&gt;&nbsp;<span class="src-str">'http://simpleid.koinic.net/documentation/getting-started/system-requirements'</span><span class="src-sym">)))</span><span class="src-sym">;</span></div></li>
<li><div class="src-line"><a name="a152"></a>&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-sym">}</span></div></li>
<li><div class="src-line"><a name="a153"></a>&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-key">if&nbsp;</span><span class="src-sym">(</span><span class="src-sym">!</span><a href="http://www.php.net/function_exists">function_exists</a><span class="src-sym">(</span><span class="src-str">'hash'</span><span class="src-sym">))&nbsp;</span><span class="src-sym">{</span></div></li>
<li><div class="src-line"><a name="a154"></a>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a href="../simpleid/_www---log.inc.php.html#functionlog_fatal">log_fatal</a><span class="src-sym">(</span><span class="src-str">'hash&nbsp;PHP&nbsp;extension&nbsp;not&nbsp;loaded.'</span><span class="src-sym">)</span><span class="src-sym">;</span></div></li>
<li><div class="src-line"><a name="a155"></a>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a href="../simpleid/_www---common.inc.php.html#functionindirect_fatal_error">indirect_fatal_error</a><span class="src-sym">(</span><a href="../simpleid/_www---locale.inc.php.html#functiont">t</a><span class="src-sym">(</span><span class="src-str">'One&nbsp;or&nbsp;more&nbsp;required&nbsp;PHP&nbsp;extensions&nbsp;(%extension)&nbsp;is&nbsp;not&nbsp;loaded.&nbsp;&nbsp;See&nbsp;the&nbsp;&lt;a&nbsp;href=&quot;!url&quot;&gt;manual&lt;/a&gt;&nbsp;for&nbsp;further&nbsp;information&nbsp;on&nbsp;system&nbsp;requirements.'</span><span class="src-sym">,&nbsp;</span><span class="src-key">array</span><span class="src-sym">(</span><span class="src-str">'%extension'&nbsp;</span>=&gt;&nbsp;<span class="src-str">'hash'</span><span class="src-sym">,&nbsp;</span><span class="src-str">'!url'&nbsp;</span>=&gt;&nbsp;<span class="src-str">'http://simpleid.koinic.net/documentation/getting-started/system-requirements'</span><span class="src-sym">)))</span><span class="src-sym">;</span></div></li>
<li><div class="src-line"><a name="a156"></a>&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-sym">}</span></div></li>
<li><div class="src-line"><a name="a157"></a>&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-key">if&nbsp;</span><span class="src-sym">(</span><a href="http://www.php.net/is_numeric">is_numeric</a><span class="src-sym">(</span><span class="src-sym">@</span><a href="http://www.php.net/ini_get">ini_get</a><span class="src-sym">(</span><span class="src-str">'suhosin.get.max_value_length'</span><span class="src-sym">))&nbsp;</span>&amp;&amp;&nbsp;<span class="src-sym">(</span><span class="src-sym">@</span><a href="http://www.php.net/ini_get">ini_get</a><span class="src-sym">(</span><span class="src-str">'suhosin.get.max_value_length'</span><span class="src-sym">)&nbsp;</span>&lt;&nbsp;<span class="src-num">1024</span><span class="src-sym">))&nbsp;</span><span class="src-sym">{</span></div></li>
<li><div class="src-line"><a name="a158"></a>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a href="../simpleid/_www---log.inc.php.html#functionlog_fatal">log_fatal</a><span class="src-sym">(</span><span class="src-str">'suhosin.get.max_value_length&nbsp;&lt;&nbsp;1024'</span><span class="src-sym">)</span><span class="src-sym">;</span></div></li>
<li><div class="src-line"><a name="a159"></a>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a href="../simpleid/_www---common.inc.php.html#functionindirect_fatal_error">indirect_fatal_error</a><span class="src-sym">(</span><a href="../simpleid/_www---locale.inc.php.html#functiont">t</a><span class="src-sym">(</span><span class="src-str">'suhosin.get.max_value_length&nbsp;is&nbsp;less&nbsp;than&nbsp;1024,&nbsp;which&nbsp;will&nbsp;lead&nbsp;to&nbsp;problems.&nbsp;See&nbsp;the&nbsp;&lt;a&nbsp;href=&quot;!url&quot;&gt;manual&lt;/a&gt;&nbsp;for&nbsp;further&nbsp;information&nbsp;on&nbsp;system&nbsp;requirements.'</span><span class="src-sym">,&nbsp;</span><span class="src-key">array</span><span class="src-sym">(</span><span class="src-str">'!url'&nbsp;</span>=&gt;&nbsp;<span class="src-str">'http://simpleid.koinic.net/documentation/getting-started/system-requirements'</span><span class="src-sym">)))</span><span class="src-sym">;</span></div></li>
<li><div class="src-line"><a name="a160"></a>&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-sym">}</span></div></li>
<li><div class="src-line"><a name="a161"></a>&nbsp;</div></li>
<li><div class="src-line"><a name="a162"></a>&nbsp;&nbsp;&nbsp;&nbsp;<a href="../simpleid/_www---common.inc.php.html#functionfix_http_request">fix_http_request</a><span class="src-sym">(</span><span class="src-sym">)</span><span class="src-sym">;</span></div></li>
<li><div class="src-line"><a name="a163"></a>&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-var">$GETPOST&nbsp;</span>=&nbsp;<a href="http://www.php.net/array_merge">array_merge</a><span class="src-sym">(</span><span class="src-var">$_GET</span><span class="src-sym">,&nbsp;</span><span class="src-var">$_POST</span><span class="src-sym">)</span><span class="src-sym">;</span></div></li>
<li><div class="src-line"><a name="a164"></a>&nbsp;&nbsp;&nbsp;&nbsp;<a href="../simpleid/_www---openid.inc.php.html#functionopenid_parse_request">openid_parse_request</a><span class="src-sym">(</span><span class="src-var">$GETPOST</span><span class="src-sym">)</span><span class="src-sym">;</span></div></li>
<li><div class="src-line"><a name="a165"></a>&nbsp;&nbsp;&nbsp;&nbsp;</div></li>
<li><div class="src-line"><a name="a166"></a>&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-var">$q&nbsp;</span>=&nbsp;<span class="src-sym">(</span>isset<span class="src-sym">(</span><span class="src-var">$GETPOST</span><span class="src-sym">[</span><span class="src-str">'q'</span><span class="src-sym">]</span><span class="src-sym">))&nbsp;</span>?&nbsp;<span class="src-var">$GETPOST</span><span class="src-sym">[</span><span class="src-str">'q'</span><span class="src-sym">]&nbsp;</span>:&nbsp;<span class="src-str">''</span><span class="src-sym">;</span></div></li>
<li><div class="src-line"><a name="a167"></a>&nbsp;&nbsp;&nbsp;&nbsp;</div></li>
<li><div class="src-line"><a name="a168"></a>&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-var">$uaid&nbsp;</span>=&nbsp;<a href="../simpleid/_www---common.inc.php.html#functionget_user_agent_id">get_user_agent_id</a><span class="src-sym">(</span><span class="src-sym">)</span><span class="src-sym">;</span></div></li>
<li><div class="src-line"><a name="a169"></a>&nbsp;&nbsp;&nbsp;&nbsp;<a href="../simpleid/_www---common.inc.php.html#functionextension_init">extension_init</a><span class="src-sym">(</span><span class="src-sym">)</span><span class="src-sym">;</span></div></li>
<li><div class="src-line"><a name="a170"></a>&nbsp;&nbsp;&nbsp;&nbsp;<a href="../simpleid/_www---user.inc.php.html#functionuser_init">user_init</a><span class="src-sym">(</span><span class="src-var">$q</span><span class="src-sym">)</span><span class="src-sym">;</span></div></li>
<li><div class="src-line"><a name="a171"></a>&nbsp;&nbsp;&nbsp;&nbsp;<a href="../simpleid/_www---log.inc.php.html#functionlog_info">log_info</a><span class="src-sym">(</span><span class="src-str">'Session&nbsp;opened&nbsp;for&nbsp;&quot;'&nbsp;</span>.&nbsp;<span class="src-var">$q&nbsp;</span>.&nbsp;<span class="src-str">'&quot;&nbsp;from&nbsp;'&nbsp;</span>.&nbsp;<span class="src-var">$uaid&nbsp;</span>.&nbsp;<span class="src-str">'&nbsp;['&nbsp;</span>.&nbsp;<span class="src-var">$_SERVER</span><span class="src-sym">[</span><span class="src-str">'REMOTE_ADDR'</span><span class="src-sym">]&nbsp;</span>.&nbsp;<span class="src-str">',&nbsp;'&nbsp;</span>.&nbsp;<a href="http://www.php.net/gethostbyaddr">gethostbyaddr</a><span class="src-sym">(</span><span class="src-var">$_SERVER</span><span class="src-sym">[</span><span class="src-str">'REMOTE_ADDR'</span><span class="src-sym">]</span><span class="src-sym">)&nbsp;</span>.&nbsp;<span class="src-str">']'</span><span class="src-sym">)</span><span class="src-sym">;</span></div></li>
<li><div class="src-line"><a name="a172"></a>&nbsp;&nbsp;&nbsp;&nbsp;</div></li>
<li><div class="src-line"><a name="a173"></a>&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-comm">//&nbsp;Clean&nbsp;stale&nbsp;assocations</span></div></li>
<li><div class="src-line"><a name="a174"></a>&nbsp;&nbsp;&nbsp;&nbsp;<a href="../simpleid/_www---cache.inc.php.html#functioncache_expire">cache_expire</a><span class="src-sym">(</span><span class="src-key">array</span><span class="src-sym">(</span></div></li>
<li><div class="src-line"><a name="a175"></a>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-str">'association'&nbsp;</span>=&gt;&nbsp;<span class="src-id"><a href="../simpleid/_www---config.php.dist.html#defineSIMPLEID_ASSOC_EXPIRES_IN">SIMPLEID_ASSOC_EXPIRES_IN</a></span><span class="src-sym">,</span></div></li>
<li><div class="src-line"><a name="a176"></a>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-str">'stateless'&nbsp;</span>=&gt;&nbsp;<span class="src-num">300</span><span class="src-sym">)</span></div></li>
<li><div class="src-line"><a name="a177"></a>&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-sym">)</span><span class="src-sym">;</span></div></li>
<li><div class="src-line"><a name="a178"></a>&nbsp;&nbsp;&nbsp;&nbsp;</div></li>
<li><div class="src-line"><a name="a179"></a>&nbsp;&nbsp;&nbsp;&nbsp;<a href="../simpleid/_www---index.php.html#functionsimpleid_route">simpleid_route</a><span class="src-sym">(</span><span class="src-var">$q</span><span class="src-sym">)</span><span class="src-sym">;</span></div></li>
<li><div class="src-line"><a name="a180"></a><span class="src-sym">}</span></div></li>
<li><div class="src-line"><a name="a181"></a>&nbsp;</div></li>
<li><div class="src-line"><a name="a182"></a><span class="src-doc">/**</span></div></li>
<li><div class="src-line"><a name="a183"></a><span class="src-doc">&nbsp;*&nbsp;Dispatches&nbsp;to&nbsp;the&nbsp;correct&nbsp;SimpleID&nbsp;function&nbsp;based&nbsp;on&nbsp;the&nbsp;request&nbsp;path.&nbsp;&nbsp;The</span></div></li>
<li><div class="src-line"><a name="a184"></a><span class="src-doc">&nbsp;*&nbsp;request&nbsp;path&nbsp;usually&nbsp;comes&nbsp;from&nbsp;the&nbsp;q&nbsp;parameter&nbsp;in&nbsp;the&nbsp;query&nbsp;string&nbsp;(which&nbsp;may</span></div></li>
<li><div class="src-line"><a name="a185"></a><span class="src-doc">&nbsp;*&nbsp;be&nbsp;inserted&nbsp;by&nbsp;mod_rewrite),&nbsp;but&nbsp;can&nbsp;come&nbsp;from&nbsp;other&nbsp;functions&nbsp;as&nbsp;well.</span></div></li>
<li><div class="src-line"><a name="a186"></a><span class="src-doc">&nbsp;*</span></div></li>
<li><div class="src-line"><a name="a187"></a><span class="src-doc">&nbsp;*&nbsp;</span><span class="src-doc-coretag">@param&nbsp;</span><span class="src-doc-type">string&nbsp;</span><span class="src-doc-var">$q&nbsp;</span><span class="src-doc">the&nbsp;request&nbsp;path</span></div></li>
<li><div class="src-line"><a name="a188"></a><span class="src-doc">&nbsp;*/</span></div></li>
<li><div class="src-line"><a name="a189"></a><span class="src-key">function&nbsp;</span><a href="../simpleid/_www---index.php.html#functionsimpleid_route">simpleid_route</a><span class="src-sym">(</span><span class="src-var">$q</span><span class="src-sym">)&nbsp;</span><span class="src-sym">{</span></div></li>
<li><div class="src-line"><a name="a190"></a>&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-var">$routes&nbsp;</span>=&nbsp;<span class="src-key">array</span><span class="src-sym">(</span></div></li>
<li><div class="src-line"><a name="a191"></a>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-str">'continue'&nbsp;</span>=&gt;&nbsp;<span class="src-str">'simpleid_continue'</span><span class="src-sym">,</span></div></li>
<li><div class="src-line"><a name="a192"></a>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-str">'login'&nbsp;</span>=&gt;&nbsp;<span class="src-str">'user_login'</span><span class="src-sym">,</span></div></li>
<li><div class="src-line"><a name="a193"></a>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-str">'logout'&nbsp;</span>=&gt;&nbsp;<span class="src-str">'user_logout'</span><span class="src-sym">,</span></div></li>
<li><div class="src-line"><a name="a194"></a>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-str">'my/dashboard'&nbsp;</span>=&gt;&nbsp;<span class="src-str">'page_dashboard'</span><span class="src-sym">,</span></div></li>
<li><div class="src-line"><a name="a195"></a>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-str">'my/sites'&nbsp;</span>=&gt;&nbsp;<span class="src-str">'page_sites'</span><span class="src-sym">,</span></div></li>
<li><div class="src-line"><a name="a196"></a>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-str">'my/profile'&nbsp;</span>=&gt;&nbsp;<span class="src-str">'page_profile'</span><span class="src-sym">,</span></div></li>
<li><div class="src-line"><a name="a197"></a>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-str">'otp'&nbsp;</span>=&gt;&nbsp;<span class="src-str">'user_otp_page'</span><span class="src-sym">,</span></div></li>
<li><div class="src-line"><a name="a198"></a>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-str">'openid/consent'&nbsp;</span>=&gt;&nbsp;<span class="src-str">'simpleid_openid_consent'</span><span class="src-sym">,</span></div></li>
<li><div class="src-line"><a name="a199"></a>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-str">'ppid/(.*)'&nbsp;</span>=&gt;&nbsp;<span class="src-str">'user_ppid_page'</span><span class="src-sym">,</span></div></li>
<li><div class="src-line"><a name="a200"></a>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-str">'user'&nbsp;</span>=&gt;&nbsp;<span class="src-str">'user_public_page'</span><span class="src-sym">,</span></div></li>
<li><div class="src-line"><a name="a201"></a>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-str">'user/(.+)'&nbsp;</span>=&gt;&nbsp;<span class="src-str">'user_public_page'</span><span class="src-sym">,</span></div></li>
<li><div class="src-line"><a name="a202"></a>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-str">'xrds/(.*)'&nbsp;</span>=&gt;&nbsp;<span class="src-str">'user_xrds'</span><span class="src-sym">,</span></div></li>
<li><div class="src-line"><a name="a203"></a>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-str">'xrds'&nbsp;</span>=&gt;&nbsp;<span class="src-str">'simpleid_xrds'</span><span class="src-sym">,</span></div></li>
<li><div class="src-line"><a name="a204"></a>&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-sym">)</span><span class="src-sym">;</span></div></li>
<li><div class="src-line"><a name="a205"></a>&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-var">$routes&nbsp;</span>=&nbsp;<a href="http://www.php.net/array_merge">array_merge</a><span class="src-sym">(</span><span class="src-var">$routes</span><span class="src-sym">,&nbsp;</span><a href="../simpleid/_www---common.inc.php.html#functionextension_invoke_all">extension_invoke_all</a><span class="src-sym">(</span><span class="src-str">'routes'</span><span class="src-sym">)</span><span class="src-sym">,&nbsp;</span><span class="src-key">array</span><span class="src-sym">(</span><span class="src-str">'.*'&nbsp;</span>=&gt;&nbsp;<span class="src-str">'simpleid_index'</span><span class="src-sym">))</span><span class="src-sym">;</span></div></li>
<li><div class="src-line"><a name="a206"></a>&nbsp;&nbsp;&nbsp;&nbsp;</div></li>
<li><div class="src-line"><a name="a207"></a>&nbsp;&nbsp;&nbsp;&nbsp;<a href="../simpleweb/_www---simpleweb.inc.php.html#functionsimpleweb_run">simpleweb_run</a><span class="src-sym">(</span><span class="src-var">$routes</span><span class="src-sym">,&nbsp;</span><span class="src-var">$q</span><span class="src-sym">)</span><span class="src-sym">;</span></div></li>
<li><div class="src-line"><a name="a208"></a><span class="src-sym">}</span></div></li>
<li><div class="src-line"><a name="a209"></a>&nbsp;</div></li>
<li><div class="src-line"><a name="a210"></a><span class="src-doc">/**</span></div></li>
<li><div class="src-line"><a name="a211"></a><span class="src-doc">&nbsp;*&nbsp;The&nbsp;default&nbsp;route,&nbsp;called&nbsp;when&nbsp;the&nbsp;q&nbsp;parameter&nbsp;is&nbsp;missing&nbsp;or&nbsp;is&nbsp;invalid.</span></div></li>
<li><div class="src-line"><a name="a212"></a><span class="src-doc">&nbsp;*</span></div></li>
<li><div class="src-line"><a name="a213"></a><span class="src-doc">&nbsp;*&nbsp;This&nbsp;function&nbsp;performs&nbsp;the&nbsp;following:</span></div></li>
<li><div class="src-line"><a name="a214"></a><span class="src-doc">&nbsp;*</span></div></li>
<li><div class="src-line"><a name="a215"></a><span class="src-doc">&nbsp;*&nbsp;-&nbsp;If&nbsp;openid.mode&nbsp;is&nbsp;present,&nbsp;then&nbsp;the&nbsp;request&nbsp;is&nbsp;an&nbsp;OpenID&nbsp;request.&nbsp;&nbsp;This</span></div></li>
<li><div class="src-line"><a name="a216"></a><span class="src-doc">&nbsp;*&nbsp;&nbsp;&nbsp;is&nbsp;passed&nbsp;to&nbsp;</span><span class="src-doc-inlinetag">{@link&nbsp;simpleid_process_openid()}</span></div></li>
<li><div class="src-line"><a name="a217"></a><span class="src-doc">&nbsp;*&nbsp;-&nbsp;If&nbsp;the&nbsp;Accept&nbsp;HTTP&nbsp;header&nbsp;contains&nbsp;the&nbsp;expression&nbsp;application/xrds+xml,&nbsp;then</span></div></li>
<li><div class="src-line"><a name="a218"></a><span class="src-doc">&nbsp;*&nbsp;&nbsp;&nbsp;the&nbsp;request&nbsp;is&nbsp;a&nbsp;YADIS&nbsp;discovery&nbsp;request&nbsp;for&nbsp;SimpleID&nbsp;as&nbsp;an&nbsp;OpenID&nbsp;provider.&nbsp;&nbsp;Thi</span></div></li>
<li><div class="src-line"><a name="a219"></a><span class="src-doc">&nbsp;*&nbsp;&nbsp;&nbsp;is&nbsp;passed&nbsp;to&nbsp;</span><span class="src-doc-inlinetag">{@link&nbsp;simpleid_xrds()}</span></div></li>
<li><div class="src-line"><a name="a220"></a><span class="src-doc">&nbsp;*&nbsp;-&nbsp;Otherwise,&nbsp;the&nbsp;dashboard&nbsp;or&nbsp;the&nbsp;login&nbsp;page&nbsp;is&nbsp;displayed&nbsp;to&nbsp;the&nbsp;user&nbsp;as</span></div></li>
<li><div class="src-line"><a name="a221"></a><span class="src-doc">&nbsp;*&nbsp;&nbsp;&nbsp;appropriate</span></div></li>
<li><div class="src-line"><a name="a222"></a><span class="src-doc">&nbsp;*</span></div></li>
<li><div class="src-line"><a name="a223"></a><span class="src-doc">&nbsp;*/</span></div></li>
<li><div class="src-line"><a name="a224"></a><span class="src-key">function&nbsp;</span><a href="../simpleid/_www---index.php.html#functionsimpleid_index">simpleid_index</a><span class="src-sym">(</span><span class="src-sym">)&nbsp;</span><span class="src-sym">{</span></div></li>
<li><div class="src-line"><a name="a225"></a>&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-key">global&nbsp;</span><a href="../simpleid/_www---index.php.html#global$GETPOST">$GETPOST</a><span class="src-sym">;</span></div></li>
<li><div class="src-line"><a name="a226"></a>&nbsp;&nbsp;&nbsp;&nbsp;</div></li>
<li><div class="src-line"><a name="a227"></a>&nbsp;&nbsp;&nbsp;&nbsp;<a href="../simpleid/_www---log.inc.php.html#functionlog_debug">log_debug</a><span class="src-sym">(</span><span class="src-str">'simpleid_index'</span><span class="src-sym">)</span><span class="src-sym">;</span></div></li>
<li><div class="src-line"><a name="a228"></a>&nbsp;&nbsp;&nbsp;&nbsp;</div></li>
<li><div class="src-line"><a name="a229"></a>&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-var">$content_type&nbsp;</span>=&nbsp;<a href="../simpleid/_www---common.inc.php.html#functionnegotiate_content_type">negotiate_content_type</a><span class="src-sym">(</span><span class="src-key">array</span><span class="src-sym">(</span><span class="src-str">'text/html'</span><span class="src-sym">,&nbsp;</span><span class="src-str">'application/xml'</span><span class="src-sym">,&nbsp;</span><span class="src-str">'application/xhtml+xml'</span><span class="src-sym">,&nbsp;</span><span class="src-str">'application/xrds+xml'</span><span class="src-sym">))</span><span class="src-sym">;</span></div></li>
<li><div class="src-line"><a name="a230"></a>&nbsp;&nbsp;&nbsp;&nbsp;</div></li>
<li><div class="src-line"><a name="a231"></a>&nbsp;&nbsp;&nbsp;&nbsp;<a href="http://www.php.net/header">header</a><span class="src-sym">(</span><span class="src-str">'Vary:&nbsp;Accept'</span><span class="src-sym">)</span><span class="src-sym">;</span></div></li>
<li><div class="src-line"><a name="a232"></a>&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-key">if&nbsp;</span><span class="src-sym">(</span>isset<span class="src-sym">(</span><span class="src-var">$GETPOST</span><span class="src-sym">[</span><span class="src-str">'openid.mode'</span><span class="src-sym">]</span><span class="src-sym">))&nbsp;</span><span class="src-sym">{</span></div></li>
<li><div class="src-line"><a name="a233"></a>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a href="../simpleid/_www---index.php.html#functionsimpleid_process_openid">simpleid_process_openid</a><span class="src-sym">(</span><span class="src-var">$GETPOST</span><span class="src-sym">)</span><span class="src-sym">;</span></div></li>
<li><div class="src-line"><a name="a234"></a>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-key">return</span><span class="src-sym">;</span></div></li>
<li><div class="src-line"><a name="a235"></a>&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-sym">}&nbsp;</span><span class="src-key">elseif&nbsp;</span><span class="src-sym">(</span><span class="src-var">$content_type&nbsp;</span>==&nbsp;<span class="src-str">'application/xrds+xml'</span><span class="src-sym">)&nbsp;</span><span class="src-sym">{</span></div></li>
<li><div class="src-line"><a name="a236"></a>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a href="../simpleid/_www---index.php.html#functionsimpleid_xrds">simpleid_xrds</a><span class="src-sym">(</span><span class="src-sym">)</span><span class="src-sym">;</span></div></li>
<li><div class="src-line"><a name="a237"></a>&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-sym">}&nbsp;</span><span class="src-key">else&nbsp;</span><span class="src-sym">{</span></div></li>
<li><div class="src-line"><a name="a238"></a>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-comm">//&nbsp;Point&nbsp;to&nbsp;SimpleID's&nbsp;XRDS&nbsp;document</span></div></li>
<li><div class="src-line"><a name="a239"></a>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a href="http://www.php.net/header">header</a><span class="src-sym">(</span><span class="src-str">'X-XRDS-Location:&nbsp;'&nbsp;</span>.&nbsp;<a href="../simpleid/_www---common.inc.php.html#functionsimpleid_url">simpleid_url</a><span class="src-sym">(</span><span class="src-str">'xrds'</span><span class="src-sym">))</span><span class="src-sym">;</span></div></li>
<li><div class="src-line"><a name="a240"></a>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a href="../simpleid/_www---page.inc.php.html#functionpage_dashboard">page_dashboard</a><span class="src-sym">(</span><span class="src-sym">)</span><span class="src-sym">;</span></div></li>
<li><div class="src-line"><a name="a241"></a>&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-sym">}</span></div></li>
<li><div class="src-line"><a name="a242"></a><span class="src-sym">}</span></div></li>
<li><div class="src-line"><a name="a243"></a>&nbsp;</div></li>
<li><div class="src-line"><a name="a244"></a>&nbsp;</div></li>
<li><div class="src-line"><a name="a245"></a><span class="src-doc">/**</span></div></li>
<li><div class="src-line"><a name="a246"></a><span class="src-doc">&nbsp;*&nbsp;Process&nbsp;an&nbsp;OpenID&nbsp;request.</span></div></li>
<li><div class="src-line"><a name="a247"></a><span class="src-doc">&nbsp;*</span></div></li>
<li><div class="src-line"><a name="a248"></a><span class="src-doc">&nbsp;*&nbsp;This&nbsp;function&nbsp;determines&nbsp;the&nbsp;version&nbsp;of&nbsp;the&nbsp;OpenID&nbsp;specification&nbsp;that&nbsp;is</span></div></li>
<li><div class="src-line"><a name="a249"></a><span class="src-doc">&nbsp;*&nbsp;relevant&nbsp;to&nbsp;this&nbsp;request,&nbsp;checks&nbsp;openid.mode&nbsp;and&nbsp;passes&nbsp;the</span></div></li>
<li><div class="src-line"><a name="a250"></a><span class="src-doc">&nbsp;*&nbsp;request&nbsp;on&nbsp;to&nbsp;the&nbsp;function&nbsp;required&nbsp;to&nbsp;process&nbsp;the&nbsp;request.</span></div></li>
<li><div class="src-line"><a name="a251"></a><span class="src-doc">&nbsp;*</span></div></li>
<li><div class="src-line"><a name="a252"></a><span class="src-doc">&nbsp;*&nbsp;The&nbsp;OpenID&nbsp;request&nbsp;expressed&nbsp;as&nbsp;an&nbsp;array&nbsp;contain&nbsp;key-value&nbsp;pairs&nbsp;corresponding</span></div></li>
<li><div class="src-line"><a name="a253"></a><span class="src-doc">&nbsp;*&nbsp;to&nbsp;the&nbsp;HTTP&nbsp;request.&nbsp;&nbsp;This&nbsp;is&nbsp;usually&nbsp;contained&nbsp;in&nbsp;the&nbsp;&lt;code&gt;$_REQUEST&lt;/code&gt;</span></div></li>
<li><div class="src-line"><a name="a254"></a><span class="src-doc">&nbsp;*&nbsp;variable.</span></div></li>
<li><div class="src-line"><a name="a255"></a><span class="src-doc">&nbsp;*</span></div></li>
<li><div class="src-line"><a name="a256"></a><span class="src-doc">&nbsp;*&nbsp;</span><span class="src-doc-coretag">@param&nbsp;</span><span class="src-doc-type">array&nbsp;</span><span class="src-doc-var">$request&nbsp;</span><span class="src-doc">the&nbsp;OpenID&nbsp;request</span></div></li>
<li><div class="src-line"><a name="a257"></a><span class="src-doc">&nbsp;*/</span></div></li>
<li><div class="src-line"><a name="a258"></a><span class="src-key">function&nbsp;</span><a href="../simpleid/_www---index.php.html#functionsimpleid_process_openid">simpleid_process_openid</a><span class="src-sym">(</span><span class="src-var">$request</span><span class="src-sym">)&nbsp;</span><span class="src-sym">{</span></div></li>
<li><div class="src-line"><a name="a259"></a>&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-key">global&nbsp;</span><a href="../simpleid/_www---index.php.html#global$version">$version</a><span class="src-sym">;</span></div></li>
<li><div class="src-line"><a name="a260"></a>&nbsp;&nbsp;&nbsp;&nbsp;</div></li>
<li><div class="src-line"><a name="a261"></a>&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-var">$version&nbsp;</span>=&nbsp;<a href="../simpleid/_www---openid.inc.php.html#functionopenid_get_version">openid_get_version</a><span class="src-sym">(</span><span class="src-var">$request</span><span class="src-sym">)</span><span class="src-sym">;</span></div></li>
<li><div class="src-line"><a name="a262"></a>&nbsp;&nbsp;&nbsp;&nbsp;</div></li>
<li><div class="src-line"><a name="a263"></a>&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-key">switch&nbsp;</span><span class="src-sym">(</span><span class="src-var">$request</span><span class="src-sym">[</span><span class="src-str">'openid.mode'</span><span class="src-sym">]</span><span class="src-sym">)&nbsp;</span><span class="src-sym">{</span></div></li>
<li><div class="src-line"><a name="a264"></a>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-key">case&nbsp;</span><span class="src-str">'associate'</span>:</div></li>
<li><div class="src-line"><a name="a265"></a>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a href="../simpleid/_www---index.php.html#functionsimpleid_associate">simpleid_associate</a><span class="src-sym">(</span><span class="src-var">$request</span><span class="src-sym">)</span><span class="src-sym">;</span></div></li>
<li><div class="src-line"><a name="a266"></a>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-key">return</span><span class="src-sym">;</span></div></li>
<li><div class="src-line"><a name="a267"></a>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-key">case&nbsp;</span><span class="src-str">'checkid_immediate'</span>:</div></li>
<li><div class="src-line"><a name="a268"></a>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-key">case&nbsp;</span><span class="src-str">'checkid_setup'</span>:</div></li>
<li><div class="src-line"><a name="a269"></a>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a href="../simpleid/_www---common.inc.php.html#functioncheck_https">check_https</a><span class="src-sym">(</span><span class="src-str">'redirect'</span><span class="src-sym">,&nbsp;</span><span class="src-id">true</span><span class="src-sym">,&nbsp;</span><a href="../simpleid/_www---common.inc.php.html#functionsimpleid_url">simpleid_url</a><span class="src-sym">(</span><span class="src-str">'continue'</span><span class="src-sym">,&nbsp;</span><span class="src-str">'s='&nbsp;</span>.&nbsp;<a href="http://www.php.net/rawurlencode">rawurlencode</a><span class="src-sym">(</span><a href="../simpleid/_www---common.inc.php.html#functionpickle">pickle</a><span class="src-sym">(</span><span class="src-var">$request</span><span class="src-sym">))</span><span class="src-sym">,&nbsp;</span><span class="src-id">false</span><span class="src-sym">,&nbsp;</span><span class="src-str">'https'</span><span class="src-sym">))</span><span class="src-sym">;</span></div></li>
<li><div class="src-line"><a name="a270"></a>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</div></li>
<li><div class="src-line"><a name="a271"></a>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-key">return&nbsp;</span><a href="../simpleid/_www---index.php.html#functionsimpleid_checkid">simpleid_checkid</a><span class="src-sym">(</span><span class="src-var">$request</span><span class="src-sym">)</span><span class="src-sym">;</span></div></li>
<li><div class="src-line"><a name="a272"></a>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-key">case&nbsp;</span><span class="src-str">'check_authentication'</span>:</div></li>
<li><div class="src-line"><a name="a273"></a>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a href="../simpleid/_www---index.php.html#functionsimpleid_check_authentication">simpleid_check_authentication</a><span class="src-sym">(</span><span class="src-var">$request</span><span class="src-sym">)</span><span class="src-sym">;</span></div></li>
<li><div class="src-line"><a name="a274"></a>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-key">break</span><span class="src-sym">;</span></div></li>
<li><div class="src-line"><a name="a275"></a>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-key">default</span>:</div></li>
<li><div class="src-line"><a name="a276"></a>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-key">if&nbsp;</span><span class="src-sym">(</span>isset<span class="src-sym">(</span><span class="src-var">$request</span><span class="src-sym">[</span><span class="src-str">'openid.return_to'</span><span class="src-sym">]</span><span class="src-sym">))&nbsp;</span><span class="src-sym">{</span></div></li>
<li><div class="src-line"><a name="a277"></a>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-comm">//&nbsp;Indirect&nbsp;communication&nbsp;-&nbsp;send&nbsp;error&nbsp;via&nbsp;indirect&nbsp;communication.</span></div></li>
<li><div class="src-line"><a name="a278"></a>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a href="../simpleid/_www---common.inc.php.html#functionheader_response_code">header_response_code</a><span class="src-sym">(</span><span class="src-str">'400&nbsp;Bad&nbsp;Request'</span><span class="src-sym">)</span><span class="src-sym">;</span></div></li>
<li><div class="src-line"><a name="a279"></a>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a href="../simpleid/_www---common.inc.php.html#functionset_message">set_message</a><span class="src-sym">(</span><a href="../simpleid/_www---locale.inc.php.html#functiont">t</a><span class="src-sym">(</span><span class="src-str">'Invalid&nbsp;OpenID&nbsp;message.'</span><span class="src-sym">))</span><span class="src-sym">;</span></div></li>
<li><div class="src-line"><a name="a280"></a>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a href="../simpleid/_www---page.inc.php.html#functionpage_dashboard">page_dashboard</a><span class="src-sym">(</span><span class="src-sym">)</span><span class="src-sym">;</span></div></li>
<li><div class="src-line"><a name="a281"></a>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-sym">}&nbsp;</span><span class="src-key">else&nbsp;</span><span class="src-sym">{</span></div></li>
<li><div class="src-line"><a name="a282"></a>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-comm">//&nbsp;Direct&nbsp;communication</span></div></li>
<li><div class="src-line"><a name="a283"></a>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a href="../simpleid/_www---openid.inc.php.html#functionopenid_direct_error">openid_direct_error</a><span class="src-sym">(</span><span class="src-str">'Invalid&nbsp;OpenID&nbsp;message.'</span><span class="src-sym">)</span><span class="src-sym">;</span></div></li>
<li><div class="src-line"><a name="a284"></a>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-sym">}</span></div></li>
<li><div class="src-line"><a name="a285"></a>&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-sym">}</span></div></li>
<li><div class="src-line"><a name="a286"></a><span class="src-sym">}</span></div></li>
<li><div class="src-line"><a name="a287"></a>&nbsp;</div></li>
<li><div class="src-line"><a name="a288"></a><span class="src-doc">/**</span></div></li>
<li><div class="src-line"><a name="a289"></a><span class="src-doc">&nbsp;*&nbsp;Processes&nbsp;an&nbsp;association&nbsp;request&nbsp;from&nbsp;a&nbsp;relying&nbsp;party.</span></div></li>
<li><div class="src-line"><a name="a290"></a><span class="src-doc">&nbsp;*</span></div></li>
<li><div class="src-line"><a name="a291"></a><span class="src-doc">&nbsp;*&nbsp;An&nbsp;association&nbsp;request&nbsp;has&nbsp;an&nbsp;openid.mode&nbsp;value&nbsp;of</span></div></li>
<li><div class="src-line"><a name="a292"></a><span class="src-doc">&nbsp;*&nbsp;associate.&nbsp;&nbsp;This&nbsp;function&nbsp;checks&nbsp;whether&nbsp;the&nbsp;association&nbsp;request</span></div></li>
<li><div class="src-line"><a name="a293"></a><span class="src-doc">&nbsp;*&nbsp;is&nbsp;valid,&nbsp;and&nbsp;if&nbsp;so,&nbsp;creates&nbsp;an&nbsp;association&nbsp;and&nbsp;sends&nbsp;the&nbsp;response&nbsp;to</span></div></li>
<li><div class="src-line"><a name="a294"></a><span class="src-doc">&nbsp;*&nbsp;the&nbsp;relying&nbsp;party.</span></div></li>
<li><div class="src-line"><a name="a295"></a><span class="src-doc">&nbsp;*</span></div></li>
<li><div class="src-line"><a name="a296"></a><span class="src-doc">&nbsp;*&nbsp;</span><span class="src-doc-coretag">@see</span><span class="src-doc">&nbsp;_simpleid_create_association()</span></div></li>
<li><div class="src-line"><a name="a297"></a><span class="src-doc">&nbsp;*&nbsp;</span><span class="src-doc-coretag">@param&nbsp;</span><span class="src-doc-type">array&nbsp;</span><span class="src-doc-var">$request&nbsp;</span><span class="src-doc">the&nbsp;OpenID&nbsp;request</span></div></li>
<li><div class="src-line"><a name="a298"></a><span class="src-doc">&nbsp;*&nbsp;</span><span class="src-doc-coretag">@link</span><span class="src-doc">&nbsp;http://openid.net/specs/openid-authentication-1_1.html#mode_associate,&nbsp;http://openid.net/specs/openid-authentication-2_0.html#associations</span></div></li>
<li><div class="src-line"><a name="a299"></a><span class="src-doc">&nbsp;*</span></div></li>
<li><div class="src-line"><a name="a300"></a><span class="src-doc">&nbsp;*/</span></div></li>
<li><div class="src-line"><a name="a301"></a><span class="src-key">function&nbsp;</span><a href="../simpleid/_www---index.php.html#functionsimpleid_associate">simpleid_associate</a><span class="src-sym">(</span><span class="src-var">$request</span><span class="src-sym">)&nbsp;</span><span class="src-sym">{</span></div></li>
<li><div class="src-line"><a name="a302"></a>&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-key">global&nbsp;</span><a href="../simpleid/_www---index.php.html#global$version">$version</a><span class="src-sym">;</span></div></li>
<li><div class="src-line"><a name="a303"></a>&nbsp;&nbsp;&nbsp;&nbsp;</div></li>
<li><div class="src-line"><a name="a304"></a>&nbsp;&nbsp;&nbsp;&nbsp;<a href="../simpleid/_www---log.inc.php.html#functionlog_info">log_info</a><span class="src-sym">(</span><span class="src-str">'OpenID&nbsp;association&nbsp;request:&nbsp;'&nbsp;</span>.&nbsp;<a href="../simpleid/_www---log.inc.php.html#functionlog_array">log_array</a><span class="src-sym">(</span><span class="src-var">$request</span><span class="src-sym">))</span><span class="src-sym">;</span></div></li>
<li><div class="src-line"><a name="a305"></a>&nbsp;&nbsp;&nbsp;&nbsp;</div></li>
<li><div class="src-line"><a name="a306"></a>&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-var">$assoc_types&nbsp;</span>=&nbsp;<a href="../simpleid/_www---openid.inc.php.html#functionopenid_association_types">openid_association_types</a><span class="src-sym">(</span><span class="src-sym">)</span><span class="src-sym">;</span></div></li>
<li><div class="src-line"><a name="a307"></a>&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-var">$session_types&nbsp;</span>=&nbsp;<a href="../simpleid/_www---openid.inc.php.html#functionopenid_session_types">openid_session_types</a><span class="src-sym">(</span><a href="../simpleid/_www---common.inc.php.html#functionis_https">is_https</a><span class="src-sym">(</span><span class="src-sym">)</span><span class="src-sym">,&nbsp;</span><span class="src-var">$version</span><span class="src-sym">)</span><span class="src-sym">;</span></div></li>
<li><div class="src-line"><a name="a308"></a>&nbsp;</div></li>
<li><div class="src-line"><a name="a309"></a>&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-comm">//&nbsp;Common&nbsp;Request&nbsp;Parameters&nbsp;[8.1.1]</span></div></li>
<li><div class="src-line"><a name="a310"></a>&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-key">if&nbsp;</span><span class="src-sym">((</span><span class="src-var">$version&nbsp;</span>==&nbsp;<span class="src-id"><a href="../simpleid/_www---openid.inc.php.html#defineOPENID_VERSION_1_1">OPENID_VERSION_1_1</a></span><span class="src-sym">)&nbsp;</span>&amp;&amp;&nbsp;<span class="src-sym">!</span>isset<span class="src-sym">(</span><span class="src-var">$request</span><span class="src-sym">[</span><span class="src-str">'openid.session_type'</span><span class="src-sym">]</span><span class="src-sym">))&nbsp;</span><span class="src-var">$request</span><span class="src-sym">[</span><span class="src-str">'openid.session_type'</span><span class="src-sym">]&nbsp;</span>=&nbsp;<span class="src-str">''</span><span class="src-sym">;</span></div></li>
<li><div class="src-line"><a name="a311"></a>&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-var">$assoc_type&nbsp;</span>=&nbsp;<span class="src-var">$request</span><span class="src-sym">[</span><span class="src-str">'openid.assoc_type'</span><span class="src-sym">]</span><span class="src-sym">;</span></div></li>
<li><div class="src-line"><a name="a312"></a>&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-var">$session_type&nbsp;</span>=&nbsp;<span class="src-var">$request</span><span class="src-sym">[</span><span class="src-str">'openid.session_type'</span><span class="src-sym">]</span><span class="src-sym">;</span></div></li>
<li><div class="src-line"><a name="a313"></a>&nbsp;&nbsp;&nbsp;&nbsp;</div></li>
<li><div class="src-line"><a name="a314"></a>&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-comm">//&nbsp;Diffie-Hellman&nbsp;Request&nbsp;Parameters&nbsp;[8.1.2]</span></div></li>
<li><div class="src-line"><a name="a315"></a>&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-var">$dh_modulus&nbsp;</span>=&nbsp;<span class="src-sym">(</span>isset<span class="src-sym">(</span><span class="src-var">$request</span><span class="src-sym">[</span><span class="src-str">'openid.dh_modulus'</span><span class="src-sym">]</span><span class="src-sym">))&nbsp;</span>?&nbsp;<span class="src-var">$request</span><span class="src-sym">[</span><span class="src-str">'openid.dh_modulus'</span><span class="src-sym">]&nbsp;</span>:&nbsp;<span class="src-id">NULL</span><span class="src-sym">;</span></div></li>
<li><div class="src-line"><a name="a316"></a>&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-var">$dh_gen&nbsp;</span>=&nbsp;<span class="src-sym">(</span>isset<span class="src-sym">(</span><span class="src-var">$request</span><span class="src-sym">[</span><span class="src-str">'openid.dh_gen'</span><span class="src-sym">]</span><span class="src-sym">))&nbsp;</span>?&nbsp;<span class="src-var">$request</span><span class="src-sym">[</span><span class="src-str">'openid.dh_gen'</span><span class="src-sym">]&nbsp;</span>:&nbsp;<span class="src-id">NULL</span><span class="src-sym">;</span></div></li>
<li><div class="src-line"><a name="a317"></a>&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-var">$dh_consumer_public&nbsp;</span>=&nbsp;<span class="src-var">$request</span><span class="src-sym">[</span><span class="src-str">'openid.dh_consumer_public'</span><span class="src-sym">]</span><span class="src-sym">;</span></div></li>
<li><div class="src-line"><a name="a318"></a>&nbsp;&nbsp;&nbsp;&nbsp;</div></li>
<li><div class="src-line"><a name="a319"></a>&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-key">if&nbsp;</span><span class="src-sym">(</span><span class="src-sym">!</span>isset<span class="src-sym">(</span><span class="src-var">$request</span><span class="src-sym">[</span><span class="src-str">'openid.session_type'</span><span class="src-sym">]</span><span class="src-sym">)&nbsp;</span>||&nbsp;<span class="src-sym">!</span>isset<span class="src-sym">(</span><span class="src-var">$request</span><span class="src-sym">[</span><span class="src-str">'openid.assoc_type'</span><span class="src-sym">]</span><span class="src-sym">))&nbsp;</span><span class="src-sym">{</span></div></li>
<li><div class="src-line"><a name="a320"></a>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a href="../simpleid/_www---log.inc.php.html#functionlog_error">log_error</a><span class="src-sym">(</span><span class="src-str">'Association&nbsp;failed:&nbsp;openid.session_type&nbsp;or&nbsp;openid.assoc_type&nbsp;not&nbsp;set'</span><span class="src-sym">)</span><span class="src-sym">;</span></div></li>
<li><div class="src-line"><a name="a321"></a>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a href="../simpleid/_www---openid.inc.php.html#functionopenid_direct_error">openid_direct_error</a><span class="src-sym">(</span><span class="src-str">'openid.session_type&nbsp;or&nbsp;openid.assoc_type&nbsp;not&nbsp;set'</span><span class="src-sym">)</span><span class="src-sym">;</span></div></li>
<li><div class="src-line"><a name="a322"></a>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-key">return</span><span class="src-sym">;</span></div></li>
<li><div class="src-line"><a name="a323"></a>&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-sym">}</span></div></li>
<li><div class="src-line"><a name="a324"></a>&nbsp;&nbsp;&nbsp;&nbsp;</div></li>
<li><div class="src-line"><a name="a325"></a>&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-comm">//&nbsp;Check&nbsp;if&nbsp;the&nbsp;assoc_type&nbsp;is&nbsp;supported</span></div></li>
<li><div class="src-line"><a name="a326"></a>&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-key">if&nbsp;</span><span class="src-sym">(</span><span class="src-sym">!</span><a href="http://www.php.net/array_key_exists">array_key_exists</a><span class="src-sym">(</span><span class="src-var">$assoc_type</span><span class="src-sym">,&nbsp;</span><span class="src-var">$assoc_types</span><span class="src-sym">))&nbsp;</span><span class="src-sym">{</span></div></li>
<li><div class="src-line"><a name="a327"></a>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-var">$error&nbsp;</span>=&nbsp;<span class="src-key">array</span><span class="src-sym">(</span></div></li>
<li><div class="src-line"><a name="a328"></a>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-str">'error_code'&nbsp;</span>=&gt;&nbsp;<span class="src-str">'unsupported-type'</span><span class="src-sym">,</span></div></li>
<li><div class="src-line"><a name="a329"></a>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-str">'session_type'&nbsp;</span>=&gt;&nbsp;<span class="src-str">'DH-SHA1'</span><span class="src-sym">,</span></div></li>
<li><div class="src-line"><a name="a330"></a>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-str">'assoc_type'&nbsp;</span>=&gt;&nbsp;<span class="src-str">'HMAC-SHA1'</span></div></li>
<li><div class="src-line"><a name="a331"></a>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-sym">)</span><span class="src-sym">;</span></div></li>
<li><div class="src-line"><a name="a332"></a>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a href="../simpleid/_www---log.inc.php.html#functionlog_error">log_error</a><span class="src-sym">(</span><span class="src-str">'Association&nbsp;failed:&nbsp;The&nbsp;association&nbsp;type&nbsp;is&nbsp;not&nbsp;supported&nbsp;by&nbsp;SimpleID.'</span><span class="src-sym">)</span><span class="src-sym">;</span></div></li>
<li><div class="src-line"><a name="a333"></a>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a href="../simpleid/_www---openid.inc.php.html#functionopenid_direct_error">openid_direct_error</a><span class="src-sym">(</span><span class="src-str">'The&nbsp;association&nbsp;type&nbsp;is&nbsp;not&nbsp;supported&nbsp;by&nbsp;SimpleID.'</span><span class="src-sym">,&nbsp;</span><span class="src-var">$error</span><span class="src-sym">,&nbsp;</span><span class="src-var">$version</span><span class="src-sym">)</span><span class="src-sym">;</span></div></li>
<li><div class="src-line"><a name="a334"></a>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-key">return</span><span class="src-sym">;</span></div></li>
<li><div class="src-line"><a name="a335"></a>&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-sym">}</span></div></li>
<li><div class="src-line"><a name="a336"></a>&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-comm">//&nbsp;Check&nbsp;if&nbsp;the&nbsp;session_type&nbsp;is&nbsp;supported</span></div></li>
<li><div class="src-line"><a name="a337"></a>&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-key">if&nbsp;</span><span class="src-sym">(</span><span class="src-sym">!</span><a href="http://www.php.net/array_key_exists">array_key_exists</a><span class="src-sym">(</span><span class="src-var">$session_type</span><span class="src-sym">,&nbsp;</span><span class="src-var">$session_types</span><span class="src-sym">))&nbsp;</span><span class="src-sym">{</span></div></li>
<li><div class="src-line"><a name="a338"></a>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-var">$error&nbsp;</span>=&nbsp;<span class="src-key">array</span><span class="src-sym">(</span></div></li>
<li><div class="src-line"><a name="a339"></a>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-str">'error_code'&nbsp;</span>=&gt;&nbsp;<span class="src-str">'unsupported-type'</span><span class="src-sym">,</span></div></li>
<li><div class="src-line"><a name="a340"></a>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-str">'session_type'&nbsp;</span>=&gt;&nbsp;<span class="src-str">'DH-SHA1'</span><span class="src-sym">,</span></div></li>
<li><div class="src-line"><a name="a341"></a>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-str">'assoc_type'&nbsp;</span>=&gt;&nbsp;<span class="src-str">'HMAC-SHA1'</span></div></li>
<li><div class="src-line"><a name="a342"></a>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-sym">)</span><span class="src-sym">;</span></div></li>
<li><div class="src-line"><a name="a343"></a>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a href="../simpleid/_www---log.inc.php.html#functionlog_error">log_error</a><span class="src-sym">(</span><span class="src-str">'Association&nbsp;failed:&nbsp;The&nbsp;session&nbsp;type&nbsp;is&nbsp;not&nbsp;supported&nbsp;by&nbsp;SimpleID.'</span><span class="src-sym">)</span><span class="src-sym">;</span></div></li>
<li><div class="src-line"><a name="a344"></a>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a href="../simpleid/_www---openid.inc.php.html#functionopenid_direct_error">openid_direct_error</a><span class="src-sym">(</span><span class="src-str">'The&nbsp;session&nbsp;type&nbsp;is&nbsp;not&nbsp;supported&nbsp;by&nbsp;SimpleID.'</span><span class="src-sym">,&nbsp;</span><span class="src-var">$error</span><span class="src-sym">,&nbsp;</span><span class="src-var">$version</span><span class="src-sym">)</span><span class="src-sym">;</span></div></li>
<li><div class="src-line"><a name="a345"></a>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-key">return</span><span class="src-sym">;</span></div></li>
<li><div class="src-line"><a name="a346"></a>&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-sym">}</span></div></li>
<li><div class="src-line"><a name="a347"></a>&nbsp;&nbsp;&nbsp;&nbsp;</div></li>
<li><div class="src-line"><a name="a348"></a>&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-key">if&nbsp;</span><span class="src-sym">(</span><span class="src-var">$session_type&nbsp;</span>==&nbsp;<span class="src-str">'DH-SHA1'&nbsp;</span>||&nbsp;<span class="src-var">$session_type&nbsp;</span>==&nbsp;<span class="src-str">'DH-SHA256'</span><span class="src-sym">)&nbsp;</span><span class="src-sym">{</span></div></li>
<li><div class="src-line"><a name="a349"></a>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-key">if&nbsp;</span><span class="src-sym">(</span><span class="src-sym">!</span><span class="src-var">$dh_consumer_public</span><span class="src-sym">)&nbsp;</span><span class="src-sym">{</span></div></li>
<li><div class="src-line"><a name="a350"></a>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a href="../simpleid/_www---log.inc.php.html#functionlog_error">log_error</a><span class="src-sym">(</span><span class="src-str">'Association&nbsp;failed:&nbsp;openid.dh_consumer_public&nbsp;not&nbsp;set'</span><span class="src-sym">)</span><span class="src-sym">;</span></div></li>
<li><div class="src-line"><a name="a351"></a>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a href="../simpleid/_www---openid.inc.php.html#functionopenid_direct_error">openid_direct_error</a><span class="src-sym">(</span><span class="src-str">'openid.dh_consumer_public&nbsp;not&nbsp;set'</span><span class="src-sym">)</span><span class="src-sym">;</span></div></li>
<li><div class="src-line"><a name="a352"></a>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-key">return</span><span class="src-sym">;</span></div></li>
<li><div class="src-line"><a name="a353"></a>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-sym">}</span></div></li>
<li><div class="src-line"><a name="a354"></a>&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-sym">}</span></div></li>
<li><div class="src-line"><a name="a355"></a>&nbsp;</div></li>
<li><div class="src-line"><a name="a356"></a>&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-var">$response&nbsp;</span>=&nbsp;<a href="../simpleid/_www---index.php.html#function_simpleid_create_association">_simpleid_create_association</a><span class="src-sym">(</span><span class="src-id"><a href="../simpleid/_www---index.php.html#defineASSOCIATION_SHARED">ASSOCIATION_SHARED</a></span><span class="src-sym">,&nbsp;</span><span class="src-var">$assoc_type</span><span class="src-sym">,&nbsp;</span><span class="src-var">$session_type</span><span class="src-sym">,&nbsp;</span><span class="src-var">$dh_modulus</span><span class="src-sym">,&nbsp;</span><span class="src-var">$dh_gen</span><span class="src-sym">,&nbsp;</span><span class="src-var">$dh_consumer_public</span><span class="src-sym">)</span><span class="src-sym">;</span></div></li>
<li><div class="src-line"><a name="a357"></a>&nbsp;&nbsp;&nbsp;&nbsp;</div></li>
<li><div class="src-line"><a name="a358"></a>&nbsp;&nbsp;&nbsp;&nbsp;<a href="../simpleid/_www---openid.inc.php.html#functionopenid_direct_response">openid_direct_response</a><span class="src-sym">(</span><a href="../simpleid/_www---openid.inc.php.html#functionopenid_direct_message">openid_direct_message</a><span class="src-sym">(</span><span class="src-var">$response</span><span class="src-sym">,&nbsp;</span><span class="src-var">$version</span><span class="src-sym">))</span><span class="src-sym">;</span></div></li>
<li><div class="src-line"><a name="a359"></a><span class="src-sym">}</span></div></li>
<li><div class="src-line"><a name="a360"></a>&nbsp;</div></li>
<li><div class="src-line"><a name="a361"></a>&nbsp;</div></li>
<li><div class="src-line"><a name="a362"></a><span class="src-doc">/**</span></div></li>
<li><div class="src-line"><a name="a363"></a><span class="src-doc">&nbsp;*&nbsp;Creates&nbsp;an&nbsp;association.</span></div></li>
<li><div class="src-line"><a name="a364"></a><span class="src-doc">&nbsp;*</span></div></li>
<li><div class="src-line"><a name="a365"></a><span class="src-doc">&nbsp;*&nbsp;This&nbsp;function&nbsp;calls&nbsp;</span><span class="src-doc-inlinetag">{@link&nbsp;openid_dh_server_assoc()}</span><span class="src-doc">&nbsp;where&nbsp;required,&nbsp;to</span></div></li>
<li><div class="src-line"><a name="a366"></a><span class="src-doc">&nbsp;*&nbsp;generate&nbsp;the&nbsp;cryptographic&nbsp;values&nbsp;required&nbsp;for&nbsp;an&nbsp;association&nbsp;response.</span></div></li>
<li><div class="src-line"><a name="a367"></a><span class="src-doc">&nbsp;*</span></div></li>
<li><div class="src-line"><a name="a368"></a><span class="src-doc">&nbsp;*&nbsp;</span><span class="src-doc-coretag">@param&nbsp;</span><span class="src-doc-type">int&nbsp;</span><span class="src-doc-var">$mode&nbsp;</span><span class="src-doc">either&nbsp;ASSOCIATION_SHARED&nbsp;or&nbsp;ASSOCIATION_PRIVATE</span></div></li>
<li><div class="src-line"><a name="a369"></a><span class="src-doc">&nbsp;*&nbsp;</span><span class="src-doc-coretag">@param&nbsp;</span><span class="src-doc-type">string&nbsp;</span><span class="src-doc-var">$assoc_type&nbsp;</span><span class="src-doc">a&nbsp;valid&nbsp;OpenID&nbsp;association&nbsp;type</span></div></li>
<li><div class="src-line"><a name="a370"></a><span class="src-doc">&nbsp;*&nbsp;</span><span class="src-doc-coretag">@param&nbsp;</span><span class="src-doc-type">string&nbsp;</span><span class="src-doc-var">$session_type&nbsp;</span><span class="src-doc">a&nbsp;valid&nbsp;OpenID&nbsp;session&nbsp;type</span></div></li>
<li><div class="src-line"><a name="a371"></a><span class="src-doc">&nbsp;*&nbsp;</span><span class="src-doc-coretag">@param&nbsp;</span><span class="src-doc-type">string&nbsp;</span><span class="src-doc-var">$dh_modulus&nbsp;</span><span class="src-doc">for&nbsp;Diffie-Hellman&nbsp;key&nbsp;exchange,&nbsp;the&nbsp;modulus&nbsp;encoded&nbsp;in&nbsp;Base64</span></div></li>
<li><div class="src-line"><a name="a372"></a><span class="src-doc">&nbsp;*&nbsp;</span><span class="src-doc-coretag">@param&nbsp;</span><span class="src-doc-type">string&nbsp;</span><span class="src-doc-var">$dh_gen&nbsp;</span><span class="src-doc">for&nbsp;Diffie-Hellman&nbsp;key&nbsp;exchange,&nbsp;g&nbsp;encoded&nbsp;in&nbsp;Base64</span></div></li>
<li><div class="src-line"><a name="a373"></a><span class="src-doc">&nbsp;*&nbsp;</span><span class="src-doc-coretag">@param&nbsp;</span><span class="src-doc-type">string&nbsp;</span><span class="src-doc-var">$dh_consumer_public&nbsp;</span><span class="src-doc">for&nbsp;Diffie-Hellman&nbsp;key&nbsp;exchange,&nbsp;the&nbsp;public&nbsp;key&nbsp;of&nbsp;the&nbsp;relying&nbsp;party&nbsp;encoded&nbsp;in&nbsp;Base64</span></div></li>
<li><div class="src-line"><a name="a374"></a><span class="src-doc">&nbsp;*&nbsp;</span><span class="src-doc-coretag">@return&nbsp;</span><span class="src-doc-type">mixed&nbsp;</span><span class="src-doc">if&nbsp;$mode&nbsp;is&nbsp;ASSOCIATION_SHARED,&nbsp;an&nbsp;OpenID&nbsp;response</span></div></li>
<li><div class="src-line"><a name="a375"></a><span class="src-doc">&nbsp;*&nbsp;&nbsp;to&nbsp;the&nbsp;association&nbsp;request,&nbsp;if&nbsp;$mode&nbsp;is&nbsp;ASSOCIATION_PRIVATE,&nbsp;the</span></div></li>
<li><div class="src-line"><a name="a376"></a><span class="src-doc">&nbsp;*&nbsp;&nbsp;association&nbsp;data&nbsp;for&nbsp;storage.</span></div></li>
<li><div class="src-line"><a name="a377"></a><span class="src-doc">&nbsp;*&nbsp;</span><span class="src-doc-coretag">@link</span><span class="src-doc">&nbsp;http://openid.net/specs/openid-authentication-1_1.html#anchor14,&nbsp;http://openid.net/specs/openid-authentication-2_0.html#anchor20</span></div></li>
<li><div class="src-line"><a name="a378"></a><span class="src-doc">&nbsp;*/</span></div></li>
<li><div class="src-line"><a name="a379"></a><span class="src-key">function&nbsp;</span><a href="../simpleid/_www---index.php.html#function_simpleid_create_association">_simpleid_create_association</a><span class="src-sym">(</span><span class="src-var">$mode&nbsp;</span>=&nbsp;<span class="src-id">ASSOCIATION_SHARED</span><span class="src-sym">,&nbsp;</span><span class="src-var">$assoc_type&nbsp;</span>=&nbsp;<span class="src-str">'HMAC-SHA1'</span><span class="src-sym">,&nbsp;</span><span class="src-var">$session_type&nbsp;</span>=&nbsp;<span class="src-str">'no-encryption'</span><span class="src-sym">,&nbsp;</span><span class="src-var">$dh_modulus&nbsp;</span>=&nbsp;<span class="src-id">NULL</span><span class="src-sym">,&nbsp;</span><span class="src-var">$dh_gen&nbsp;</span>=&nbsp;<span class="src-id">NULL</span><span class="src-sym">,&nbsp;</span><span class="src-var">$dh_consumer_public&nbsp;</span>=&nbsp;<span class="src-id">NULL</span><span class="src-sym">)&nbsp;</span><span class="src-sym">{</span></div></li>
<li><div class="src-line"><a name="a380"></a>&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-key">global&nbsp;</span><a href="../simpleid/_www---index.php.html#global$version">$version</a><span class="src-sym">;</span></div></li>
<li><div class="src-line"><a name="a381"></a>&nbsp;&nbsp;&nbsp;&nbsp;</div></li>
<li><div class="src-line"><a name="a382"></a>&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-var">$assoc_types&nbsp;</span>=&nbsp;<a href="../simpleid/_www---openid.inc.php.html#functionopenid_association_types">openid_association_types</a><span class="src-sym">(</span><span class="src-sym">)</span><span class="src-sym">;</span></div></li>
<li><div class="src-line"><a name="a383"></a>&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-var">$session_types&nbsp;</span>=&nbsp;<a href="../simpleid/_www---openid.inc.php.html#functionopenid_session_types">openid_session_types</a><span class="src-sym">(</span><a href="../simpleid/_www---common.inc.php.html#functionis_https">is_https</a><span class="src-sym">(</span><span class="src-sym">)</span><span class="src-sym">,&nbsp;</span><span class="src-var">$version</span><span class="src-sym">)</span><span class="src-sym">;</span></div></li>
<li><div class="src-line"><a name="a384"></a>&nbsp;&nbsp;&nbsp;&nbsp;</div></li>
<li><div class="src-line"><a name="a385"></a>&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-var">$mac_size&nbsp;</span>=&nbsp;<span class="src-var">$assoc_types</span><span class="src-sym">[</span><span class="src-var">$assoc_type</span><span class="src-sym">]</span><span class="src-sym">[</span><span class="src-str">'mac_size'</span><span class="src-sym">]</span><span class="src-sym">;</span></div></li>
<li><div class="src-line"><a name="a386"></a>&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-var">$hmac_func&nbsp;</span>=&nbsp;<span class="src-var">$assoc_types</span><span class="src-sym">[</span><span class="src-var">$assoc_type</span><span class="src-sym">]</span><span class="src-sym">[</span><span class="src-str">'hmac_func'</span><span class="src-sym">]</span><span class="src-sym">;</span></div></li>
<li><div class="src-line"><a name="a387"></a>&nbsp;&nbsp;&nbsp;&nbsp;</div></li>
<li><div class="src-line"><a name="a388"></a>&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-var">$assoc_handle&nbsp;</span>=&nbsp;<a href="../simpleid/_www---random.inc.php.html#functionrandom_id">random_id</a><span class="src-sym">(</span><span class="src-sym">)</span><span class="src-sym">;</span></div></li>
<li><div class="src-line"><a name="a389"></a>&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-var">$expires_in&nbsp;</span>=&nbsp;<span class="src-id"><a href="../simpleid/_www---config.php.dist.html#defineSIMPLEID_ASSOC_EXPIRES_IN">SIMPLEID_ASSOC_EXPIRES_IN</a></span><span class="src-sym">;</span></div></li>
<li><div class="src-line"><a name="a390"></a>&nbsp;&nbsp;&nbsp;&nbsp;</div></li>
<li><div class="src-line"><a name="a391"></a>&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-var">$secret&nbsp;</span>=&nbsp;<a href="../simpleid/_www---random.inc.php.html#functionrandom_bytes">random_bytes</a><span class="src-sym">(</span><span class="src-var">$mac_size</span><span class="src-sym">)</span><span class="src-sym">;</span></div></li>
<li><div class="src-line"><a name="a392"></a>&nbsp;&nbsp;&nbsp;&nbsp;</div></li>
<li><div class="src-line"><a name="a393"></a>&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-var">$response&nbsp;</span>=&nbsp;<span class="src-key">array</span><span class="src-sym">(</span></div></li>
<li><div class="src-line"><a name="a394"></a>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-str">'assoc_handle'&nbsp;</span>=&gt;&nbsp;<span class="src-var">$assoc_handle</span><span class="src-sym">,</span></div></li>
<li><div class="src-line"><a name="a395"></a>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-str">'assoc_type'&nbsp;</span>=&gt;&nbsp;<span class="src-var">$assoc_type</span><span class="src-sym">,</span></div></li>
<li><div class="src-line"><a name="a396"></a>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-str">'expires_in'&nbsp;</span>=&gt;&nbsp;<span class="src-var">$expires_in</span></div></li>
<li><div class="src-line"><a name="a397"></a>&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-sym">)</span><span class="src-sym">;</span></div></li>
<li><div class="src-line"><a name="a398"></a>&nbsp;&nbsp;&nbsp;&nbsp;</div></li>
<li><div class="src-line"><a name="a399"></a>&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-comm">//&nbsp;If&nbsp;$session_type&nbsp;is&nbsp;'',&nbsp;then&nbsp;it&nbsp;must&nbsp;be&nbsp;using&nbsp;OpenID&nbsp;1.1&nbsp;(blank&nbsp;parameter</span></div></li>
<li><div class="src-line"><a name="a400"></a>&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-comm">//&nbsp;is&nbsp;not&nbsp;allowed&nbsp;for&nbsp;OpenID&nbsp;2.0.&nbsp;&nbsp;For&nbsp;OpenID&nbsp;1.1&nbsp;blank&nbsp;requests,&nbsp;we&nbsp;don't</span></div></li>
<li><div class="src-line"><a name="a401"></a>&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-comm">//&nbsp;put&nbsp;a&nbsp;session_type&nbsp;in&nbsp;the&nbsp;response.</span></div></li>
<li><div class="src-line"><a name="a402"></a>&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-key">if&nbsp;</span><span class="src-sym">(</span><span class="src-var">$session_type&nbsp;</span>!=&nbsp;<span class="src-str">''</span><span class="src-sym">)&nbsp;</span><span class="src-var">$response</span><span class="src-sym">[</span><span class="src-str">'session_type'</span><span class="src-sym">]&nbsp;</span>=&nbsp;<span class="src-var">$session_type</span><span class="src-sym">;</span></div></li>
<li><div class="src-line"><a name="a403"></a>&nbsp;&nbsp;&nbsp;&nbsp;</div></li>
<li><div class="src-line"><a name="a404"></a>&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-key">if&nbsp;</span><span class="src-sym">((</span><span class="src-var">$session_type&nbsp;</span>==&nbsp;<span class="src-str">'no-encryption'</span><span class="src-sym">)&nbsp;</span>||&nbsp;<span class="src-sym">(</span><span class="src-var">$session_type&nbsp;</span>==&nbsp;<span class="src-str">''</span><span class="src-sym">))&nbsp;</span><span class="src-sym">{</span></div></li>
<li><div class="src-line"><a name="a405"></a>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-var">$mac_key&nbsp;</span>=&nbsp;<a href="http://www.php.net/base64_encode">base64_encode</a><span class="src-sym">(</span><a href="http://www.php.net/call_user_func">call_user_func</a><span class="src-sym">(</span><span class="src-var">$hmac_func</span><span class="src-sym">,&nbsp;</span><span class="src-var">$secret</span><span class="src-sym">,&nbsp;</span><span class="src-var">$response</span><span class="src-sym">[</span><span class="src-str">'assoc_handle'</span><span class="src-sym">]</span><span class="src-sym">))</span><span class="src-sym">;</span></div></li>
<li><div class="src-line"><a name="a406"></a>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-var">$response</span><span class="src-sym">[</span><span class="src-str">'mac_key'</span><span class="src-sym">]&nbsp;</span>=&nbsp;<span class="src-var">$mac_key</span><span class="src-sym">;</span></div></li>
<li><div class="src-line"><a name="a407"></a>&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-sym">}&nbsp;</span><span class="src-key">elseif&nbsp;</span><span class="src-sym">(</span><span class="src-var">$session_type&nbsp;</span>==&nbsp;<span class="src-str">'DH-SHA1'&nbsp;</span>||&nbsp;<span class="src-var">$session_type&nbsp;</span>==&nbsp;<span class="src-str">'DH-SHA256'</span><span class="src-sym">)&nbsp;</span><span class="src-sym">{</span></div></li>
<li><div class="src-line"><a name="a408"></a>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-var">$hash_func&nbsp;</span>=&nbsp;<span class="src-var">$session_types</span><span class="src-sym">[</span><span class="src-var">$session_type</span><span class="src-sym">]</span><span class="src-sym">[</span><span class="src-str">'hash_func'</span><span class="src-sym">]</span><span class="src-sym">;</span></div></li>
<li><div class="src-line"><a name="a409"></a>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</div></li>
<li><div class="src-line"><a name="a410"></a>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-var">$dh_assoc&nbsp;</span>=&nbsp;<a href="../simpleid/_www---openid.inc.php.html#functionopenid_dh_server_assoc">openid_dh_server_assoc</a><span class="src-sym">(</span><span class="src-var">$secret</span><span class="src-sym">,&nbsp;</span><span class="src-var">$dh_consumer_public</span><span class="src-sym">,&nbsp;</span><span class="src-var">$dh_modulus</span><span class="src-sym">,&nbsp;</span><span class="src-var">$dh_gen</span><span class="src-sym">,&nbsp;</span><span class="src-var">$hash_func</span><span class="src-sym">)</span><span class="src-sym">;</span></div></li>
<li><div class="src-line"><a name="a411"></a>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-var">$mac_key&nbsp;</span>=&nbsp;<a href="http://www.php.net/base64_encode">base64_encode</a><span class="src-sym">(</span><span class="src-var">$secret</span><span class="src-sym">)</span><span class="src-sym">;</span></div></li>
<li><div class="src-line"><a name="a412"></a>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-var">$response</span><span class="src-sym">[</span><span class="src-str">'dh_server_public'</span><span class="src-sym">]&nbsp;</span>=&nbsp;<span class="src-var">$dh_assoc</span><span class="src-sym">[</span><span class="src-str">'dh_server_public'</span><span class="src-sym">]</span><span class="src-sym">;</span></div></li>
<li><div class="src-line"><a name="a413"></a>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-var">$response</span><span class="src-sym">[</span><span class="src-str">'enc_mac_key'</span><span class="src-sym">]&nbsp;</span>=&nbsp;<span class="src-var">$dh_assoc</span><span class="src-sym">[</span><span class="src-str">'enc_mac_key'</span><span class="src-sym">]</span><span class="src-sym">;</span></div></li>
<li><div class="src-line"><a name="a414"></a>&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-sym">}</span></div></li>
<li><div class="src-line"><a name="a415"></a>&nbsp;</div></li>
<li><div class="src-line"><a name="a416"></a>&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-var">$association&nbsp;</span>=&nbsp;<span class="src-key">array</span><span class="src-sym">(</span><span class="src-str">'assoc_handle'&nbsp;</span>=&gt;&nbsp;<span class="src-var">$assoc_handle</span><span class="src-sym">,&nbsp;</span><span class="src-str">'assoc_type'&nbsp;</span>=&gt;&nbsp;<span class="src-var">$assoc_type</span><span class="src-sym">,&nbsp;</span><span class="src-str">'mac_key'&nbsp;</span>=&gt;&nbsp;<span class="src-var">$mac_key</span><span class="src-sym">,&nbsp;</span><span class="src-str">'created'&nbsp;</span>=&gt;&nbsp;<a href="http://www.php.net/time">time</a><span class="src-sym">(</span><span class="src-sym">))</span><span class="src-sym">;</span></div></li>
<li><div class="src-line"><a name="a417"></a>&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-key">if&nbsp;</span><span class="src-sym">(</span><span class="src-var">$mode&nbsp;</span>==&nbsp;<span class="src-id"><a href="../simpleid/_www---index.php.html#defineASSOCIATION_PRIVATE">ASSOCIATION_PRIVATE</a></span><span class="src-sym">)&nbsp;</span><span class="src-var">$association</span><span class="src-sym">[</span><span class="src-str">'private'</span><span class="src-sym">]&nbsp;</span>=&nbsp;<span class="src-num">1</span><span class="src-sym">;</span></div></li>
<li><div class="src-line"><a name="a418"></a>&nbsp;&nbsp;&nbsp;&nbsp;<a href="../simpleid/_www---cache.inc.php.html#functioncache_set">cache_set</a><span class="src-sym">(</span><span class="src-str">'association'</span><span class="src-sym">,&nbsp;</span><span class="src-var">$assoc_handle</span><span class="src-sym">,&nbsp;</span><span class="src-var">$association</span><span class="src-sym">)</span><span class="src-sym">;</span></div></li>
<li><div class="src-line"><a name="a419"></a>&nbsp;</div></li>
<li><div class="src-line"><a name="a420"></a>&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-key">if&nbsp;</span><span class="src-sym">(</span><span class="src-var">$mode&nbsp;</span>==&nbsp;<span class="src-id"><a href="../simpleid/_www---index.php.html#defineASSOCIATION_SHARED">ASSOCIATION_SHARED</a></span><span class="src-sym">)&nbsp;</span><span class="src-sym">{</span></div></li>
<li><div class="src-line"><a name="a421"></a>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a href="../simpleid/_www---log.inc.php.html#functionlog_info">log_info</a><span class="src-sym">(</span><span class="src-str">'Created&nbsp;association:&nbsp;'&nbsp;</span>.&nbsp;<a href="../simpleid/_www---log.inc.php.html#functionlog_array">log_array</a><span class="src-sym">(</span><span class="src-var">$response</span><span class="src-sym">))</span><span class="src-sym">;</span></div></li>
<li><div class="src-line"><a name="a422"></a>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a href="../simpleid/_www---log.inc.php.html#functionlog_debug">log_debug</a><span class="src-sym">(</span><span class="src-str">'*****&nbsp;MAC&nbsp;key:&nbsp;'&nbsp;</span>.&nbsp;<span class="src-var">$association</span><span class="src-sym">[</span><span class="src-str">'mac_key'</span><span class="src-sym">]</span><span class="src-sym">)</span><span class="src-sym">;</span></div></li>
<li><div class="src-line"><a name="a423"></a>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-key">return&nbsp;</span><span class="src-var">$response</span><span class="src-sym">;</span></div></li>
<li><div class="src-line"><a name="a424"></a>&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-sym">}&nbsp;</span><span class="src-key">else&nbsp;</span><span class="src-sym">{</span></div></li>
<li><div class="src-line"><a name="a425"></a>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a href="../simpleid/_www---log.inc.php.html#functionlog_info">log_info</a><span class="src-sym">(</span><span class="src-str">'Created&nbsp;association:&nbsp;private;&nbsp;'&nbsp;</span>.&nbsp;<a href="../simpleid/_www---log.inc.php.html#functionlog_array">log_array</a><span class="src-sym">(</span><span class="src-var">$association</span><span class="src-sym">,&nbsp;</span><span class="src-key">array</span><span class="src-sym">(</span><span class="src-str">'assoc_handle'</span><span class="src-sym">,&nbsp;</span><span class="src-str">'assoc_type'</span><span class="src-sym">)))</span><span class="src-sym">;</span></div></li>
<li><div class="src-line"><a name="a426"></a>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a href="../simpleid/_www---log.inc.php.html#functionlog_debug">log_debug</a><span class="src-sym">(</span><span class="src-str">'*****&nbsp;MAC&nbsp;key:&nbsp;'&nbsp;</span>.&nbsp;<span class="src-var">$association</span><span class="src-sym">[</span><span class="src-str">'mac_key'</span><span class="src-sym">]</span><span class="src-sym">)</span><span class="src-sym">;</span></div></li>
<li><div class="src-line"><a name="a427"></a>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-key">return&nbsp;</span><span class="src-var">$association</span><span class="src-sym">;</span></div></li>
<li><div class="src-line"><a name="a428"></a>&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-sym">}</span></div></li>
<li><div class="src-line"><a name="a429"></a><span class="src-sym">}</span></div></li>
<li><div class="src-line"><a name="a430"></a>&nbsp;</div></li>
<li><div class="src-line"><a name="a431"></a>&nbsp;</div></li>
<li><div class="src-line"><a name="a432"></a><span class="src-doc">/**</span></div></li>
<li><div class="src-line"><a name="a433"></a><span class="src-doc">&nbsp;*&nbsp;Processes&nbsp;an&nbsp;authentication&nbsp;request&nbsp;from&nbsp;a&nbsp;relying&nbsp;party.</span></div></li>
<li><div class="src-line"><a name="a434"></a><span class="src-doc">&nbsp;*</span></div></li>
<li><div class="src-line"><a name="a435"></a><span class="src-doc">&nbsp;*&nbsp;An&nbsp;authentication&nbsp;request&nbsp;has&nbsp;an&nbsp;openid.mode&nbsp;value&nbsp;of</span></div></li>
<li><div class="src-line"><a name="a436"></a><span class="src-doc">&nbsp;*&nbsp;checkid_setup&nbsp;or&nbsp;checkid_immediate.</span></div></li>
<li><div class="src-line"><a name="a437"></a><span class="src-doc">&nbsp;*</span></div></li>
<li><div class="src-line"><a name="a438"></a><span class="src-doc">&nbsp;*&nbsp;If&nbsp;the&nbsp;authentication&nbsp;request&nbsp;is&nbsp;a&nbsp;standard&nbsp;OpenID&nbsp;request&nbsp;about&nbsp;an&nbsp;identity</span></div></li>
<li><div class="src-line"><a name="a439"></a><span class="src-doc">&nbsp;*&nbsp;(i.e.&nbsp;contains&nbsp;the&nbsp;key&nbsp;openid.identity),&nbsp;this&nbsp;function&nbsp;calls</span></div></li>
<li><div class="src-line"><a name="a440"></a><span class="src-doc">&nbsp;*&nbsp;</span><span class="src-doc-inlinetag">{@link&nbsp;simpleid_checkid_identity()}</span><span class="src-doc">&nbsp;to&nbsp;see&nbsp;whether&nbsp;the&nbsp;user&nbsp;logged&nbsp;on&nbsp;into&nbsp;SimpleID</span></div></li>
<li><div class="src-line"><a name="a441"></a><span class="src-doc">&nbsp;*&nbsp;matches&nbsp;the&nbsp;identity&nbsp;supplied&nbsp;in&nbsp;the&nbsp;OpenID&nbsp;request.</span></div></li>
<li><div class="src-line"><a name="a442"></a><span class="src-doc">&nbsp;*</span></div></li>
<li><div class="src-line"><a name="a443"></a><span class="src-doc">&nbsp;*&nbsp;If&nbsp;the&nbsp;authentication&nbsp;request&nbsp;is&nbsp;not&nbsp;about&nbsp;an&nbsp;identity,&nbsp;this&nbsp;function&nbsp;calls</span></div></li>
<li><div class="src-line"><a name="a444"></a><span class="src-doc">&nbsp;*&nbsp;the&nbsp;</span><span class="src-doc-inlinetag">{@link&nbsp;hook_checkid()&nbsp;checkid&nbsp;hook}</span><span class="src-doc">&nbsp;of&nbsp;the&nbsp;loaded&nbsp;extensions.</span></div></li>
<li><div class="src-line"><a name="a445"></a><span class="src-doc">&nbsp;*</span></div></li>
<li><div class="src-line"><a name="a446"></a><span class="src-doc">&nbsp;*&nbsp;Depending&nbsp;on&nbsp;the&nbsp;OpenID&nbsp;version,&nbsp;this&nbsp;function&nbsp;will&nbsp;supply&nbsp;an&nbsp;appropriate</span></div></li>
<li><div class="src-line"><a name="a447"></a><span class="src-doc">&nbsp;*&nbsp;assertion.</span></div></li>
<li><div class="src-line"><a name="a448"></a><span class="src-doc">&nbsp;*</span></div></li>
<li><div class="src-line"><a name="a449"></a><span class="src-doc">&nbsp;*&nbsp;</span><span class="src-doc-coretag">@param&nbsp;</span><span class="src-doc-type">array&nbsp;</span><span class="src-doc-var">$request&nbsp;</span><span class="src-doc">the&nbsp;OpenID&nbsp;request</span></div></li>
<li><div class="src-line"><a name="a450"></a><span class="src-doc">&nbsp;*</span></div></li>
<li><div class="src-line"><a name="a451"></a><span class="src-doc">&nbsp;*/</span></div></li>
<li><div class="src-line"><a name="a452"></a><span class="src-key">function&nbsp;</span><a href="../simpleid/_www---index.php.html#functionsimpleid_checkid">simpleid_checkid</a><span class="src-sym">(</span><span class="src-var">$request</span><span class="src-sym">)&nbsp;</span><span class="src-sym">{</span></div></li>
<li><div class="src-line"><a name="a453"></a>&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-key">global&nbsp;</span><a href="../simpleid/_www---index.php.html#global$version">$version</a><span class="src-sym">;</span></div></li>
<li><div class="src-line"><a name="a454"></a>&nbsp;&nbsp;&nbsp;&nbsp;</div></li>
<li><div class="src-line"><a name="a455"></a>&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-var">$immediate&nbsp;</span>=&nbsp;<span class="src-sym">(</span><span class="src-var">$request</span><span class="src-sym">[</span><span class="src-str">'openid.mode'</span><span class="src-sym">]&nbsp;</span>==&nbsp;<span class="src-str">'checkid_immediate'</span><span class="src-sym">)</span><span class="src-sym">;</span></div></li>
<li><div class="src-line"><a name="a456"></a>&nbsp;&nbsp;&nbsp;&nbsp;</div></li>
<li><div class="src-line"><a name="a457"></a>&nbsp;&nbsp;&nbsp;&nbsp;<a href="../simpleid/_www---log.inc.php.html#functionlog_info">log_info</a><span class="src-sym">(</span><span class="src-str">'OpenID&nbsp;authentication&nbsp;request:&nbsp;'&nbsp;</span>.&nbsp;<span class="src-sym">((</span><span class="src-var">$immediate</span><span class="src-sym">)&nbsp;</span>?&nbsp;<span class="src-str">'immediate'&nbsp;</span>:&nbsp;<span class="src-str">'setup'</span><span class="src-sym">)&nbsp;</span>.&nbsp;<span class="src-str">';&nbsp;'</span>.&nbsp;<a href="../simpleid/_www---log.inc.php.html#functionlog_array">log_array</a><span class="src-sym">(</span><span class="src-var">$request</span><span class="src-sym">))</span><span class="src-sym">;</span></div></li>
<li><div class="src-line"><a name="a458"></a>&nbsp;</div></li>
<li><div class="src-line"><a name="a459"></a>&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-comm">//&nbsp;Check&nbsp;for&nbsp;protocol&nbsp;correctness&nbsp;&nbsp;&nbsp;&nbsp;</span></div></li>
<li><div class="src-line"><a name="a460"></a>&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-key">if&nbsp;</span><span class="src-sym">(</span><span class="src-var">$version&nbsp;</span>==&nbsp;<span class="src-id"><a href="../simpleid/_www---openid.inc.php.html#defineOPENID_VERSION_1_1">OPENID_VERSION_1_1</a></span><span class="src-sym">)&nbsp;</span><span class="src-sym">{</span></div></li>
<li><div class="src-line"><a name="a461"></a>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-key">if&nbsp;</span><span class="src-sym">(</span><span class="src-sym">!</span>isset<span class="src-sym">(</span><span class="src-var">$request</span><span class="src-sym">[</span><span class="src-str">'openid.return_to'</span><span class="src-sym">]</span><span class="src-sym">))&nbsp;</span><span class="src-sym">{</span></div></li>
<li><div class="src-line"><a name="a462"></a>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a href="../simpleid/_www---log.inc.php.html#functionlog_error">log_error</a><span class="src-sym">(</span><span class="src-str">'Protocol&nbsp;Error:&nbsp;openid.return_to&nbsp;not&nbsp;set.'</span><span class="src-sym">)</span><span class="src-sym">;</span></div></li>
<li><div class="src-line"><a name="a463"></a>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a href="../simpleid/_www---common.inc.php.html#functionindirect_fatal_error">indirect_fatal_error</a><span class="src-sym">(</span><a href="../simpleid/_www---locale.inc.php.html#functiont">t</a><span class="src-sym">(</span><span class="src-str">'Protocol&nbsp;Error:&nbsp;openid.return_to&nbsp;not&nbsp;set.'</span><span class="src-sym">))</span><span class="src-sym">;</span></div></li>
<li><div class="src-line"><a name="a464"></a>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-key">return</span><span class="src-sym">;</span></div></li>
<li><div class="src-line"><a name="a465"></a>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-sym">}</span></div></li>
<li><div class="src-line"><a name="a466"></a>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-key">if&nbsp;</span><span class="src-sym">(</span><span class="src-sym">!</span>isset<span class="src-sym">(</span><span class="src-var">$request</span><span class="src-sym">[</span><span class="src-str">'openid.identity'</span><span class="src-sym">]</span><span class="src-sym">))&nbsp;</span><span class="src-sym">{</span></div></li>
<li><div class="src-line"><a name="a467"></a>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a href="../simpleid/_www---log.inc.php.html#functionlog_error">log_error</a><span class="src-sym">(</span><span class="src-str">'Protocol&nbsp;Error:&nbsp;openid.identity&nbsp;not&nbsp;set.'</span><span class="src-sym">)</span><span class="src-sym">;</span></div></li>
<li><div class="src-line"><a name="a468"></a>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a href="../simpleid/_www---common.inc.php.html#functionindirect_fatal_error">indirect_fatal_error</a><span class="src-sym">(</span><a href="../simpleid/_www---locale.inc.php.html#functiont">t</a><span class="src-sym">(</span><span class="src-str">'Protocol&nbsp;Error:&nbsp;openid.identity&nbsp;not&nbsp;set.'</span><span class="src-sym">))</span><span class="src-sym">;</span></div></li>
<li><div class="src-line"><a name="a469"></a>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-key">return</span><span class="src-sym">;</span></div></li>
<li><div class="src-line"><a name="a470"></a>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-sym">}</span></div></li>
<li><div class="src-line"><a name="a471"></a>&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-sym">}</span></div></li>
<li><div class="src-line"><a name="a472"></a>&nbsp;</div></li>
<li><div class="src-line"><a name="a473"></a>&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-key">if&nbsp;</span><span class="src-sym">(</span><span class="src-var">$version&nbsp;</span>&gt;=&nbsp;<span class="src-id"><a href="../simpleid/_www---openid.inc.php.html#defineOPENID_VERSION_2">OPENID_VERSION_2</a></span><span class="src-sym">)&nbsp;</span><span class="src-sym">{</span></div></li>
<li><div class="src-line"><a name="a474"></a>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-key">if&nbsp;</span><span class="src-sym">(</span>isset<span class="src-sym">(</span><span class="src-var">$request</span><span class="src-sym">[</span><span class="src-str">'openid.identity'</span><span class="src-sym">]</span><span class="src-sym">)&nbsp;</span>&amp;&amp;&nbsp;<span class="src-sym">!</span>isset<span class="src-sym">(</span><span class="src-var">$request</span><span class="src-sym">[</span><span class="src-str">'openid.claimed_id'</span><span class="src-sym">]</span><span class="src-sym">))&nbsp;</span><span class="src-sym">{</span></div></li>
<li><div class="src-line"><a name="a475"></a>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a href="../simpleid/_www---log.inc.php.html#functionlog_error">log_error</a><span class="src-sym">(</span><span class="src-str">'Protocol&nbsp;Error:&nbsp;openid.identity&nbsp;set,&nbsp;but&nbsp;not&nbsp;openid.claimed_id.'</span><span class="src-sym">)</span><span class="src-sym">;</span></div></li>
<li><div class="src-line"><a name="a476"></a>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a href="../simpleid/_www---common.inc.php.html#functionindirect_fatal_error">indirect_fatal_error</a><span class="src-sym">(</span><a href="../simpleid/_www---locale.inc.php.html#functiont">t</a><span class="src-sym">(</span><span class="src-str">'Protocol&nbsp;Error:&nbsp;openid.identity&nbsp;set,&nbsp;but&nbsp;not&nbsp;openid.claimed_id.'</span><span class="src-sym">))</span><span class="src-sym">;</span></div></li>
<li><div class="src-line"><a name="a477"></a>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-key">return</span><span class="src-sym">;</span></div></li>
<li><div class="src-line"><a name="a478"></a>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-sym">}</span></div></li>
<li><div class="src-line"><a name="a479"></a>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</div></li>
<li><div class="src-line"><a name="a480"></a>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-key">if&nbsp;</span><span class="src-sym">(</span><span class="src-sym">!</span>isset<span class="src-sym">(</span><span class="src-var">$request</span><span class="src-sym">[</span><span class="src-str">'openid.realm'</span><span class="src-sym">]</span><span class="src-sym">)&nbsp;</span>&amp;&amp;&nbsp;<span class="src-sym">!</span>isset<span class="src-sym">(</span><span class="src-var">$request</span><span class="src-sym">[</span><span class="src-str">'openid.return_to'</span><span class="src-sym">]</span><span class="src-sym">))&nbsp;</span><span class="src-sym">{</span></div></li>
<li><div class="src-line"><a name="a481"></a>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a href="../simpleid/_www---log.inc.php.html#functionlog_error">log_error</a><span class="src-sym">(</span><span class="src-str">'Protocol&nbsp;Error:&nbsp;openid.return_to&nbsp;not&nbsp;set&nbsp;when&nbsp;openid.realm&nbsp;is&nbsp;not&nbsp;set.'</span><span class="src-sym">)</span><span class="src-sym">;</span></div></li>
<li><div class="src-line"><a name="a482"></a>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a href="../simpleid/_www---common.inc.php.html#functionindirect_fatal_error">indirect_fatal_error</a><span class="src-sym">(</span><a href="../simpleid/_www---locale.inc.php.html#functiont">t</a><span class="src-sym">(</span><span class="src-str">'Protocol&nbsp;Error:&nbsp;openid.return_to&nbsp;not&nbsp;set&nbsp;when&nbsp;openid.realm&nbsp;is&nbsp;not&nbsp;set.'</span><span class="src-sym">))</span><span class="src-sym">;</span></div></li>
<li><div class="src-line"><a name="a483"></a>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-key">return</span><span class="src-sym">;</span></div></li>
<li><div class="src-line"><a name="a484"></a>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-sym">}</span></div></li>
<li><div class="src-line"><a name="a485"></a>&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-sym">}</span></div></li>
<li><div class="src-line"><a name="a486"></a>&nbsp;&nbsp;&nbsp;&nbsp;</div></li>
<li><div class="src-line"><a name="a487"></a>&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-key">if&nbsp;</span><span class="src-sym">(</span>isset<span class="src-sym">(</span><span class="src-var">$request</span><span class="src-sym">[</span><span class="src-str">'openid.return_to'</span><span class="src-sym">]</span><span class="src-sym">))&nbsp;</span><span class="src-sym">{</span></div></li>
<li><div class="src-line"><a name="a488"></a>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-var">$realm&nbsp;</span>=&nbsp;<a href="../simpleid/_www---openid.inc.php.html#functionopenid_get_realm">openid_get_realm</a><span class="src-sym">(</span><span class="src-var">$request</span><span class="src-sym">,&nbsp;</span><span class="src-var">$version</span><span class="src-sym">)</span><span class="src-sym">;</span></div></li>
<li><div class="src-line"><a name="a489"></a>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</div></li>
<li><div class="src-line"><a name="a490"></a>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-key">if&nbsp;</span><span class="src-sym">(</span><span class="src-sym">!</span><a href="../simpleid/_www---openid.inc.php.html#functionopenid_url_matches_realm">openid_url_matches_realm</a><span class="src-sym">(</span><span class="src-var">$request</span><span class="src-sym">[</span><span class="src-str">'openid.return_to'</span><span class="src-sym">]</span><span class="src-sym">,&nbsp;</span><span class="src-var">$realm</span><span class="src-sym">))&nbsp;</span><span class="src-sym">{</span></div></li>
<li><div class="src-line"><a name="a491"></a>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a href="../simpleid/_www---log.inc.php.html#functionlog_error">log_error</a><span class="src-sym">(</span><span class="src-str">'Protocol&nbsp;Error:&nbsp;openid.return_to&nbsp;does&nbsp;not&nbsp;match&nbsp;realm.'</span><span class="src-sym">)</span><span class="src-sym">;</span></div></li>
<li><div class="src-line"><a name="a492"></a>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a href="../simpleid/_www---openid.inc.php.html#functionopenid_indirect_error">openid_indirect_error</a><span class="src-sym">(</span><span class="src-var">$request</span><span class="src-sym">[</span><span class="src-str">'openid.return_to'</span><span class="src-sym">]</span><span class="src-sym">,&nbsp;</span><span class="src-str">'Protocol&nbsp;Error:&nbsp;openid.return_to&nbsp;does&nbsp;not&nbsp;match&nbsp;realm.'</span><span class="src-sym">)</span><span class="src-sym">;</span></div></li>
<li><div class="src-line"><a name="a493"></a>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-key">return</span><span class="src-sym">;</span></div></li>
<li><div class="src-line"><a name="a494"></a>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-sym">}</span></div></li>
<li><div class="src-line"><a name="a495"></a>&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-sym">}</span></div></li>
<li><div class="src-line"><a name="a496"></a>&nbsp;&nbsp;&nbsp;&nbsp;</div></li>
<li><div class="src-line"><a name="a497"></a>&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-key">if&nbsp;</span><span class="src-sym">(</span>isset<span class="src-sym">(</span><span class="src-var">$request</span><span class="src-sym">[</span><span class="src-str">'openid.identity'</span><span class="src-sym">]</span><span class="src-sym">))&nbsp;</span><span class="src-sym">{</span></div></li>
<li><div class="src-line"><a name="a498"></a>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-comm">//&nbsp;Standard&nbsp;request</span></div></li>
<li><div class="src-line"><a name="a499"></a>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a href="../simpleid/_www---log.inc.php.html#functionlog_debug">log_debug</a><span class="src-sym">(</span><span class="src-str">'openid.identity&nbsp;found,&nbsp;use&nbsp;simpleid_checkid_identity'</span><span class="src-sym">)</span><span class="src-sym">;</span></div></li>
<li><div class="src-line"><a name="a500"></a>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-var">$result&nbsp;</span>=&nbsp;<a href="../simpleid/_www---index.php.html#functionsimpleid_checkid_identity">simpleid_checkid_identity</a><span class="src-sym">(</span><span class="src-var">$request</span><span class="src-sym">,&nbsp;</span><span class="src-var">$immediate</span><span class="src-sym">)</span><span class="src-sym">;</span></div></li>
<li><div class="src-line"><a name="a501"></a>&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-sym">}&nbsp;</span><span class="src-key">else&nbsp;</span><span class="src-sym">{</span></div></li>
<li><div class="src-line"><a name="a502"></a>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a href="../simpleid/_www---log.inc.php.html#functionlog_debug">log_debug</a><span class="src-sym">(</span><span class="src-str">'openid.identity&nbsp;not&nbsp;found,&nbsp;trying&nbsp;extensions'</span><span class="src-sym">)</span><span class="src-sym">;</span></div></li>
<li><div class="src-line"><a name="a503"></a>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-comm">//&nbsp;Extension&nbsp;request</span></div></li>
<li><div class="src-line"><a name="a504"></a>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-var">$results&nbsp;</span>=&nbsp;<a href="../simpleid/_www---common.inc.php.html#functionextension_invoke_all">extension_invoke_all</a><span class="src-sym">(</span><span class="src-str">'checkid'</span><span class="src-sym">,&nbsp;</span><span class="src-var">$request</span><span class="src-sym">,&nbsp;</span><span class="src-var">$immediate</span><span class="src-sym">)</span><span class="src-sym">;</span></div></li>
<li><div class="src-line"><a name="a505"></a>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</div></li>
<li><div class="src-line"><a name="a506"></a>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-comm">//&nbsp;Filter&nbsp;out&nbsp;nulls</span></div></li>
<li><div class="src-line"><a name="a507"></a>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-var">$results&nbsp;</span>=&nbsp;<a href="http://www.php.net/array_merge">array_merge</a><span class="src-sym">(</span><a href="http://www.php.net/array_diff">array_diff</a><span class="src-sym">(</span><span class="src-var">$results</span><span class="src-sym">,&nbsp;</span><span class="src-key">array</span><span class="src-sym">(</span><span class="src-id">NULL</span><span class="src-sym">)))</span><span class="src-sym">;</span></div></li>
<li><div class="src-line"><a name="a508"></a>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</div></li>
<li><div class="src-line"><a name="a509"></a>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-comm">//&nbsp;If&nbsp;there&nbsp;are&nbsp;still&nbsp;results,&nbsp;it&nbsp;is&nbsp;the&nbsp;lowest&nbsp;value,&nbsp;otherwise,&nbsp;it&nbsp;is&nbsp;CHECKID_PROTOCOL_ERROR</span></div></li>
<li><div class="src-line"><a name="a510"></a>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-var">$result&nbsp;</span>=&nbsp;<span class="src-sym">(</span><span class="src-var">$results</span><span class="src-sym">)&nbsp;</span>?&nbsp;<a href="http://www.php.net/min">min</a><span class="src-sym">(</span><span class="src-var">$results</span><span class="src-sym">)&nbsp;</span>:&nbsp;<span class="src-id"><a href="../simpleid/_www---index.php.html#defineCHECKID_PROTOCOL_ERROR">CHECKID_PROTOCOL_ERROR</a></span><span class="src-sym">;</span></div></li>
<li><div class="src-line"><a name="a511"></a>&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-sym">}</span></div></li>
<li><div class="src-line"><a name="a512"></a>&nbsp;&nbsp;&nbsp;&nbsp;</div></li>
<li><div class="src-line"><a name="a513"></a>&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-key">switch&nbsp;</span><span class="src-sym">(</span><span class="src-var">$result</span><span class="src-sym">)&nbsp;</span><span class="src-sym">{</span></div></li>
<li><div class="src-line"><a name="a514"></a>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-key">case&nbsp;</span><span class="src-id"><a href="../simpleid/_www---index.php.html#defineCHECKID_APPROVAL_REQUIRED">CHECKID_APPROVAL_REQUIRED</a></span>:</div></li>
<li><div class="src-line"><a name="a515"></a>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a href="../simpleid/_www---log.inc.php.html#functionlog_info">log_info</a><span class="src-sym">(</span><span class="src-str">'CHECKID_APPROVAL_REQUIRED'</span><span class="src-sym">)</span><span class="src-sym">;</span></div></li>
<li><div class="src-line"><a name="a516"></a>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-key">if&nbsp;</span><span class="src-sym">(</span><span class="src-var">$immediate</span><span class="src-sym">)&nbsp;</span><span class="src-sym">{</span></div></li>
<li><div class="src-line"><a name="a517"></a>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-var">$response&nbsp;</span>=&nbsp;<a href="../simpleid/_www---index.php.html#functionsimpleid_checkid_approval_required">simpleid_checkid_approval_required</a><span class="src-sym">(</span><span class="src-var">$request</span><span class="src-sym">)</span><span class="src-sym">;</span></div></li>
<li><div class="src-line"><a name="a518"></a>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a href="../simpleid/_www---index.php.html#functionsimpleid_assertion_response">simpleid_assertion_response</a><span class="src-sym">(</span><span class="src-var">$response</span><span class="src-sym">,&nbsp;</span><span class="src-var">$request</span><span class="src-sym">[</span><span class="src-str">'openid.return_to'</span><span class="src-sym">]</span><span class="src-sym">)</span><span class="src-sym">;</span></div></li>
<li><div class="src-line"><a name="a519"></a>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-sym">}&nbsp;</span><span class="src-key">else&nbsp;</span><span class="src-sym">{</span></div></li>
<li><div class="src-line"><a name="a520"></a>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-var">$response&nbsp;</span>=&nbsp;<a href="../simpleid/_www---index.php.html#functionsimpleid_checkid_ok">simpleid_checkid_ok</a><span class="src-sym">(</span><span class="src-var">$request</span><span class="src-sym">)</span><span class="src-sym">;</span></div></li>
<li><div class="src-line"><a name="a521"></a>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a href="../simpleid/_www---index.php.html#functionsimpleid_openid_consent_form">simpleid_openid_consent_form</a><span class="src-sym">(</span><span class="src-var">$request</span><span class="src-sym">,&nbsp;</span><span class="src-var">$response</span><span class="src-sym">,&nbsp;</span><span class="src-var">$result</span><span class="src-sym">)</span><span class="src-sym">;</span></div></li>
<li><div class="src-line"><a name="a522"></a>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-sym">}</span></div></li>
<li><div class="src-line"><a name="a523"></a>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-key">break</span><span class="src-sym">;</span></div></li>
<li><div class="src-line"><a name="a524"></a>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-key">case&nbsp;</span><span class="src-id"><a href="../simpleid/_www---index.php.html#defineCHECKID_RETURN_TO_SUSPECT">CHECKID_RETURN_TO_SUSPECT</a></span>:</div></li>
<li><div class="src-line"><a name="a525"></a>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a href="../simpleid/_www---log.inc.php.html#functionlog_info">log_info</a><span class="src-sym">(</span><span class="src-str">'CHECKID_RETURN_TO_SUSPECT'</span><span class="src-sym">)</span><span class="src-sym">;</span></div></li>
<li><div class="src-line"><a name="a526"></a>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-key">if&nbsp;</span><span class="src-sym">(</span><span class="src-var">$immediate</span><span class="src-sym">)&nbsp;</span><span class="src-sym">{</span></div></li>
<li><div class="src-line"><a name="a527"></a>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-var">$response&nbsp;</span>=&nbsp;<a href="../simpleid/_www---index.php.html#functionsimpleid_checkid_error">simpleid_checkid_error</a><span class="src-sym">(</span><span class="src-var">$request</span><span class="src-sym">,&nbsp;</span><span class="src-var">$immediate</span><span class="src-sym">)</span><span class="src-sym">;</span></div></li>
<li><div class="src-line"><a name="a528"></a>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a href="../simpleid/_www---index.php.html#functionsimpleid_assertion_response">simpleid_assertion_response</a><span class="src-sym">(</span><span class="src-var">$response</span><span class="src-sym">,&nbsp;</span><span class="src-var">$request</span><span class="src-sym">[</span><span class="src-str">'openid.return_to'</span><span class="src-sym">]</span><span class="src-sym">)</span><span class="src-sym">;</span></div></li>
<li><div class="src-line"><a name="a529"></a>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-sym">}&nbsp;</span><span class="src-key">else&nbsp;</span><span class="src-sym">{</span></div></li>
<li><div class="src-line"><a name="a530"></a>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-var">$response&nbsp;</span>=&nbsp;<a href="../simpleid/_www---index.php.html#functionsimpleid_checkid_ok">simpleid_checkid_ok</a><span class="src-sym">(</span><span class="src-var">$request</span><span class="src-sym">)</span><span class="src-sym">;</span></div></li>
<li><div class="src-line"><a name="a531"></a>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a href="../simpleid/_www---index.php.html#functionsimpleid_openid_consent_form">simpleid_openid_consent_form</a><span class="src-sym">(</span><span class="src-var">$request</span><span class="src-sym">,&nbsp;</span><span class="src-var">$response</span><span class="src-sym">,&nbsp;</span><span class="src-var">$result</span><span class="src-sym">)</span><span class="src-sym">;</span></div></li>
<li><div class="src-line"><a name="a532"></a>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-sym">}</span></div></li>
<li><div class="src-line"><a name="a533"></a>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-key">break</span><span class="src-sym">;</span></div></li>
<li><div class="src-line"><a name="a534"></a>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-key">case&nbsp;</span><span class="src-id"><a href="../simpleid/_www---index.php.html#defineCHECKID_OK">CHECKID_OK</a></span>:</div></li>
<li><div class="src-line"><a name="a535"></a>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a href="../simpleid/_www---log.inc.php.html#functionlog_info">log_info</a><span class="src-sym">(</span><span class="src-str">'CHECKID_OK'</span><span class="src-sym">)</span><span class="src-sym">;</span></div></li>
<li><div class="src-line"><a name="a536"></a>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-var">$response&nbsp;</span>=&nbsp;<a href="../simpleid/_www---index.php.html#functionsimpleid_checkid_ok">simpleid_checkid_ok</a><span class="src-sym">(</span><span class="src-var">$request</span><span class="src-sym">)</span><span class="src-sym">;</span></div></li>
<li><div class="src-line"><a name="a537"></a>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-var">$response&nbsp;</span>=&nbsp;<a href="../simpleid/_www---index.php.html#functionsimpleid_sign">simpleid_sign</a><span class="src-sym">(</span><span class="src-var">$response</span><span class="src-sym">,&nbsp;</span>isset<span class="src-sym">(</span><span class="src-var">$request</span><span class="src-sym">[</span><span class="src-str">'openid.assoc_handle'</span><span class="src-sym">]</span><span class="src-sym">)&nbsp;</span>?&nbsp;<span class="src-var">$request</span><span class="src-sym">[</span><span class="src-str">'openid.assoc_handle'</span><span class="src-sym">]&nbsp;</span>:&nbsp;<span class="src-id">NULL</span><span class="src-sym">)</span><span class="src-sym">;</span></div></li>
<li><div class="src-line"><a name="a538"></a>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a href="../simpleid/_www---index.php.html#functionsimpleid_assertion_response">simpleid_assertion_response</a><span class="src-sym">(</span><span class="src-var">$response</span><span class="src-sym">,&nbsp;</span><span class="src-var">$request</span><span class="src-sym">[</span><span class="src-str">'openid.return_to'</span><span class="src-sym">]</span><span class="src-sym">)</span><span class="src-sym">;</span></div></li>
<li><div class="src-line"><a name="a539"></a>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-key">break</span><span class="src-sym">;</span></div></li>
<li><div class="src-line"><a name="a540"></a>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-key">case&nbsp;</span><span class="src-id"><a href="../simpleid/_www---index.php.html#defineCHECKID_LOGIN_REQUIRED">CHECKID_LOGIN_REQUIRED</a></span>:</div></li>
<li><div class="src-line"><a name="a541"></a>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a href="../simpleid/_www---log.inc.php.html#functionlog_info">log_info</a><span class="src-sym">(</span><span class="src-str">'CHECKID_LOGIN_REQUIRED'</span><span class="src-sym">)</span><span class="src-sym">;</span></div></li>
<li><div class="src-line"><a name="a542"></a>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-key">if&nbsp;</span><span class="src-sym">(</span><span class="src-var">$immediate</span><span class="src-sym">)&nbsp;</span><span class="src-sym">{</span></div></li>
<li><div class="src-line"><a name="a543"></a>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-var">$response&nbsp;</span>=&nbsp;<a href="../simpleid/_www---index.php.html#functionsimpleid_checkid_login_required">simpleid_checkid_login_required</a><span class="src-sym">(</span><span class="src-var">$request</span><span class="src-sym">)</span><span class="src-sym">;</span></div></li>
<li><div class="src-line"><a name="a544"></a>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a href="../simpleid/_www---index.php.html#functionsimpleid_assertion_response">simpleid_assertion_response</a><span class="src-sym">(</span><span class="src-var">$response</span><span class="src-sym">,&nbsp;</span><span class="src-var">$request</span><span class="src-sym">[</span><span class="src-str">'openid.return_to'</span><span class="src-sym">]</span><span class="src-sym">)</span><span class="src-sym">;</span></div></li>
<li><div class="src-line"><a name="a545"></a>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-sym">}&nbsp;</span><span class="src-key">else&nbsp;</span><span class="src-sym">{</span></div></li>
<li><div class="src-line"><a name="a546"></a>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a href="../simpleid/_www---user.inc.php.html#functionuser_login_form">user_login_form</a><span class="src-sym">(</span><span class="src-str">'continue'</span><span class="src-sym">,&nbsp;</span><a href="../simpleid/_www---common.inc.php.html#functionpickle">pickle</a><span class="src-sym">(</span><span class="src-var">$request</span><span class="src-sym">))</span><span class="src-sym">;</span></div></li>
<li><div class="src-line"><a name="a547"></a>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-key">exit</span><span class="src-sym">;</span></div></li>
<li><div class="src-line"><a name="a548"></a>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-sym">}</span></div></li>
<li><div class="src-line"><a name="a549"></a>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-key">break</span><span class="src-sym">;</span></div></li>
<li><div class="src-line"><a name="a550"></a>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-key">case&nbsp;</span><span class="src-id"><a href="../simpleid/_www---index.php.html#defineCHECKID_IDENTITIES_NOT_MATCHING">CHECKID_IDENTITIES_NOT_MATCHING</a></span>:</div></li>
<li><div class="src-line"><a name="a551"></a>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-key">case&nbsp;</span><span class="src-id"><a href="../simpleid/_www---index.php.html#defineCHECKID_IDENTITY_NOT_EXIST">CHECKID_IDENTITY_NOT_EXIST</a></span>:</div></li>
<li><div class="src-line"><a name="a552"></a>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a href="../simpleid/_www---log.inc.php.html#functionlog_info">log_info</a><span class="src-sym">(</span><span class="src-str">'CHECKID_IDENTITIES_NOT_MATCHING&nbsp;|&nbsp;CHECKID_IDENTITY_NOT_EXIST'</span><span class="src-sym">)</span><span class="src-sym">;</span></div></li>
<li><div class="src-line"><a name="a553"></a>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-var">$response&nbsp;</span>=&nbsp;<a href="../simpleid/_www---index.php.html#functionsimpleid_checkid_error">simpleid_checkid_error</a><span class="src-sym">(</span><span class="src-var">$request</span><span class="src-sym">,&nbsp;</span><span class="src-var">$immediate</span><span class="src-sym">)</span><span class="src-sym">;</span></div></li>
<li><div class="src-line"><a name="a554"></a>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-key">if&nbsp;</span><span class="src-sym">(</span><span class="src-var">$immediate</span><span class="src-sym">)&nbsp;</span><span class="src-sym">{&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span></div></li>
<li><div class="src-line"><a name="a555"></a>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a href="../simpleid/_www---index.php.html#functionsimpleid_assertion_response">simpleid_assertion_response</a><span class="src-sym">(</span><span class="src-var">$response</span><span class="src-sym">,&nbsp;</span><span class="src-var">$request</span><span class="src-sym">[</span><span class="src-str">'openid.return_to'</span><span class="src-sym">]</span><span class="src-sym">)</span><span class="src-sym">;</span></div></li>
<li><div class="src-line"><a name="a556"></a>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-sym">}&nbsp;</span><span class="src-key">else&nbsp;</span><span class="src-sym">{&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span></div></li>
<li><div class="src-line"><a name="a557"></a>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a href="../simpleid/_www---index.php.html#functionsimpleid_openid_consent_form">simpleid_openid_consent_form</a><span class="src-sym">(</span><span class="src-var">$request</span><span class="src-sym">,&nbsp;</span><span class="src-var">$response</span><span class="src-sym">,&nbsp;</span><span class="src-var">$result</span><span class="src-sym">)</span><span class="src-sym">;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span></div></li>
<li><div class="src-line"><a name="a558"></a>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-sym">}</span></div></li>
<li><div class="src-line"><a name="a559"></a>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-key">break</span><span class="src-sym">;</span></div></li>
<li><div class="src-line"><a name="a560"></a>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-key">case&nbsp;</span><span class="src-id"><a href="../simpleid/_www---index.php.html#defineCHECKID_PROTOCOL_ERROR">CHECKID_PROTOCOL_ERROR</a></span>:</div></li>
<li><div class="src-line"><a name="a561"></a>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-key">if&nbsp;</span><span class="src-sym">(</span>isset<span class="src-sym">(</span><span class="src-var">$request</span><span class="src-sym">[</span><span class="src-str">'openid.return_to'</span><span class="src-sym">]</span><span class="src-sym">))&nbsp;</span><span class="src-sym">{</span></div></li>
<li><div class="src-line"><a name="a562"></a>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-var">$response&nbsp;</span>=&nbsp;<a href="../simpleid/_www---index.php.html#functionsimpleid_checkid_error">simpleid_checkid_error</a><span class="src-sym">(</span><span class="src-var">$request</span><span class="src-sym">,&nbsp;</span><span class="src-var">$immediate</span><span class="src-sym">)</span><span class="src-sym">;</span></div></li>
<li><div class="src-line"><a name="a563"></a>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a href="../simpleid/_www---index.php.html#functionsimpleid_assertion_response">simpleid_assertion_response</a><span class="src-sym">(</span><span class="src-var">$response</span><span class="src-sym">,&nbsp;</span><span class="src-var">$request</span><span class="src-sym">[</span><span class="src-str">'openid.return_to'</span><span class="src-sym">]</span><span class="src-sym">)</span><span class="src-sym">;</span></div></li>
<li><div class="src-line"><a name="a564"></a>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-sym">}&nbsp;</span><span class="src-key">else&nbsp;</span><span class="src-sym">{</span></div></li>
<li><div class="src-line"><a name="a565"></a>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a href="../simpleid/_www---common.inc.php.html#functionindirect_fatal_error">indirect_fatal_error</a><span class="src-sym">(</span><span class="src-str">'Unrecognised&nbsp;request.'</span><span class="src-sym">)</span><span class="src-sym">;</span></div></li>
<li><div class="src-line"><a name="a566"></a>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-sym">}</span></div></li>
<li><div class="src-line"><a name="a567"></a>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-key">break</span><span class="src-sym">;</span></div></li>
<li><div class="src-line"><a name="a568"></a>&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-sym">}</span></div></li>
<li><div class="src-line"><a name="a569"></a><span class="src-sym">}</span></div></li>
<li><div class="src-line"><a name="a570"></a>&nbsp;</div></li>
<li><div class="src-line"><a name="a571"></a><span class="src-doc">/**</span></div></li>
<li><div class="src-line"><a name="a572"></a><span class="src-doc">&nbsp;*&nbsp;Processes&nbsp;a&nbsp;standard&nbsp;OpenID&nbsp;authentication&nbsp;request&nbsp;about&nbsp;an&nbsp;identity.</span></div></li>
<li><div class="src-line"><a name="a573"></a><span class="src-doc">&nbsp;*</span></div></li>
<li><div class="src-line"><a name="a574"></a><span class="src-doc">&nbsp;*&nbsp;Checks&nbsp;whether&nbsp;the&nbsp;current&nbsp;user&nbsp;logged&nbsp;into&nbsp;SimpleID&nbsp;matches&nbsp;the&nbsp;identity</span></div></li>
<li><div class="src-line"><a name="a575"></a><span class="src-doc">&nbsp;*&nbsp;supplied&nbsp;in&nbsp;an&nbsp;OpenID&nbsp;request.</span></div></li>
<li><div class="src-line"><a name="a576"></a><span class="src-doc">&nbsp;*</span></div></li>
<li><div class="src-line"><a name="a577"></a><span class="src-doc">&nbsp;*&nbsp;</span><span class="src-doc-coretag">@param&nbsp;</span><span class="src-doc-type">array&nbsp;</span><span class="src-doc-var">&amp;$request&nbsp;</span><span class="src-doc">the&nbsp;OpenID&nbsp;request</span></div></li>
<li><div class="src-line"><a name="a578"></a><span class="src-doc">&nbsp;*&nbsp;</span><span class="src-doc-coretag">@param&nbsp;</span><span class="src-doc-type">bool&nbsp;</span><span class="src-doc-var">$immediate&nbsp;</span><span class="src-doc">whether&nbsp;checkid_immediate&nbsp;was&nbsp;used</span></div></li>
<li><div class="src-line"><a name="a579"></a><span class="src-doc">&nbsp;*&nbsp;</span><span class="src-doc-coretag">@return&nbsp;</span><span class="src-doc-type">int&nbsp;</span><span class="src-doc">one&nbsp;of&nbsp;CHECKID_OK,&nbsp;CHECKID_APPROVAL_REQUIRED,&nbsp;CHECKID_RETURN_TO_SUSPECT,&nbsp;CHECKID_IDENTITY_NOT_EXIST,</span></div></li>
<li><div class="src-line"><a name="a580"></a><span class="src-doc">&nbsp;*&nbsp;&nbsp;CHECKID_IDENTITIES_NOT_MATCHING,&nbsp;CHECKID_LOGIN_REQUIRED&nbsp;or&nbsp;CHECKID_PROTOCOL_ERROR</span></div></li>
<li><div class="src-line"><a name="a581"></a><span class="src-doc">&nbsp;*&nbsp;</span><span class="src-doc-coretag">@global&nbsp;</span><span class="src-doc-type">array&nbsp;</span><span class="src-doc">the&nbsp;current&nbsp;logged&nbsp;in&nbsp;user</span></div></li>
<li><div class="src-line"><a name="a582"></a><span class="src-doc">&nbsp;*/</span></div></li>
<li><div class="src-line"><a name="a583"></a><span class="src-key">function&nbsp;</span><a href="../simpleid/_www---index.php.html#functionsimpleid_checkid_identity">simpleid_checkid_identity</a><span class="src-sym">(</span><span class="src-sym">&amp;</span><span class="src-var">$request</span><span class="src-sym">,&nbsp;</span><span class="src-var">$immediate</span><span class="src-sym">)&nbsp;</span><span class="src-sym">{</span></div></li>
<li><div class="src-line"><a name="a584"></a>&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-key">global&nbsp;</span><a href="../simpleid/_www---user.inc.php.html#global$user">$user</a><span class="src-sym">,&nbsp;</span><a href="../simpleid/_www---index.php.html#global$version">$version</a><span class="src-sym">;</span></div></li>
<li><div class="src-line"><a name="a585"></a>&nbsp;&nbsp;&nbsp;&nbsp;</div></li>
<li><div class="src-line"><a name="a586"></a>&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-var">$realm&nbsp;</span>=&nbsp;<a href="../simpleid/_www---openid.inc.php.html#functionopenid_get_realm">openid_get_realm</a><span class="src-sym">(</span><span class="src-var">$request</span><span class="src-sym">,&nbsp;</span><span class="src-var">$version</span><span class="src-sym">)</span><span class="src-sym">;</span></div></li>
<li><div class="src-line"><a name="a587"></a>&nbsp;&nbsp;&nbsp;&nbsp;</div></li>
<li><div class="src-line"><a name="a588"></a>&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-comm">//&nbsp;Check&nbsp;1:&nbsp;Is&nbsp;the&nbsp;user&nbsp;logged&nbsp;into&nbsp;SimpleID&nbsp;as&nbsp;any&nbsp;user?</span></div></li>
<li><div class="src-line"><a name="a589"></a>&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-key">if&nbsp;</span><span class="src-sym">(</span><span class="src-var">$user&nbsp;</span>==&nbsp;<span class="src-id">NULL</span><span class="src-sym">)&nbsp;</span><span class="src-sym">{</span></div></li>
<li><div class="src-line"><a name="a590"></a>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-key">return&nbsp;</span><span class="src-id"><a href="../simpleid/_www---index.php.html#defineCHECKID_LOGIN_REQUIRED">CHECKID_LOGIN_REQUIRED</a></span><span class="src-sym">;</span></div></li>
<li><div class="src-line"><a name="a591"></a>&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-sym">}&nbsp;</span><span class="src-key">else&nbsp;</span><span class="src-sym">{</span></div></li>
<li><div class="src-line"><a name="a592"></a>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-var">$uid&nbsp;</span>=&nbsp;<span class="src-var">$user</span><span class="src-sym">[</span><span class="src-str">'uid'</span><span class="src-sym">]</span><span class="src-sym">;</span></div></li>
<li><div class="src-line"><a name="a593"></a>&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-sym">}</span></div></li>
<li><div class="src-line"><a name="a594"></a>&nbsp;&nbsp;&nbsp;&nbsp;</div></li>
<li><div class="src-line"><a name="a595"></a>&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-comm">//&nbsp;Check&nbsp;2:&nbsp;Is&nbsp;the&nbsp;user&nbsp;logged&nbsp;in&nbsp;as&nbsp;the&nbsp;same&nbsp;identity&nbsp;as&nbsp;the&nbsp;identity&nbsp;requested?</span></div></li>
<li><div class="src-line"><a name="a596"></a>&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-comm">//&nbsp;Choose&nbsp;the&nbsp;identity&nbsp;URL&nbsp;for&nbsp;the&nbsp;user&nbsp;automatically</span></div></li>
<li><div class="src-line"><a name="a597"></a>&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-key">if&nbsp;</span><span class="src-sym">(</span><span class="src-var">$request</span><span class="src-sym">[</span><span class="src-str">'openid.identity'</span><span class="src-sym">]&nbsp;</span>==&nbsp;<span class="src-id"><a href="../simpleid/_www---openid.inc.php.html#defineOPENID_IDENTIFIER_SELECT">OPENID_IDENTIFIER_SELECT</a></span><span class="src-sym">)&nbsp;</span><span class="src-sym">{</span></div></li>
<li><div class="src-line"><a name="a598"></a>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-var">$test_user&nbsp;</span>=&nbsp;<a href="../simpleid/_www---user.inc.php.html#functionuser_load">user_load</a><span class="src-sym">(</span><span class="src-var">$uid</span><span class="src-sym">)</span><span class="src-sym">;</span></div></li>
<li><div class="src-line"><a name="a599"></a>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-var">$identity&nbsp;</span>=&nbsp;<span class="src-var">$test_user</span><span class="src-sym">[</span><span class="src-str">'identity'</span><span class="src-sym">]</span><span class="src-sym">;</span></div></li>
<li><div class="src-line"><a name="a600"></a>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</div></li>
<li><div class="src-line"><a name="a601"></a>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a href="../simpleid/_www---log.inc.php.html#functionlog_info">log_info</a><span class="src-sym">(</span><span class="src-str">'OpenID&nbsp;identifier&nbsp;selection:&nbsp;Selected&nbsp;'&nbsp;</span>.&nbsp;<span class="src-var">$uid&nbsp;</span>.&nbsp;<span class="src-str">'&nbsp;['&nbsp;</span>.&nbsp;<span class="src-var">$identity&nbsp;</span>.&nbsp;<span class="src-str">']'</span><span class="src-sym">)</span><span class="src-sym">;</span></div></li>
<li><div class="src-line"><a name="a602"></a>&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-sym">}&nbsp;</span><span class="src-key">else&nbsp;</span><span class="src-sym">{</span></div></li>
<li><div class="src-line"><a name="a603"></a>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-var">$identity&nbsp;</span>=&nbsp;<span class="src-var">$request</span><span class="src-sym">[</span><span class="src-str">'openid.identity'</span><span class="src-sym">]</span><span class="src-sym">;</span></div></li>
<li><div class="src-line"><a name="a604"></a>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-var">$test_user&nbsp;</span>=&nbsp;<a href="../simpleid/_www---user.inc.php.html#functionuser_load_from_identity">user_load_from_identity</a><span class="src-sym">(</span><span class="src-var">$identity</span><span class="src-sym">)</span><span class="src-sym">;</span></div></li>
<li><div class="src-line"><a name="a605"></a>&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-sym">}</span></div></li>
<li><div class="src-line"><a name="a606"></a>&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-key">if&nbsp;</span><span class="src-sym">(</span><span class="src-var">$test_user&nbsp;</span>==&nbsp;<span class="src-id">NULL</span><span class="src-sym">)&nbsp;</span><span class="src-key">return&nbsp;</span><span class="src-id"><a href="../simpleid/_www---index.php.html#defineCHECKID_IDENTITY_NOT_EXIST">CHECKID_IDENTITY_NOT_EXIST</a></span><span class="src-sym">;</span></div></li>
<li><div class="src-line"><a name="a607"></a>&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-key">if&nbsp;</span><span class="src-sym">(</span><span class="src-var">$test_user</span><span class="src-sym">[</span><span class="src-str">'uid'</span><span class="src-sym">]&nbsp;</span>!=&nbsp;<span class="src-var">$user</span><span class="src-sym">[</span><span class="src-str">'uid'</span><span class="src-sym">]</span><span class="src-sym">)&nbsp;</span><span class="src-sym">{</span></div></li>
<li><div class="src-line"><a name="a608"></a>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a href="../simpleid/_www---log.inc.php.html#functionlog_notice">log_notice</a><span class="src-sym">(</span><span class="src-str">'Requested&nbsp;user&nbsp;'&nbsp;</span>.&nbsp;<span class="src-var">$test_user</span><span class="src-sym">[</span><span class="src-str">'uid'</span><span class="src-sym">]&nbsp;</span>.&nbsp;<span class="src-str">'&nbsp;does&nbsp;not&nbsp;match&nbsp;logged&nbsp;in&nbsp;user&nbsp;'&nbsp;</span>.&nbsp;<span class="src-var">$user</span><span class="src-sym">[</span><span class="src-str">'uid'</span><span class="src-sym">]</span><span class="src-sym">)</span><span class="src-sym">;</span></div></li>
<li><div class="src-line"><a name="a609"></a>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-key">return&nbsp;</span><span class="src-id"><a href="../simpleid/_www---index.php.html#defineCHECKID_IDENTITIES_NOT_MATCHING">CHECKID_IDENTITIES_NOT_MATCHING</a></span><span class="src-sym">;</span></div></li>
<li><div class="src-line"><a name="a610"></a>&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-sym">}</span></div></li>
<li><div class="src-line"><a name="a611"></a>&nbsp;&nbsp;&nbsp;&nbsp;</div></li>
<li><div class="src-line"><a name="a612"></a>&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-comm">//&nbsp;Pass&nbsp;the&nbsp;assertion&nbsp;to&nbsp;extensions</span></div></li>
<li><div class="src-line"><a name="a613"></a>&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-var">$assertion_results&nbsp;</span>=&nbsp;<a href="../simpleid/_www---common.inc.php.html#functionextension_invoke_all">extension_invoke_all</a><span class="src-sym">(</span><span class="src-str">'checkid_identity'</span><span class="src-sym">,&nbsp;</span><span class="src-var">$request</span><span class="src-sym">,&nbsp;</span><span class="src-var">$identity</span><span class="src-sym">,&nbsp;</span><span class="src-var">$immediate</span><span class="src-sym">)</span><span class="src-sym">;</span></div></li>
<li><div class="src-line"><a name="a614"></a>&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-var">$assertion_results&nbsp;</span>=&nbsp;<a href="http://www.php.net/array_merge">array_merge</a><span class="src-sym">(</span><a href="http://www.php.net/array_diff">array_diff</a><span class="src-sym">(</span><span class="src-var">$assertion_results</span><span class="src-sym">,&nbsp;</span><span class="src-key">array</span><span class="src-sym">(</span><span class="src-id">NULL</span><span class="src-sym">)))</span><span class="src-sym">;</span></div></li>
<li><div class="src-line"><a name="a615"></a>&nbsp;&nbsp;&nbsp;&nbsp;</div></li>
<li><div class="src-line"><a name="a616"></a>&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-comm">//&nbsp;Populate&nbsp;the&nbsp;request&nbsp;with&nbsp;the&nbsp;selected&nbsp;identity</span></div></li>
<li><div class="src-line"><a name="a617"></a>&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-key">if&nbsp;</span><span class="src-sym">(</span><span class="src-var">$request</span><span class="src-sym">[</span><span class="src-str">'openid.identity'</span><span class="src-sym">]&nbsp;</span>==&nbsp;<span class="src-id"><a href="../simpleid/_www---openid.inc.php.html#defineOPENID_IDENTIFIER_SELECT">OPENID_IDENTIFIER_SELECT</a></span><span class="src-sym">)&nbsp;</span><span class="src-sym">{</span></div></li>
<li><div class="src-line"><a name="a618"></a>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-var">$request</span><span class="src-sym">[</span><span class="src-str">'openid.claimed_id'</span><span class="src-sym">]&nbsp;</span>=&nbsp;<span class="src-var">$identity</span><span class="src-sym">;</span></div></li>
<li><div class="src-line"><a name="a619"></a>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-var">$request</span><span class="src-sym">[</span><span class="src-str">'openid.identity'</span><span class="src-sym">]&nbsp;</span>=&nbsp;<span class="src-var">$identity</span><span class="src-sym">;</span></div></li>
<li><div class="src-line"><a name="a620"></a>&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-sym">}</span></div></li>
<li><div class="src-line"><a name="a621"></a>&nbsp;&nbsp;&nbsp;&nbsp;</div></li>
<li><div class="src-line"><a name="a622"></a>&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-comm">//&nbsp;Check&nbsp;3:&nbsp;Discover&nbsp;the&nbsp;realm&nbsp;and&nbsp;match&nbsp;its&nbsp;return_to</span></div></li>
<li><div class="src-line"><a name="a623"></a>&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-var">$user_rp&nbsp;</span>=&nbsp;<span class="src-sym">(</span>isset<span class="src-sym">(</span><span class="src-var">$user</span><span class="src-sym">[</span><span class="src-str">'rp'</span><span class="src-sym">]</span><span class="src-sym">[</span><span class="src-var">$realm</span><span class="src-sym">]</span><span class="src-sym">))&nbsp;</span>?&nbsp;<span class="src-var">$user</span><span class="src-sym">[</span><span class="src-str">'rp'</span><span class="src-sym">]</span><span class="src-sym">[</span><span class="src-var">$realm</span><span class="src-sym">]&nbsp;</span>:&nbsp;<span class="src-id">NULL</span><span class="src-sym">;</span></div></li>
<li><div class="src-line"><a name="a624"></a>&nbsp;</div></li>
<li><div class="src-line"><a name="a625"></a>&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-key">if&nbsp;</span><span class="src-sym">((</span><span class="src-var">$version&nbsp;</span>&gt;=&nbsp;<span class="src-id"><a href="../simpleid/_www---openid.inc.php.html#defineOPENID_VERSION_2">OPENID_VERSION_2</a></span><span class="src-sym">)&nbsp;</span>&amp;&amp;&nbsp;<span class="src-id"><a href="../simpleid/_www---config.php.dist.html#defineSIMPLEID_VERIFY_RETURN_URL_USING_REALM">SIMPLEID_VERIFY_RETURN_URL_USING_REALM</a></span><span class="src-sym">)&nbsp;</span><span class="src-sym">{</span></div></li>
<li><div class="src-line"><a name="a626"></a>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-var">$verified&nbsp;</span>=&nbsp;<span class="src-id">FALSE</span><span class="src-sym">;</span></div></li>
<li><div class="src-line"><a name="a627"></a>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</div></li>
<li><div class="src-line"><a name="a628"></a>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-var">$rp_info&nbsp;</span>=&nbsp;<a href="../simpleid/_www---index.php.html#functionsimpleid_get_rp_info">simpleid_get_rp_info</a><span class="src-sym">(</span><span class="src-var">$realm</span><span class="src-sym">)</span><span class="src-sym">;</span></div></li>
<li><div class="src-line"><a name="a629"></a>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-var">$services&nbsp;</span>=&nbsp;<a href="../simpleid/_www---discovery.inc.php.html#functiondiscovery_xrds_services_by_type">discovery_xrds_services_by_type</a><span class="src-sym">(</span><span class="src-var">$rp_info</span><span class="src-sym">[</span><span class="src-str">'services'</span><span class="src-sym">]</span><span class="src-sym">,&nbsp;</span><span class="src-id"><a href="../simpleid/_www---openid.inc.php.html#defineOPENID_RETURN_TO">OPENID_RETURN_TO</a></span><span class="src-sym">)</span><span class="src-sym">;</span></div></li>
<li><div class="src-line"><a name="a630"></a>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</div></li>
<li><div class="src-line"><a name="a631"></a>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a href="../simpleid/_www---log.inc.php.html#functionlog_info">log_info</a><span class="src-sym">(</span><span class="src-str">'OpenID&nbsp;2&nbsp;discovery:&nbsp;'&nbsp;</span>.&nbsp;<a href="http://www.php.net/count">count</a><span class="src-sym">(</span><span class="src-var">$services</span><span class="src-sym">)&nbsp;</span>.&nbsp;<span class="src-str">'&nbsp;matching&nbsp;services'</span><span class="src-sym">)</span><span class="src-sym">;</span></div></li>
<li><div class="src-line"><a name="a632"></a>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</div></li>
<li><div class="src-line"><a name="a633"></a>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-key">if&nbsp;</span><span class="src-sym">(</span><span class="src-var">$services</span><span class="src-sym">)&nbsp;</span><span class="src-sym">{</span></div></li>
<li><div class="src-line"><a name="a634"></a>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-var">$return_to_uris&nbsp;</span>=&nbsp;<span class="src-key">array</span><span class="src-sym">(</span><span class="src-sym">)</span><span class="src-sym">;</span></div></li>
<li><div class="src-line"><a name="a635"></a>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</div></li>
<li><div class="src-line"><a name="a636"></a>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-key">foreach&nbsp;</span><span class="src-sym">(</span><span class="src-var">$services&nbsp;</span><span class="src-key">as&nbsp;</span><span class="src-var">$service</span><span class="src-sym">)&nbsp;</span><span class="src-sym">{</span></div></li>
<li><div class="src-line"><a name="a637"></a>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-var">$return_to_uris&nbsp;</span>=&nbsp;<a href="http://www.php.net/array_merge">array_merge</a><span class="src-sym">(</span><span class="src-var">$return_to_uris</span><span class="src-sym">,&nbsp;</span><span class="src-var">$service</span><span class="src-sym">[</span><span class="src-str">'uri'</span><span class="src-sym">]</span><span class="src-sym">)</span><span class="src-sym">;</span></div></li>
<li><div class="src-line"><a name="a638"></a>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-sym">}</span></div></li>
<li><div class="src-line"><a name="a639"></a>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-key">foreach&nbsp;</span><span class="src-sym">(</span><span class="src-var">$return_to_uris&nbsp;</span><span class="src-key">as&nbsp;</span><span class="src-var">$return_to</span><span class="src-sym">)&nbsp;</span><span class="src-sym">{</span></div></li>
<li><div class="src-line"><a name="a640"></a>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-key">if&nbsp;</span><span class="src-sym">(</span><a href="../simpleid/_www---openid.inc.php.html#functionopenid_url_matches_realm">openid_url_matches_realm</a><span class="src-sym">(</span><span class="src-var">$request</span><span class="src-sym">[</span><span class="src-str">'openid.return_to'</span><span class="src-sym">]</span><span class="src-sym">,&nbsp;</span><span class="src-var">$return_to</span><span class="src-sym">))&nbsp;</span><span class="src-sym">{</span></div></li>
<li><div class="src-line"><a name="a641"></a>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a href="../simpleid/_www---log.inc.php.html#functionlog_info">log_info</a><span class="src-sym">(</span><span class="src-str">'OpenID&nbsp;2&nbsp;discovery:&nbsp;verified'</span><span class="src-sym">)</span><span class="src-sym">;</span></div></li>
<li><div class="src-line"><a name="a642"></a>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-var">$verified&nbsp;</span>=&nbsp;<span class="src-id">TRUE</span><span class="src-sym">;</span></div></li>
<li><div class="src-line"><a name="a643"></a>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-key">break</span><span class="src-sym">;</span></div></li>
<li><div class="src-line"><a name="a644"></a>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-sym">}</span></div></li>
<li><div class="src-line"><a name="a645"></a>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-sym">}</span></div></li>
<li><div class="src-line"><a name="a646"></a>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-sym">}</span></div></li>
<li><div class="src-line"><a name="a647"></a>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</div></li>
<li><div class="src-line"><a name="a648"></a>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-var">$rp_info</span><span class="src-sym">[</span><span class="src-str">'return_to_verified'</span><span class="src-sym">]&nbsp;</span>=&nbsp;<span class="src-var">$verified</span><span class="src-sym">;</span></div></li>
<li><div class="src-line"><a name="a649"></a>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a href="../simpleid/_www---index.php.html#functionsimpleid_set_rp_info">simpleid_set_rp_info</a><span class="src-sym">(</span><span class="src-var">$realm</span><span class="src-sym">,&nbsp;</span><span class="src-var">$rp_info</span><span class="src-sym">)</span><span class="src-sym">;</span></div></li>
<li><div class="src-line"><a name="a650"></a>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</div></li>
<li><div class="src-line"><a name="a651"></a>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-key">if&nbsp;</span><span class="src-sym">(</span><span class="src-sym">!</span><span class="src-var">$verified</span><span class="src-sym">)&nbsp;</span><span class="src-sym">{</span></div></li>
<li><div class="src-line"><a name="a652"></a>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-key">if&nbsp;</span><span class="src-sym">((</span><span class="src-var">$user_rp&nbsp;</span>!=&nbsp;<span class="src-id">NULL</span><span class="src-sym">)&nbsp;</span>&amp;&amp;&nbsp;<span class="src-sym">(</span><span class="src-var">$user_rp</span><span class="src-sym">[</span><span class="src-str">'auto_release'</span><span class="src-sym">]&nbsp;</span>==&nbsp;<span class="src-num">1</span><span class="src-sym">))&nbsp;</span><span class="src-sym">{</span></div></li>
<li><div class="src-line"><a name="a653"></a>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a href="../simpleid/_www---log.inc.php.html#functionlog_notice">log_notice</a><span class="src-sym">(</span><span class="src-str">'OpenID&nbsp;2&nbsp;discovery:&nbsp;not&nbsp;verified,&nbsp;but&nbsp;overridden&nbsp;by&nbsp;user&nbsp;preference'</span><span class="src-sym">)</span><span class="src-sym">;</span></div></li>
<li><div class="src-line"><a name="a654"></a>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-sym">}&nbsp;</span><span class="src-key">else&nbsp;</span><span class="src-sym">{</span></div></li>
<li><div class="src-line"><a name="a655"></a>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a href="../simpleid/_www---log.inc.php.html#functionlog_notice">log_notice</a><span class="src-sym">(</span><span class="src-str">'OpenID&nbsp;2&nbsp;discovery:&nbsp;not&nbsp;verified'</span><span class="src-sym">)</span><span class="src-sym">;</span></div></li>
<li><div class="src-line"><a name="a656"></a>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-var">$assertion_results</span><span class="src-sym">[</span><span class="src-sym">]&nbsp;</span>=&nbsp;<span class="src-id"><a href="../simpleid/_www---index.php.html#defineCHECKID_RETURN_TO_SUSPECT">CHECKID_RETURN_TO_SUSPECT</a></span><span class="src-sym">;</span></div></li>
<li><div class="src-line"><a name="a657"></a>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-sym">}</span></div></li>
<li><div class="src-line"><a name="a658"></a>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-sym">}</span></div></li>
<li><div class="src-line"><a name="a659"></a>&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-sym">}</span></div></li>
<li><div class="src-line"><a name="a660"></a>&nbsp;&nbsp;&nbsp;&nbsp;</div></li>
<li><div class="src-line"><a name="a661"></a>&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-comm">//&nbsp;Check&nbsp;4:&nbsp;For&nbsp;checkid_immediate,&nbsp;the&nbsp;user&nbsp;must&nbsp;already&nbsp;have&nbsp;given</span></div></li>
<li><div class="src-line"><a name="a662"></a>&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-comm">//&nbsp;permission&nbsp;to&nbsp;log&nbsp;in&nbsp;automatically.&nbsp;&nbsp;&nbsp;&nbsp;</span></div></li>
<li><div class="src-line"><a name="a663"></a>&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-key">if&nbsp;</span><span class="src-sym">((</span><span class="src-var">$user_rp&nbsp;</span>!=&nbsp;<span class="src-id">NULL</span><span class="src-sym">)&nbsp;</span>&amp;&amp;&nbsp;<span class="src-sym">(</span><span class="src-var">$user_rp</span><span class="src-sym">[</span><span class="src-str">'auto_release'</span><span class="src-sym">]&nbsp;</span>==&nbsp;<span class="src-num">1</span><span class="src-sym">))&nbsp;</span><span class="src-sym">{</span></div></li>
<li><div class="src-line"><a name="a664"></a>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a href="../simpleid/_www---log.inc.php.html#functionlog_info">log_info</a><span class="src-sym">(</span><span class="src-str">'Automatic&nbsp;set&nbsp;for&nbsp;realm&nbsp;'&nbsp;</span>.&nbsp;<span class="src-var">$realm</span><span class="src-sym">)</span><span class="src-sym">;</span></div></li>
<li><div class="src-line"><a name="a665"></a>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-var">$assertion_results</span><span class="src-sym">[</span><span class="src-sym">]&nbsp;</span>=&nbsp;<span class="src-id"><a href="../simpleid/_www---index.php.html#defineCHECKID_OK">CHECKID_OK</a></span><span class="src-sym">;</span></div></li>
<li><div class="src-line"><a name="a666"></a>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-key">return&nbsp;</span><a href="http://www.php.net/min">min</a><span class="src-sym">(</span><span class="src-var">$assertion_results</span><span class="src-sym">)</span><span class="src-sym">;</span></div></li>
<li><div class="src-line"><a name="a667"></a>&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-sym">}&nbsp;</span><span class="src-key">else&nbsp;</span><span class="src-sym">{</span></div></li>
<li><div class="src-line"><a name="a668"></a>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-var">$assertion_results</span><span class="src-sym">[</span><span class="src-sym">]&nbsp;</span>=&nbsp;<span class="src-id"><a href="../simpleid/_www---index.php.html#defineCHECKID_APPROVAL_REQUIRED">CHECKID_APPROVAL_REQUIRED</a></span><span class="src-sym">;</span></div></li>
<li><div class="src-line"><a name="a669"></a>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-key">return&nbsp;</span><a href="http://www.php.net/min">min</a><span class="src-sym">(</span><span class="src-var">$assertion_results</span><span class="src-sym">)</span><span class="src-sym">;</span></div></li>
<li><div class="src-line"><a name="a670"></a>&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-sym">}</span></div></li>
<li><div class="src-line"><a name="a671"></a><span class="src-sym">}</span></div></li>
<li><div class="src-line"><a name="a672"></a>&nbsp;</div></li>
<li><div class="src-line"><a name="a673"></a><span class="src-doc">/**</span></div></li>
<li><div class="src-line"><a name="a674"></a><span class="src-doc">&nbsp;*&nbsp;Obtains&nbsp;information&nbsp;on&nbsp;a&nbsp;relying&nbsp;party&nbsp;by&nbsp;performing&nbsp;discovery&nbsp;on&nbsp;them.&nbsp;&nbsp;Information</span></div></li>
<li><div class="src-line"><a name="a675"></a><span class="src-doc">&nbsp;*&nbsp;obtained&nbsp;includes&nbsp;the&nbsp;discovery&nbsp;URL,&nbsp;the&nbsp;parsed&nbsp;XRDS&nbsp;document,&nbsp;and&nbsp;any&nbsp;other</span></div></li>
<li><div class="src-line"><a name="a676"></a><span class="src-doc">&nbsp;*&nbsp;information&nbsp;saved&nbsp;by&nbsp;SimpleID&nbsp;extensions</span></div></li>
<li><div class="src-line"><a name="a677"></a><span class="src-doc">&nbsp;*</span></div></li>
<li><div class="src-line"><a name="a678"></a><span class="src-doc">&nbsp;*&nbsp;The&nbsp;results&nbsp;are&nbsp;cached&nbsp;for&nbsp;1&nbsp;hour.&nbsp;&nbsp;For&nbsp;performance&nbsp;reasons,&nbsp;stale&nbsp;results&nbsp;may</span></div></li>
<li><div class="src-line"><a name="a679"></a><span class="src-doc">&nbsp;*&nbsp;be&nbsp;obtained&nbsp;by&nbsp;using&nbsp;the&nbsp;$allow_stale&nbsp;parameter</span></div></li>
<li><div class="src-line"><a name="a680"></a><span class="src-doc">&nbsp;*</span></div></li>
<li><div class="src-line"><a name="a681"></a><span class="src-doc">&nbsp;*&nbsp;</span><span class="src-doc-coretag">@param&nbsp;</span><span class="src-doc-type">string&nbsp;</span><span class="src-doc-var">$realm&nbsp;</span><span class="src-doc">the&nbsp;openid.realm&nbsp;parameter</span></div></li>
<li><div class="src-line"><a name="a682"></a><span class="src-doc">&nbsp;*&nbsp;</span><span class="src-doc-coretag">@param&nbsp;</span><span class="src-doc-type">bool&nbsp;</span><span class="src-doc-var">$allow_stale&nbsp;</span><span class="src-doc">allow&nbsp;stale&nbsp;results&nbsp;to&nbsp;be&nbsp;returned,&nbsp;otherwise&nbsp;discovery</span></div></li>
<li><div class="src-line"><a name="a683"></a><span class="src-doc">&nbsp;*&nbsp;&nbsp;will&nbsp;occur</span></div></li>
<li><div class="src-line"><a name="a684"></a><span class="src-doc">&nbsp;*&nbsp;</span><span class="src-doc-coretag">@return&nbsp;</span><span class="src-doc-type">array&nbsp;</span><span class="src-doc">containing&nbsp;information&nbsp;on&nbsp;a&nbsp;relying&nbsp;party.</span></div></li>
<li><div class="src-line"><a name="a685"></a><span class="src-doc">&nbsp;*&nbsp;</span><span class="src-doc-coretag">@link</span><span class="src-doc">&nbsp;http://openid.net/specs/openid-authentication-2_0.html#rp_discovery</span></div></li>
<li><div class="src-line"><a name="a686"></a><span class="src-doc">&nbsp;*&nbsp;</span><span class="src-doc-coretag">@since</span><span class="src-doc">&nbsp;0.8</span></div></li>
<li><div class="src-line"><a name="a687"></a><span class="src-doc">&nbsp;*/</span></div></li>
<li><div class="src-line"><a name="a688"></a><span class="src-key">function&nbsp;</span><a href="../simpleid/_www---index.php.html#functionsimpleid_get_rp_info">simpleid_get_rp_info</a><span class="src-sym">(</span><span class="src-var">$realm</span><span class="src-sym">,&nbsp;</span><span class="src-var">$allow_stale&nbsp;</span>=&nbsp;<span class="src-id">FALSE</span><span class="src-sym">)&nbsp;</span><span class="src-sym">{</span></div></li>
<li><div class="src-line"><a name="a689"></a>&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-var">$url&nbsp;</span>=&nbsp;<a href="../simpleid/_www---openid.inc.php.html#functionopenid_realm_discovery_url">openid_realm_discovery_url</a><span class="src-sym">(</span><span class="src-var">$realm</span><span class="src-sym">)</span><span class="src-sym">;</span></div></li>
<li><div class="src-line"><a name="a690"></a>&nbsp;&nbsp;&nbsp;&nbsp;</div></li>
<li><div class="src-line"><a name="a691"></a>&nbsp;&nbsp;&nbsp;&nbsp;<a href="../simpleid/_www---log.inc.php.html#functionlog_info">log_info</a><span class="src-sym">(</span><span class="src-str">'simpleid_get_rp_info'</span><span class="src-sym">)</span><span class="src-sym">;</span></div></li>
<li><div class="src-line"><a name="a692"></a>&nbsp;&nbsp;&nbsp;&nbsp;</div></li>
<li><div class="src-line"><a name="a693"></a>&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-var">$rp_info&nbsp;</span>=&nbsp;<a href="../simpleid/_www---cache.inc.php.html#functioncache_get">cache_get</a><span class="src-sym">(</span><span class="src-str">'rp-info'</span><span class="src-sym">,&nbsp;</span><span class="src-var">$realm</span><span class="src-sym">)</span><span class="src-sym">;</span></div></li>
<li><div class="src-line"><a name="a694"></a>&nbsp;&nbsp;&nbsp;&nbsp;</div></li>
<li><div class="src-line"><a name="a695"></a>&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-key">if&nbsp;</span><span class="src-sym">((</span><span class="src-var">$rp_info&nbsp;</span>==&nbsp;<span class="src-id">NULL</span><span class="src-sym">)&nbsp;</span>||&nbsp;<span class="src-sym">(</span><span class="src-sym">!</span>isset<span class="src-sym">(</span><span class="src-var">$rp_info</span><span class="src-sym">[</span><span class="src-str">'updated'</span><span class="src-sym">]</span><span class="src-sym">))&nbsp;</span>||&nbsp;<span class="src-sym">(</span><span class="src-sym">!</span><span class="src-var">$allow_stale&nbsp;</span>&amp;&amp;&nbsp;<span class="src-sym">(</span><span class="src-var">$rp_info</span><span class="src-sym">[</span><span class="src-str">'updated'</span><span class="src-sym">]&nbsp;</span>&lt;&nbsp;<a href="http://www.php.net/time">time</a><span class="src-sym">(</span><span class="src-sym">)&nbsp;</span>-&nbsp;<span class="src-num">3600</span><span class="src-sym">)))&nbsp;</span><span class="src-sym">{</span></div></li>
<li><div class="src-line"><a name="a696"></a>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a href="../simpleid/_www---log.inc.php.html#functionlog_info">log_info</a><span class="src-sym">(</span><span class="src-str">'OpenID&nbsp;2&nbsp;RP&nbsp;discovery:&nbsp;realm:&nbsp;'&nbsp;</span>.&nbsp;<span class="src-var">$realm&nbsp;</span>.&nbsp;<span class="src-str">';&nbsp;url:&nbsp;'&nbsp;</span>.&nbsp;<span class="src-var">$url</span><span class="src-sym">)</span><span class="src-sym">;</span></div></li>
<li><div class="src-line"><a name="a697"></a>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</div></li>
<li><div class="src-line"><a name="a698"></a>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-var">$rp_info&nbsp;</span>=&nbsp;<span class="src-key">array</span><span class="src-sym">(</span></div></li>
<li><div class="src-line"><a name="a699"></a>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-str">'url'&nbsp;</span>=&gt;&nbsp;<span class="src-var">$url</span><span class="src-sym">,</span></div></li>
<li><div class="src-line"><a name="a700"></a>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-str">'services'&nbsp;</span>=&gt;&nbsp;<a href="../simpleid/_www---discovery.inc.php.html#functiondiscovery_xrds_discover">discovery_xrds_discover</a><span class="src-sym">(</span><span class="src-var">$url</span><span class="src-sym">)</span><span class="src-sym">,</span></div></li>
<li><div class="src-line"><a name="a701"></a>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-str">'updated'&nbsp;</span>=&gt;&nbsp;<a href="http://www.php.net/time">time</a><span class="src-sym">(</span><span class="src-sym">)</span></div></li>
<li><div class="src-line"><a name="a702"></a>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-sym">)</span><span class="src-sym">;</span></div></li>
<li><div class="src-line"><a name="a703"></a>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</div></li>
<li><div class="src-line"><a name="a704"></a>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a href="../simpleid/_www---cache.inc.php.html#functioncache_set">cache_set</a><span class="src-sym">(</span><span class="src-str">'rp-info'</span><span class="src-sym">,&nbsp;</span><span class="src-var">$realm</span><span class="src-sym">,&nbsp;</span><span class="src-var">$rp_info</span><span class="src-sym">)</span><span class="src-sym">;</span></div></li>
<li><div class="src-line"><a name="a705"></a>&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-sym">}</span></div></li>
<li><div class="src-line"><a name="a706"></a>&nbsp;</div></li>
<li><div class="src-line"><a name="a707"></a>&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-key">return&nbsp;</span><span class="src-var">$rp_info</span><span class="src-sym">;</span></div></li>
<li><div class="src-line"><a name="a708"></a><span class="src-sym">}</span></div></li>
<li><div class="src-line"><a name="a709"></a>&nbsp;</div></li>
<li><div class="src-line"><a name="a710"></a><span class="src-doc">/**</span></div></li>
<li><div class="src-line"><a name="a711"></a><span class="src-doc">&nbsp;*&nbsp;Saves&nbsp;information&nbsp;on&nbsp;a&nbsp;relying&nbsp;party&nbsp;to&nbsp;disk.</span></div></li>
<li><div class="src-line"><a name="a712"></a><span class="src-doc">&nbsp;*</span></div></li>
<li><div class="src-line"><a name="a713"></a><span class="src-doc">&nbsp;*&nbsp;</span><span class="src-doc-coretag">@param&nbsp;</span><span class="src-doc-type">string&nbsp;</span><span class="src-doc-var">$realm&nbsp;</span><span class="src-doc">the&nbsp;openid.realm&nbsp;parameter</span></div></li>
<li><div class="src-line"><a name="a714"></a><span class="src-doc">&nbsp;*&nbsp;</span><span class="src-doc-coretag">@param&nbsp;</span><span class="src-doc-type">array&nbsp;</span><span class="src-doc-var">$rp_info&nbsp;</span><span class="src-doc">containing&nbsp;information&nbsp;on&nbsp;a&nbsp;relying&nbsp;party.</span></div></li>
<li><div class="src-line"><a name="a715"></a><span class="src-doc">&nbsp;*</span></div></li>
<li><div class="src-line"><a name="a716"></a><span class="src-doc">&nbsp;*&nbsp;</span><span class="src-doc-coretag">@since</span><span class="src-doc">&nbsp;0.8</span></div></li>
<li><div class="src-line"><a name="a717"></a><span class="src-doc">&nbsp;*/</span></div></li>
<li><div class="src-line"><a name="a718"></a><span class="src-key">function&nbsp;</span><a href="../simpleid/_www---index.php.html#functionsimpleid_set_rp_info">simpleid_set_rp_info</a><span class="src-sym">(</span><span class="src-var">$realm</span><span class="src-sym">,&nbsp;</span><span class="src-var">$rp_info</span><span class="src-sym">)&nbsp;</span><span class="src-sym">{</span></div></li>
<li><div class="src-line"><a name="a719"></a>&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-key">if&nbsp;</span><span class="src-sym">(</span><span class="src-sym">!</span>isset<span class="src-sym">(</span><span class="src-var">$rp_info</span><span class="src-sym">[</span><span class="src-str">'updated'</span><span class="src-sym">]</span><span class="src-sym">))&nbsp;</span><span class="src-var">$rp_info</span><span class="src-sym">[</span><span class="src-str">'updated'</span><span class="src-sym">]&nbsp;</span>=&nbsp;<a href="http://www.php.net/time">time</a><span class="src-sym">(</span><span class="src-sym">)</span><span class="src-sym">;</span></div></li>
<li><div class="src-line"><a name="a720"></a>&nbsp;&nbsp;&nbsp;&nbsp;<a href="../simpleid/_www---cache.inc.php.html#functioncache_set">cache_set</a><span class="src-sym">(</span><span class="src-str">'rp-info'</span><span class="src-sym">,&nbsp;</span><span class="src-var">$realm</span><span class="src-sym">,&nbsp;</span><span class="src-var">$rp_info</span><span class="src-sym">,&nbsp;</span><span class="src-var">$rp_info</span><span class="src-sym">[</span><span class="src-str">'updated'</span><span class="src-sym">]</span><span class="src-sym">)</span><span class="src-sym">;</span></div></li>
<li><div class="src-line"><a name="a721"></a><span class="src-sym">}</span></div></li>
<li><div class="src-line"><a name="a722"></a>&nbsp;</div></li>
<li><div class="src-line"><a name="a723"></a><span class="src-doc">/**</span></div></li>
<li><div class="src-line"><a name="a724"></a><span class="src-doc">&nbsp;*&nbsp;Returns&nbsp;an&nbsp;OpenID&nbsp;response&nbsp;indicating&nbsp;a&nbsp;positive&nbsp;assertion.</span></div></li>
<li><div class="src-line"><a name="a725"></a><span class="src-doc">&nbsp;*</span></div></li>
<li><div class="src-line"><a name="a726"></a><span class="src-doc">&nbsp;*&nbsp;</span><span class="src-doc-coretag">@param&nbsp;</span><span class="src-doc-type">array&nbsp;</span><span class="src-doc-var">$request&nbsp;</span><span class="src-doc">the&nbsp;OpenID&nbsp;request</span></div></li>
<li><div class="src-line"><a name="a727"></a><span class="src-doc">&nbsp;*&nbsp;</span><span class="src-doc-coretag">@return&nbsp;</span><span class="src-doc-type">array&nbsp;</span><span class="src-doc">an&nbsp;OpenID&nbsp;response&nbsp;with&nbsp;a&nbsp;positive&nbsp;assertion</span></div></li>
<li><div class="src-line"><a name="a728"></a><span class="src-doc">&nbsp;*&nbsp;</span><span class="src-doc-coretag">@link</span><span class="src-doc">&nbsp;http://openid.net/specs/openid-authentication-1_1.html#anchor17,&nbsp;http://openid.net/specs/openid-authentication-1_1.html#anchor23,&nbsp;http://openid.net/specs/openid-authentication-2_0.html#positive_assertions</span></div></li>
<li><div class="src-line"><a name="a729"></a><span class="src-doc">&nbsp;*/</span></div></li>
<li><div class="src-line"><a name="a730"></a><span class="src-key">function&nbsp;</span><a href="../simpleid/_www---index.php.html#functionsimpleid_checkid_ok">simpleid_checkid_ok</a><span class="src-sym">(</span><span class="src-var">$request</span><span class="src-sym">)&nbsp;</span><span class="src-sym">{</span></div></li>
<li><div class="src-line"><a name="a731"></a>&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-key">global&nbsp;</span><a href="../simpleid/_www---index.php.html#global$version">$version</a><span class="src-sym">;</span></div></li>
<li><div class="src-line"><a name="a732"></a>&nbsp;&nbsp;&nbsp;&nbsp;</div></li>
<li><div class="src-line"><a name="a733"></a>&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-var">$message&nbsp;</span>=&nbsp;<span class="src-key">array</span><span class="src-sym">(</span></div></li>
<li><div class="src-line"><a name="a734"></a>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-str">'openid.mode'&nbsp;</span>=&gt;&nbsp;<span class="src-str">'id_res'</span><span class="src-sym">,</span></div></li>
<li><div class="src-line"><a name="a735"></a>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-str">'openid.op_endpoint'&nbsp;</span>=&gt;&nbsp;<a href="../simpleid/_www---common.inc.php.html#functionsimpleid_url">simpleid_url</a><span class="src-sym">(</span><span class="src-sym">)</span><span class="src-sym">,</span></div></li>
<li><div class="src-line"><a name="a736"></a>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-str">'openid.response_nonce'&nbsp;</span>=&gt;&nbsp;<a href="../simpleid/_www---openid.inc.php.html#functionopenid_nonce">openid_nonce</a><span class="src-sym">(</span><span class="src-sym">)</span></div></li>
<li><div class="src-line"><a name="a737"></a>&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-sym">)</span><span class="src-sym">;</span></div></li>
<li><div class="src-line"><a name="a738"></a>&nbsp;&nbsp;&nbsp;&nbsp;</div></li>
<li><div class="src-line"><a name="a739"></a>&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-key">if&nbsp;</span><span class="src-sym">(</span>isset<span class="src-sym">(</span><span class="src-var">$request</span><span class="src-sym">[</span><span class="src-str">'openid.assoc_handle'</span><span class="src-sym">]</span><span class="src-sym">))&nbsp;</span><span class="src-var">$message</span><span class="src-sym">[</span><span class="src-str">'openid.assoc_handle'</span><span class="src-sym">]&nbsp;</span>=&nbsp;<span class="src-var">$request</span><span class="src-sym">[</span><span class="src-str">'openid.assoc_handle'</span><span class="src-sym">]</span><span class="src-sym">;</span></div></li>
<li><div class="src-line"><a name="a740"></a>&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-key">if&nbsp;</span><span class="src-sym">(</span>isset<span class="src-sym">(</span><span class="src-var">$request</span><span class="src-sym">[</span><span class="src-str">'openid.identity'</span><span class="src-sym">]</span><span class="src-sym">))&nbsp;</span><span class="src-var">$message</span><span class="src-sym">[</span><span class="src-str">'openid.identity'</span><span class="src-sym">]&nbsp;</span>=&nbsp;<span class="src-var">$request</span><span class="src-sym">[</span><span class="src-str">'openid.identity'</span><span class="src-sym">]</span><span class="src-sym">;</span></div></li>
<li><div class="src-line"><a name="a741"></a>&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-key">if&nbsp;</span><span class="src-sym">(</span>isset<span class="src-sym">(</span><span class="src-var">$request</span><span class="src-sym">[</span><span class="src-str">'openid.return_to'</span><span class="src-sym">]</span><span class="src-sym">))&nbsp;</span><span class="src-var">$message</span><span class="src-sym">[</span><span class="src-str">'openid.return_to'</span><span class="src-sym">]&nbsp;</span>=&nbsp;<span class="src-var">$request</span><span class="src-sym">[</span><span class="src-str">'openid.return_to'</span><span class="src-sym">]</span><span class="src-sym">;</span></div></li>
<li><div class="src-line"><a name="a742"></a>&nbsp;&nbsp;&nbsp;&nbsp;</div></li>
<li><div class="src-line"><a name="a743"></a>&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-key">if&nbsp;</span><span class="src-sym">((</span><span class="src-var">$version&nbsp;</span>&gt;=&nbsp;<span class="src-id"><a href="../simpleid/_www---openid.inc.php.html#defineOPENID_VERSION_2">OPENID_VERSION_2</a></span><span class="src-sym">)&nbsp;</span>&amp;&amp;&nbsp;isset<span class="src-sym">(</span><span class="src-var">$request</span><span class="src-sym">[</span><span class="src-str">'openid.claimed_id'</span><span class="src-sym">]</span><span class="src-sym">))&nbsp;</span><span class="src-sym">{</span></div></li>
<li><div class="src-line"><a name="a744"></a>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-var">$message</span><span class="src-sym">[</span><span class="src-str">'openid.claimed_id'</span><span class="src-sym">]&nbsp;</span>=&nbsp;<span class="src-var">$request</span><span class="src-sym">[</span><span class="src-str">'openid.claimed_id'</span><span class="src-sym">]</span><span class="src-sym">;</span></div></li>
<li><div class="src-line"><a name="a745"></a>&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-sym">}</span></div></li>
<li><div class="src-line"><a name="a746"></a>&nbsp;&nbsp;&nbsp;&nbsp;</div></li>
<li><div class="src-line"><a name="a747"></a>&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-var">$message&nbsp;</span>=&nbsp;<a href="http://www.php.net/array_merge">array_merge</a><span class="src-sym">(</span><span class="src-var">$message</span><span class="src-sym">,&nbsp;</span><a href="../simpleid/_www---common.inc.php.html#functionextension_invoke_all">extension_invoke_all</a><span class="src-sym">(</span><span class="src-str">'response'</span><span class="src-sym">,&nbsp;</span><span class="src-id">TRUE</span><span class="src-sym">,&nbsp;</span><span class="src-var">$request</span><span class="src-sym">))</span><span class="src-sym">;</span></div></li>
<li><div class="src-line"><a name="a748"></a>&nbsp;&nbsp;&nbsp;&nbsp;</div></li>
<li><div class="src-line"><a name="a749"></a>&nbsp;&nbsp;&nbsp;&nbsp;<a href="../simpleid/_www---log.inc.php.html#functionlog_info">log_info</a><span class="src-sym">(</span><span class="src-str">'OpenID&nbsp;authentication&nbsp;response:&nbsp;'&nbsp;</span>.&nbsp;<a href="../simpleid/_www---log.inc.php.html#functionlog_array">log_array</a><span class="src-sym">(</span><span class="src-var">$message</span><span class="src-sym">))</span><span class="src-sym">;</span></div></li>
<li><div class="src-line"><a name="a750"></a>&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-key">return&nbsp;</span><a href="../simpleid/_www---openid.inc.php.html#functionopenid_indirect_message">openid_indirect_message</a><span class="src-sym">(</span><span class="src-var">$message</span><span class="src-sym">,&nbsp;</span><span class="src-var">$version</span><span class="src-sym">)</span><span class="src-sym">;</span></div></li>
<li><div class="src-line"><a name="a751"></a><span class="src-sym">}</span></div></li>
<li><div class="src-line"><a name="a752"></a>&nbsp;</div></li>
<li><div class="src-line"><a name="a753"></a><span class="src-doc">/**</span></div></li>
<li><div class="src-line"><a name="a754"></a><span class="src-doc">&nbsp;*&nbsp;Returns&nbsp;an&nbsp;OpenID&nbsp;response&nbsp;indicating&nbsp;a&nbsp;negative&nbsp;assertion&nbsp;to&nbsp;a</span></div></li>
<li><div class="src-line"><a name="a755"></a><span class="src-doc">&nbsp;*&nbsp;checkid_immediate&nbsp;request,&nbsp;where&nbsp;an&nbsp;approval&nbsp;of&nbsp;the&nbsp;relying&nbsp;party&nbsp;by&nbsp;the</span></div></li>
<li><div class="src-line"><a name="a756"></a><span class="src-doc">&nbsp;*&nbsp;user&nbsp;is&nbsp;required</span></div></li>
<li><div class="src-line"><a name="a757"></a><span class="src-doc">&nbsp;*</span></div></li>
<li><div class="src-line"><a name="a758"></a><span class="src-doc">&nbsp;*&nbsp;</span><span class="src-doc-coretag">@param&nbsp;</span><span class="src-doc-type">mixed&nbsp;</span><span class="src-doc-var">$request&nbsp;</span><span class="src-doc">the&nbsp;OpenID&nbsp;request</span></div></li>
<li><div class="src-line"><a name="a759"></a><span class="src-doc">&nbsp;*&nbsp;</span><span class="src-doc-coretag">@return&nbsp;</span><span class="src-doc-type">mixed&nbsp;</span><span class="src-doc">an&nbsp;OpenID&nbsp;response&nbsp;with&nbsp;a&nbsp;negative&nbsp;assertion</span></div></li>
<li><div class="src-line"><a name="a760"></a><span class="src-doc">&nbsp;*&nbsp;</span><span class="src-doc-coretag">@link</span><span class="src-doc">&nbsp;http://openid.net/specs/openid-authentication-1_1.html#anchor17,&nbsp;http://openid.net/specs/openid-authentication-1_1.html#anchor23,&nbsp;http://openid.net/specs/openid-authentication-2_0.html#negative_assertions</span></div></li>
<li><div class="src-line"><a name="a761"></a><span class="src-doc">&nbsp;*/</span></div></li>
<li><div class="src-line"><a name="a762"></a><span class="src-key">function&nbsp;</span><a href="../simpleid/_www---index.php.html#functionsimpleid_checkid_approval_required">simpleid_checkid_approval_required</a><span class="src-sym">(</span><span class="src-var">$request</span><span class="src-sym">)&nbsp;</span><span class="src-sym">{</span></div></li>
<li><div class="src-line"><a name="a763"></a>&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-key">global&nbsp;</span><a href="../simpleid/_www---index.php.html#global$version">$version</a><span class="src-sym">;</span></div></li>
<li><div class="src-line"><a name="a764"></a>&nbsp;&nbsp;&nbsp;&nbsp;</div></li>
<li><div class="src-line"><a name="a765"></a>&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-key">if&nbsp;</span><span class="src-sym">(</span><span class="src-var">$version&nbsp;</span>&gt;=&nbsp;<span class="src-id"><a href="../simpleid/_www---openid.inc.php.html#defineOPENID_VERSION_2">OPENID_VERSION_2</a></span><span class="src-sym">)&nbsp;</span><span class="src-sym">{</span></div></li>
<li><div class="src-line"><a name="a766"></a>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-var">$message&nbsp;</span>=&nbsp;<span class="src-key">array</span><span class="src-sym">(</span><span class="src-str">'openid.mode'&nbsp;</span>=&gt;&nbsp;<span class="src-str">'setup_needed'</span><span class="src-sym">)</span><span class="src-sym">;</span></div></li>
<li><div class="src-line"><a name="a767"></a>&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-sym">}&nbsp;</span><span class="src-key">else&nbsp;</span><span class="src-sym">{</span></div></li>
<li><div class="src-line"><a name="a768"></a>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-var">$request</span><span class="src-sym">[</span><span class="src-str">'openid.mode'</span><span class="src-sym">]&nbsp;</span>=&nbsp;<span class="src-str">'checkid_setup'</span><span class="src-sym">;</span></div></li>
<li><div class="src-line"><a name="a769"></a>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-var">$message&nbsp;</span>=&nbsp;<span class="src-key">array</span><span class="src-sym">(</span></div></li>
<li><div class="src-line"><a name="a770"></a>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-str">'openid.mode'&nbsp;</span>=&gt;&nbsp;<span class="src-str">'id_res'</span><span class="src-sym">,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span></div></li>
<li><div class="src-line"><a name="a771"></a>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-str">'openid.user_setup_url'&nbsp;</span>=&gt;&nbsp;<a href="../simpleid/_www---common.inc.php.html#functionsimpleid_url">simpleid_url</a><span class="src-sym">(</span><span class="src-str">'continue'</span><span class="src-sym">,&nbsp;</span><span class="src-str">'s='&nbsp;</span>.&nbsp;<a href="http://www.php.net/rawurlencode">rawurlencode</a><span class="src-sym">(</span><a href="../simpleid/_www---common.inc.php.html#functionpickle">pickle</a><span class="src-sym">(</span><span class="src-var">$request</span><span class="src-sym">)))</span></div></li>
<li><div class="src-line"><a name="a772"></a>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-sym">)</span><span class="src-sym">;</span></div></li>
<li><div class="src-line"><a name="a773"></a>&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-sym">}</span></div></li>
<li><div class="src-line"><a name="a774"></a>&nbsp;&nbsp;&nbsp;&nbsp;</div></li>
<li><div class="src-line"><a name="a775"></a>&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-var">$message&nbsp;</span>=&nbsp;<a href="http://www.php.net/array_merge">array_merge</a><span class="src-sym">(</span><span class="src-var">$message</span><span class="src-sym">,&nbsp;</span><a href="../simpleid/_www---common.inc.php.html#functionextension_invoke_all">extension_invoke_all</a><span class="src-sym">(</span><span class="src-str">'response'</span><span class="src-sym">,&nbsp;</span><span class="src-id">FALSE</span><span class="src-sym">,&nbsp;</span><span class="src-var">$request</span><span class="src-sym">))</span><span class="src-sym">;</span></div></li>
<li><div class="src-line"><a name="a776"></a>&nbsp;&nbsp;&nbsp;&nbsp;</div></li>
<li><div class="src-line"><a name="a777"></a>&nbsp;&nbsp;&nbsp;&nbsp;<a href="../simpleid/_www---log.inc.php.html#functionlog_info">log_info</a><span class="src-sym">(</span><span class="src-str">'OpenID&nbsp;authentication&nbsp;response:&nbsp;'&nbsp;</span>.&nbsp;<a href="../simpleid/_www---log.inc.php.html#functionlog_array">log_array</a><span class="src-sym">(</span><span class="src-var">$message</span><span class="src-sym">))</span><span class="src-sym">;</span></div></li>
<li><div class="src-line"><a name="a778"></a>&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-key">return&nbsp;</span><a href="../simpleid/_www---openid.inc.php.html#functionopenid_indirect_message">openid_indirect_message</a><span class="src-sym">(</span><span class="src-var">$message</span><span class="src-sym">,&nbsp;</span><span class="src-var">$version</span><span class="src-sym">)</span><span class="src-sym">;</span></div></li>
<li><div class="src-line"><a name="a779"></a><span class="src-sym">}</span></div></li>
<li><div class="src-line"><a name="a780"></a>&nbsp;</div></li>
<li><div class="src-line"><a name="a781"></a><span class="src-doc">/**</span></div></li>
<li><div class="src-line"><a name="a782"></a><span class="src-doc">&nbsp;*&nbsp;Returns&nbsp;an&nbsp;OpenID&nbsp;response&nbsp;indicating&nbsp;a&nbsp;negative&nbsp;assertion&nbsp;to&nbsp;a</span></div></li>
<li><div class="src-line"><a name="a783"></a><span class="src-doc">&nbsp;*&nbsp;checkid_immediate&nbsp;request,&nbsp;where&nbsp;the&nbsp;user&nbsp;has&nbsp;not&nbsp;logged&nbsp;in.</span></div></li>
<li><div class="src-line"><a name="a784"></a><span class="src-doc">&nbsp;*</span></div></li>
<li><div class="src-line"><a name="a785"></a><span class="src-doc">&nbsp;*&nbsp;</span><span class="src-doc-coretag">@param&nbsp;</span><span class="src-doc-type">array&nbsp;</span><span class="src-doc-var">$request&nbsp;</span><span class="src-doc">the&nbsp;OpenID&nbsp;request</span></div></li>
<li><div class="src-line"><a name="a786"></a><span class="src-doc">&nbsp;*&nbsp;</span><span class="src-doc-coretag">@return&nbsp;</span><span class="src-doc-type">array&nbsp;</span><span class="src-doc">an&nbsp;OpenID&nbsp;response&nbsp;with&nbsp;a&nbsp;negative&nbsp;assertion</span></div></li>
<li><div class="src-line"><a name="a787"></a><span class="src-doc">&nbsp;*&nbsp;</span><span class="src-doc-coretag">@link</span><span class="src-doc">&nbsp;http://openid.net/specs/openid-authentication-1_1.html#anchor17,&nbsp;http://openid.net/specs/openid-authentication-1_1.html#anchor23,&nbsp;http://openid.net/specs/openid-authentication-2_0.html#negative_assertions</span></div></li>
<li><div class="src-line"><a name="a788"></a><span class="src-doc">&nbsp;*/</span></div></li>
<li><div class="src-line"><a name="a789"></a><span class="src-key">function&nbsp;</span><a href="../simpleid/_www---index.php.html#functionsimpleid_checkid_login_required">simpleid_checkid_login_required</a><span class="src-sym">(</span><span class="src-var">$request</span><span class="src-sym">)&nbsp;</span><span class="src-sym">{</span></div></li>
<li><div class="src-line"><a name="a790"></a>&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-key">global&nbsp;</span><a href="../simpleid/_www---index.php.html#global$version">$version</a><span class="src-sym">;</span></div></li>
<li><div class="src-line"><a name="a791"></a>&nbsp;&nbsp;&nbsp;&nbsp;</div></li>
<li><div class="src-line"><a name="a792"></a>&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-key">if&nbsp;</span><span class="src-sym">(</span><span class="src-var">$version&nbsp;</span>&gt;=&nbsp;<span class="src-id"><a href="../simpleid/_www---openid.inc.php.html#defineOPENID_VERSION_2">OPENID_VERSION_2</a></span><span class="src-sym">)&nbsp;</span><span class="src-sym">{</span></div></li>
<li><div class="src-line"><a name="a793"></a>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-var">$message&nbsp;</span>=&nbsp;<span class="src-key">array</span><span class="src-sym">(</span><span class="src-str">'openid.mode'&nbsp;</span>=&gt;&nbsp;<span class="src-str">'setup_needed'</span><span class="src-sym">)</span><span class="src-sym">;</span></div></li>
<li><div class="src-line"><a name="a794"></a>&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-sym">}&nbsp;</span><span class="src-key">else&nbsp;</span><span class="src-sym">{&nbsp;&nbsp;&nbsp;&nbsp;</span></div></li>
<li><div class="src-line"><a name="a795"></a>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-var">$message&nbsp;</span>=&nbsp;<span class="src-key">array</span><span class="src-sym">(</span></div></li>
<li><div class="src-line"><a name="a796"></a>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-str">'openid.mode'&nbsp;</span>=&gt;&nbsp;<span class="src-str">'id_res'</span><span class="src-sym">,</span></div></li>
<li><div class="src-line"><a name="a797"></a>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-str">'openid.user_setup_url'&nbsp;</span>=&gt;&nbsp;<a href="../simpleid/_www---common.inc.php.html#functionsimpleid_url">simpleid_url</a><span class="src-sym">(</span><span class="src-str">'login'</span><span class="src-sym">,&nbsp;</span><span class="src-str">'destination=continue&amp;s='&nbsp;</span>.&nbsp;<a href="http://www.php.net/rawurlencode">rawurlencode</a><span class="src-sym">(</span><a href="../simpleid/_www---common.inc.php.html#functionpickle">pickle</a><span class="src-sym">(</span><span class="src-var">$request</span><span class="src-sym">)))</span></div></li>
<li><div class="src-line"><a name="a798"></a>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-sym">)</span><span class="src-sym">;</span></div></li>
<li><div class="src-line"><a name="a799"></a>&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-sym">}</span></div></li>
<li><div class="src-line"><a name="a800"></a>&nbsp;&nbsp;&nbsp;&nbsp;</div></li>
<li><div class="src-line"><a name="a801"></a>&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-var">$message&nbsp;</span>=&nbsp;<a href="http://www.php.net/array_merge">array_merge</a><span class="src-sym">(</span><span class="src-var">$message</span><span class="src-sym">,&nbsp;</span><a href="../simpleid/_www---common.inc.php.html#functionextension_invoke_all">extension_invoke_all</a><span class="src-sym">(</span><span class="src-str">'response'</span><span class="src-sym">,&nbsp;</span><span class="src-id">FALSE</span><span class="src-sym">,&nbsp;</span><span class="src-var">$request</span><span class="src-sym">))</span><span class="src-sym">;</span></div></li>
<li><div class="src-line"><a name="a802"></a>&nbsp;&nbsp;&nbsp;&nbsp;</div></li>
<li><div class="src-line"><a name="a803"></a>&nbsp;&nbsp;&nbsp;&nbsp;<a href="../simpleid/_www---log.inc.php.html#functionlog_info">log_info</a><span class="src-sym">(</span><span class="src-str">'OpenID&nbsp;authentication&nbsp;response:&nbsp;'&nbsp;</span>.&nbsp;<a href="../simpleid/_www---log.inc.php.html#functionlog_array">log_array</a><span class="src-sym">(</span><span class="src-var">$message</span><span class="src-sym">))</span><span class="src-sym">;</span></div></li>
<li><div class="src-line"><a name="a804"></a>&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-key">return&nbsp;</span><a href="../simpleid/_www---openid.inc.php.html#functionopenid_indirect_message">openid_indirect_message</a><span class="src-sym">(</span><span class="src-var">$message</span><span class="src-sym">,&nbsp;</span><span class="src-var">$version</span><span class="src-sym">)</span><span class="src-sym">;</span></div></li>
<li><div class="src-line"><a name="a805"></a><span class="src-sym">}</span></div></li>
<li><div class="src-line"><a name="a806"></a>&nbsp;</div></li>
<li><div class="src-line"><a name="a807"></a><span class="src-doc">/**</span></div></li>
<li><div class="src-line"><a name="a808"></a><span class="src-doc">&nbsp;*&nbsp;Returns&nbsp;an&nbsp;OpenID&nbsp;response&nbsp;indicating&nbsp;a&nbsp;generic&nbsp;negative&nbsp;assertion.</span></div></li>
<li><div class="src-line"><a name="a809"></a><span class="src-doc">&nbsp;*</span></div></li>
<li><div class="src-line"><a name="a810"></a><span class="src-doc">&nbsp;*&nbsp;The&nbsp;content&nbsp;of&nbsp;the&nbsp;negative&nbsp;version&nbsp;depends&nbsp;on&nbsp;the&nbsp;OpenID&nbsp;version,&nbsp;and&nbsp;whether</span></div></li>
<li><div class="src-line"><a name="a811"></a><span class="src-doc">&nbsp;*&nbsp;the&nbsp;openid.mode&nbsp;of&nbsp;the&nbsp;request&nbsp;was&nbsp;checkid_immediate</span></div></li>
<li><div class="src-line"><a name="a812"></a><span class="src-doc">&nbsp;*</span></div></li>
<li><div class="src-line"><a name="a813"></a><span class="src-doc">&nbsp;*&nbsp;</span><span class="src-doc-coretag">@param&nbsp;</span><span class="src-doc-type">array&nbsp;</span><span class="src-doc-var">$request&nbsp;</span><span class="src-doc">the&nbsp;OpenID&nbsp;request</span></div></li>
<li><div class="src-line"><a name="a814"></a><span class="src-doc">&nbsp;*&nbsp;</span><span class="src-doc-coretag">@param&nbsp;</span><span class="src-doc-type">bool&nbsp;</span><span class="src-doc-var">$immediate&nbsp;</span><span class="src-doc">true&nbsp;if&nbsp;openid.mode&nbsp;of&nbsp;the&nbsp;request&nbsp;was&nbsp;checkid_immediate</span></div></li>
<li><div class="src-line"><a name="a815"></a><span class="src-doc">&nbsp;*&nbsp;</span><span class="src-doc-coretag">@return&nbsp;</span><span class="src-doc-type">array&nbsp;</span><span class="src-doc">an&nbsp;OpenID&nbsp;response&nbsp;with&nbsp;a&nbsp;negative&nbsp;assertion</span></div></li>
<li><div class="src-line"><a name="a816"></a><span class="src-doc">&nbsp;*&nbsp;</span><span class="src-doc-coretag">@link</span><span class="src-doc">&nbsp;http://openid.net/specs/openid-authentication-1_1.html#anchor17,&nbsp;http://openid.net/specs/openid-authentication-1_1.html#anchor23,&nbsp;http://openid.net/specs/openid-authentication-2_0.html#negative_assertions</span></div></li>
<li><div class="src-line"><a name="a817"></a><span class="src-doc">&nbsp;*/</span></div></li>
<li><div class="src-line"><a name="a818"></a><span class="src-key">function&nbsp;</span><a href="../simpleid/_www---index.php.html#functionsimpleid_checkid_error">simpleid_checkid_error</a><span class="src-sym">(</span><span class="src-var">$request</span><span class="src-sym">,&nbsp;</span><span class="src-var">$immediate&nbsp;</span>=&nbsp;<span class="src-id">false</span><span class="src-sym">)&nbsp;</span><span class="src-sym">{</span></div></li>
<li><div class="src-line"><a name="a819"></a>&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-key">global&nbsp;</span><a href="../simpleid/_www---index.php.html#global$version">$version</a><span class="src-sym">;</span></div></li>
<li><div class="src-line"><a name="a820"></a>&nbsp;&nbsp;&nbsp;&nbsp;</div></li>
<li><div class="src-line"><a name="a821"></a>&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-var">$message&nbsp;</span>=&nbsp;<span class="src-key">array</span><span class="src-sym">(</span><span class="src-sym">)</span><span class="src-sym">;</span></div></li>
<li><div class="src-line"><a name="a822"></a>&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-key">if&nbsp;</span><span class="src-sym">(</span><span class="src-var">$immediate</span><span class="src-sym">)&nbsp;</span><span class="src-sym">{</span></div></li>
<li><div class="src-line"><a name="a823"></a>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-key">if&nbsp;</span><span class="src-sym">(</span><span class="src-var">$version&nbsp;</span>&gt;=&nbsp;<span class="src-id"><a href="../simpleid/_www---openid.inc.php.html#defineOPENID_VERSION_2">OPENID_VERSION_2</a></span><span class="src-sym">)&nbsp;</span><span class="src-sym">{</span></div></li>
<li><div class="src-line"><a name="a824"></a>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-var">$message</span><span class="src-sym">[</span><span class="src-str">'openid.mode'</span><span class="src-sym">]&nbsp;</span>=&nbsp;<span class="src-str">'setup_needed'</span><span class="src-sym">;</span></div></li>
<li><div class="src-line"><a name="a825"></a>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-sym">}&nbsp;</span><span class="src-key">else&nbsp;</span><span class="src-sym">{</span></div></li>
<li><div class="src-line"><a name="a826"></a>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-var">$message</span><span class="src-sym">[</span><span class="src-str">'openid.mode'</span><span class="src-sym">]&nbsp;</span>=&nbsp;<span class="src-str">'id_res'</span><span class="src-sym">;</span></div></li>
<li><div class="src-line"><a name="a827"></a>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-sym">}</span></div></li>
<li><div class="src-line"><a name="a828"></a>&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-sym">}&nbsp;</span><span class="src-key">else&nbsp;</span><span class="src-sym">{</span></div></li>
<li><div class="src-line"><a name="a829"></a>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-var">$message</span><span class="src-sym">[</span><span class="src-str">'openid.mode'</span><span class="src-sym">]&nbsp;</span>=&nbsp;<span class="src-str">'cancel'</span><span class="src-sym">;</span></div></li>
<li><div class="src-line"><a name="a830"></a>&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-sym">}</span></div></li>
<li><div class="src-line"><a name="a831"></a>&nbsp;&nbsp;&nbsp;&nbsp;</div></li>
<li><div class="src-line"><a name="a832"></a>&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-var">$message&nbsp;</span>=&nbsp;<a href="http://www.php.net/array_merge">array_merge</a><span class="src-sym">(</span><span class="src-var">$message</span><span class="src-sym">,&nbsp;</span><a href="../simpleid/_www---common.inc.php.html#functionextension_invoke_all">extension_invoke_all</a><span class="src-sym">(</span><span class="src-str">'response'</span><span class="src-sym">,&nbsp;</span><span class="src-id">FALSE</span><span class="src-sym">,&nbsp;</span><span class="src-var">$request</span><span class="src-sym">))</span><span class="src-sym">;</span></div></li>
<li><div class="src-line"><a name="a833"></a>&nbsp;&nbsp;&nbsp;&nbsp;</div></li>
<li><div class="src-line"><a name="a834"></a>&nbsp;&nbsp;&nbsp;&nbsp;<a href="../simpleid/_www---log.inc.php.html#functionlog_info">log_info</a><span class="src-sym">(</span><span class="src-str">'OpenID&nbsp;authentication&nbsp;response:&nbsp;'&nbsp;</span>.&nbsp;<a href="../simpleid/_www---log.inc.php.html#functionlog_array">log_array</a><span class="src-sym">(</span><span class="src-var">$message</span><span class="src-sym">))</span><span class="src-sym">;</span></div></li>
<li><div class="src-line"><a name="a835"></a>&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-key">return&nbsp;</span><a href="../simpleid/_www---openid.inc.php.html#functionopenid_indirect_message">openid_indirect_message</a><span class="src-sym">(</span><span class="src-var">$message</span><span class="src-sym">,&nbsp;</span><span class="src-var">$version</span><span class="src-sym">)</span><span class="src-sym">;</span></div></li>
<li><div class="src-line"><a name="a836"></a><span class="src-sym">}</span></div></li>
<li><div class="src-line"><a name="a837"></a>&nbsp;</div></li>
<li><div class="src-line"><a name="a838"></a><span class="src-doc">/**</span></div></li>
<li><div class="src-line"><a name="a839"></a><span class="src-doc">&nbsp;*&nbsp;Signs&nbsp;an&nbsp;OpenID&nbsp;response,&nbsp;using&nbsp;signature&nbsp;information&nbsp;from&nbsp;an&nbsp;association</span></div></li>
<li><div class="src-line"><a name="a840"></a><span class="src-doc">&nbsp;*&nbsp;handle.</span></div></li>
<li><div class="src-line"><a name="a841"></a><span class="src-doc">&nbsp;*</span></div></li>
<li><div class="src-line"><a name="a842"></a><span class="src-doc">&nbsp;*&nbsp;</span><span class="src-doc-coretag">@param&nbsp;</span><span class="src-doc-type">array&nbsp;</span><span class="src-doc-var">&amp;$response&nbsp;</span><span class="src-doc">the&nbsp;OpenID&nbsp;response</span></div></li>
<li><div class="src-line"><a name="a843"></a><span class="src-doc">&nbsp;*&nbsp;</span><span class="src-doc-coretag">@param&nbsp;</span><span class="src-doc-type">array&nbsp;</span><span class="src-doc-var">$assoc_handle&nbsp;</span><span class="src-doc">the&nbsp;association&nbsp;handle&nbsp;containing&nbsp;key&nbsp;information</span></div></li>
<li><div class="src-line"><a name="a844"></a><span class="src-doc">&nbsp;*&nbsp;&nbsp;for&nbsp;the&nbsp;signature.&nbsp;&nbsp;If&nbsp;$assoc_handle&nbsp;is&nbsp;not&nbsp;specified,&nbsp;a&nbsp;private&nbsp;association</span></div></li>
<li><div class="src-line"><a name="a845"></a><span class="src-doc">&nbsp;*&nbsp;&nbsp;is&nbsp;created</span></div></li>
<li><div class="src-line"><a name="a846"></a><span class="src-doc">&nbsp;*&nbsp;</span><span class="src-doc-coretag">@return&nbsp;</span><span class="src-doc-type">array&nbsp;</span><span class="src-doc">the&nbsp;signed&nbsp;OpenID&nbsp;response</span></div></li>
<li><div class="src-line"><a name="a847"></a><span class="src-doc">&nbsp;*</span></div></li>
<li><div class="src-line"><a name="a848"></a><span class="src-doc">&nbsp;*/</span></div></li>
<li><div class="src-line"><a name="a849"></a><span class="src-key">function&nbsp;</span><a href="../simpleid/_www---index.php.html#functionsimpleid_sign">simpleid_sign</a><span class="src-sym">(</span><span class="src-sym">&amp;</span><span class="src-var">$response</span><span class="src-sym">,&nbsp;</span><span class="src-var">$assoc_handle&nbsp;</span>=&nbsp;<span class="src-id">NULL</span><span class="src-sym">)&nbsp;</span><span class="src-sym">{</span></div></li>
<li><div class="src-line"><a name="a850"></a>&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-key">global&nbsp;</span><a href="../simpleid/_www---index.php.html#global$version">$version</a><span class="src-sym">;</span></div></li>
<li><div class="src-line"><a name="a851"></a>&nbsp;&nbsp;&nbsp;&nbsp;</div></li>
<li><div class="src-line"><a name="a852"></a>&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-key">if&nbsp;</span><span class="src-sym">(</span><span class="src-sym">!</span><span class="src-var">$assoc_handle</span><span class="src-sym">)&nbsp;</span><span class="src-sym">{</span></div></li>
<li><div class="src-line"><a name="a853"></a>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-var">$assoc&nbsp;</span>=&nbsp;<a href="../simpleid/_www---index.php.html#function_simpleid_create_association">_simpleid_create_association</a><span class="src-sym">(</span><span class="src-id"><a href="../simpleid/_www---index.php.html#defineASSOCIATION_PRIVATE">ASSOCIATION_PRIVATE</a></span><span class="src-sym">)</span><span class="src-sym">;</span></div></li>
<li><div class="src-line"><a name="a854"></a>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-var">$response</span><span class="src-sym">[</span><span class="src-str">'openid.assoc_handle'</span><span class="src-sym">]&nbsp;</span>=&nbsp;<span class="src-var">$assoc</span><span class="src-sym">[</span><span class="src-str">'assoc_handle'</span><span class="src-sym">]</span><span class="src-sym">;</span></div></li>
<li><div class="src-line"><a name="a855"></a>&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-sym">}&nbsp;</span><span class="src-key">else&nbsp;</span><span class="src-sym">{</span></div></li>
<li><div class="src-line"><a name="a856"></a>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-var">$assoc&nbsp;</span>=&nbsp;<a href="../simpleid/_www---cache.inc.php.html#functioncache_get">cache_get</a><span class="src-sym">(</span><span class="src-str">'association'</span><span class="src-sym">,&nbsp;</span><span class="src-var">$assoc_handle</span><span class="src-sym">)</span><span class="src-sym">;</span></div></li>
<li><div class="src-line"><a name="a857"></a>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</div></li>
<li><div class="src-line"><a name="a858"></a>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-key">if&nbsp;</span><span class="src-sym">(</span><span class="src-var">$assoc</span><span class="src-sym">[</span><span class="src-str">'created'</span><span class="src-sym">]&nbsp;</span>+&nbsp;<span class="src-id"><a href="../simpleid/_www---config.php.dist.html#defineSIMPLEID_ASSOC_EXPIRES_IN">SIMPLEID_ASSOC_EXPIRES_IN</a>&nbsp;</span>&lt;&nbsp;<a href="http://www.php.net/time">time</a><span class="src-sym">(</span><span class="src-sym">))&nbsp;</span><span class="src-sym">{</span></div></li>
<li><div class="src-line"><a name="a859"></a>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-comm">//&nbsp;Association&nbsp;has&nbsp;expired,&nbsp;need&nbsp;to&nbsp;create&nbsp;a&nbsp;new&nbsp;one</span></div></li>
<li><div class="src-line"><a name="a860"></a>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a href="../simpleid/_www---log.inc.php.html#functionlog_notice">log_notice</a><span class="src-sym">(</span><span class="src-str">'Association&nbsp;handle&nbsp;'&nbsp;</span>.&nbsp;<span class="src-var">$assoc</span><span class="src-sym">[</span><span class="src-str">'assoc_handle'</span><span class="src-sym">]&nbsp;</span>.&nbsp;<span class="src-str">'&nbsp;expired.&nbsp;&nbsp;Using&nbsp;stateless&nbsp;mode.'</span><span class="src-sym">)</span><span class="src-sym">;</span></div></li>
<li><div class="src-line"><a name="a861"></a>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-var">$response</span><span class="src-sym">[</span><span class="src-str">'openid.invalidate_handle'</span><span class="src-sym">]&nbsp;</span>=&nbsp;<span class="src-var">$assoc_handle</span><span class="src-sym">;</span></div></li>
<li><div class="src-line"><a name="a862"></a>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-var">$assoc&nbsp;</span>=&nbsp;<a href="../simpleid/_www---index.php.html#function_simpleid_create_association">_simpleid_create_association</a><span class="src-sym">(</span><span class="src-id"><a href="../simpleid/_www---index.php.html#defineASSOCIATION_PRIVATE">ASSOCIATION_PRIVATE</a></span><span class="src-sym">)</span><span class="src-sym">;</span></div></li>
<li><div class="src-line"><a name="a863"></a>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-var">$response</span><span class="src-sym">[</span><span class="src-str">'openid.assoc_handle'</span><span class="src-sym">]&nbsp;</span>=&nbsp;<span class="src-var">$assoc</span><span class="src-sym">[</span><span class="src-str">'assoc_handle'</span><span class="src-sym">]</span><span class="src-sym">;</span></div></li>
<li><div class="src-line"><a name="a864"></a>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-sym">}</span></div></li>
<li><div class="src-line"><a name="a865"></a>&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-sym">}</span></div></li>
<li><div class="src-line"><a name="a866"></a>&nbsp;&nbsp;&nbsp;&nbsp;</div></li>
<li><div class="src-line"><a name="a867"></a>&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-comm">//&nbsp;If&nbsp;we&nbsp;are&nbsp;using&nbsp;stateless&nbsp;mode,&nbsp;then&nbsp;we&nbsp;need&nbsp;to&nbsp;cache&nbsp;the&nbsp;response_nonce</span></div></li>
<li><div class="src-line"><a name="a868"></a>&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-comm">//&nbsp;so&nbsp;that&nbsp;the&nbsp;RP&nbsp;can&nbsp;only&nbsp;verify&nbsp;once</span></div></li>
<li><div class="src-line"><a name="a869"></a>&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-key">if&nbsp;</span><span class="src-sym">(</span>isset<span class="src-sym">(</span><span class="src-var">$assoc</span><span class="src-sym">[</span><span class="src-str">'private'</span><span class="src-sym">]</span><span class="src-sym">)&nbsp;</span>&amp;&amp;&nbsp;<span class="src-sym">(</span><span class="src-var">$assoc</span><span class="src-sym">[</span><span class="src-str">'private'</span><span class="src-sym">]&nbsp;</span>==&nbsp;<span class="src-num">1</span><span class="src-sym">)&nbsp;</span>&amp;&amp;&nbsp;isset<span class="src-sym">(</span><span class="src-var">$response</span><span class="src-sym">[</span><span class="src-str">'openid.response_nonce'</span><span class="src-sym">]</span><span class="src-sym">))&nbsp;</span><span class="src-sym">{</span></div></li>
<li><div class="src-line"><a name="a870"></a>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a href="../simpleid/_www---cache.inc.php.html#functioncache_set">cache_set</a><span class="src-sym">(</span><span class="src-str">'stateless'</span><span class="src-sym">,&nbsp;</span><span class="src-var">$response</span><span class="src-sym">[</span><span class="src-str">'openid.response_nonce'</span><span class="src-sym">]</span><span class="src-sym">,&nbsp;</span><span class="src-key">array</span><span class="src-sym">(</span></div></li>
<li><div class="src-line"><a name="a871"></a>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-str">'response_nonce'&nbsp;</span>=&gt;&nbsp;<span class="src-var">$response</span><span class="src-sym">[</span><span class="src-str">'openid.response_nonce'</span><span class="src-sym">]</span><span class="src-sym">,</span></div></li>
<li><div class="src-line"><a name="a872"></a>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-str">'assoc_handle'&nbsp;</span>=&gt;&nbsp;<span class="src-var">$response</span><span class="src-sym">[</span><span class="src-str">'openid.assoc_handle'</span><span class="src-sym">]</span><span class="src-sym">))</span><span class="src-sym">;</span></div></li>
<li><div class="src-line"><a name="a873"></a>&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-sym">}</span></div></li>
<li><div class="src-line"><a name="a874"></a>&nbsp;&nbsp;&nbsp;&nbsp;</div></li>
<li><div class="src-line"><a name="a875"></a>&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-comm">//&nbsp;Get&nbsp;all&nbsp;the&nbsp;signed&nbsp;fields&nbsp;[10.1]</span></div></li>
<li><div class="src-line"><a name="a876"></a>&nbsp;&nbsp;&nbsp;&nbsp;<a href="../simpleid/_www---openid.inc.php.html#functionopenid_parse_request">openid_parse_request</a><span class="src-sym">(</span><span class="src-var">$response</span><span class="src-sym">)</span><span class="src-sym">;&nbsp;</span><span class="src-comm">//&nbsp;Fill&nbsp;the&nbsp;namespace&nbsp;array</span></div></li>
<li><div class="src-line"><a name="a877"></a>&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-var">$signed_fields&nbsp;</span>=&nbsp;<span class="src-key">array</span><span class="src-sym">(</span><span class="src-str">'op_endpoint'</span><span class="src-sym">,&nbsp;</span><span class="src-str">'return_to'</span><span class="src-sym">,&nbsp;</span><span class="src-str">'response_nonce'</span><span class="src-sym">,&nbsp;</span><span class="src-str">'assoc_handle'</span><span class="src-sym">,&nbsp;</span><span class="src-str">'identity'</span><span class="src-sym">,&nbsp;</span><span class="src-str">'claimed_id'</span><span class="src-sym">)</span><span class="src-sym">;</span></div></li>
<li><div class="src-line"><a name="a878"></a>&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-var">$signed_fields&nbsp;</span>=&nbsp;<a href="http://www.php.net/array_merge">array_merge</a><span class="src-sym">(</span><span class="src-var">$signed_fields</span><span class="src-sym">,&nbsp;</span><a href="../simpleid/_www---common.inc.php.html#functionextension_invoke_all">extension_invoke_all</a><span class="src-sym">(</span><span class="src-str">'signed_fields'</span><span class="src-sym">,&nbsp;</span><span class="src-var">$response</span><span class="src-sym">))</span><span class="src-sym">;</span></div></li>
<li><div class="src-line"><a name="a879"></a>&nbsp;&nbsp;&nbsp;&nbsp;</div></li>
<li><div class="src-line"><a name="a880"></a>&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-comm">//&nbsp;Check&nbsp;if&nbsp;the&nbsp;signed&nbsp;keys&nbsp;are&nbsp;actually&nbsp;present</span></div></li>
<li><div class="src-line"><a name="a881"></a>&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-var">$to_sign&nbsp;</span>=&nbsp;<span class="src-key">array</span><span class="src-sym">(</span><span class="src-sym">)</span><span class="src-sym">;</span></div></li>
<li><div class="src-line"><a name="a882"></a>&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-key">foreach&nbsp;</span><span class="src-sym">(</span><span class="src-var">$signed_fields&nbsp;</span><span class="src-key">as&nbsp;</span><span class="src-var">$field</span><span class="src-sym">)&nbsp;</span><span class="src-sym">{</span></div></li>
<li><div class="src-line"><a name="a883"></a>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-key">if&nbsp;</span><span class="src-sym">(</span>isset<span class="src-sym">(</span><span class="src-var">$response</span><span class="src-sym">[</span><span class="src-str">'openid.'&nbsp;</span>.&nbsp;<span class="src-var">$field</span><span class="src-sym">]</span><span class="src-sym">))&nbsp;</span><span class="src-var">$to_sign</span><span class="src-sym">[</span><span class="src-sym">]&nbsp;</span>=&nbsp;<span class="src-var">$field</span><span class="src-sym">;</span></div></li>
<li><div class="src-line"><a name="a884"></a>&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-sym">}</span></div></li>
<li><div class="src-line"><a name="a885"></a>&nbsp;&nbsp;&nbsp;&nbsp;</div></li>
<li><div class="src-line"><a name="a886"></a>&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-var">$response</span><span class="src-sym">[</span><span class="src-str">'openid.signed'</span><span class="src-sym">]&nbsp;</span>=&nbsp;<a href="http://www.php.net/implode">implode</a><span class="src-sym">(</span><span class="src-str">','</span><span class="src-sym">,&nbsp;</span><span class="src-var">$to_sign</span><span class="src-sym">)</span><span class="src-sym">;</span></div></li>
<li><div class="src-line"><a name="a887"></a>&nbsp;&nbsp;</div></li>
<li><div class="src-line"><a name="a888"></a>&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-comm">//&nbsp;Generate&nbsp;signature&nbsp;for&nbsp;this&nbsp;message</span></div></li>
<li><div class="src-line"><a name="a889"></a>&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-var">$mac_key&nbsp;</span>=&nbsp;<span class="src-var">$assoc</span><span class="src-sym">[</span><span class="src-str">'mac_key'</span><span class="src-sym">]</span><span class="src-sym">;</span></div></li>
<li><div class="src-line"><a name="a890"></a>&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-var">$assoc_types&nbsp;</span>=&nbsp;<a href="../simpleid/_www---openid.inc.php.html#functionopenid_association_types">openid_association_types</a><span class="src-sym">(</span><span class="src-sym">)</span><span class="src-sym">;</span></div></li>
<li><div class="src-line"><a name="a891"></a>&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-var">$hmac_func&nbsp;</span>=&nbsp;<span class="src-var">$assoc_types</span><span class="src-sym">[</span><span class="src-var">$assoc</span><span class="src-sym">[</span><span class="src-str">'assoc_type'</span><span class="src-sym">]]</span><span class="src-sym">[</span><span class="src-str">'hmac_func'</span><span class="src-sym">]</span><span class="src-sym">;</span></div></li>
<li><div class="src-line"><a name="a892"></a>&nbsp;&nbsp;&nbsp;&nbsp;</div></li>
<li><div class="src-line"><a name="a893"></a>&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-var">$response</span><span class="src-sym">[</span><span class="src-str">'openid.sig'</span><span class="src-sym">]&nbsp;</span>=&nbsp;<a href="../simpleid/_www---openid.inc.php.html#functionopenid_sign">openid_sign</a><span class="src-sym">(</span><span class="src-var">$response</span><span class="src-sym">,&nbsp;</span><span class="src-var">$to_sign</span><span class="src-sym">,&nbsp;</span><span class="src-var">$mac_key</span><span class="src-sym">,&nbsp;</span><span class="src-var">$hmac_func</span><span class="src-sym">,&nbsp;</span><span class="src-var">$version</span><span class="src-sym">)</span><span class="src-sym">;</span></div></li>
<li><div class="src-line"><a name="a894"></a>&nbsp;&nbsp;&nbsp;&nbsp;</div></li>
<li><div class="src-line"><a name="a895"></a>&nbsp;&nbsp;&nbsp;&nbsp;<a href="../simpleid/_www---log.inc.php.html#functionlog_info">log_info</a><span class="src-sym">(</span><span class="src-str">'OpenID&nbsp;signed&nbsp;authentication&nbsp;response:&nbsp;'&nbsp;</span>.&nbsp;<a href="../simpleid/_www---log.inc.php.html#functionlog_array">log_array</a><span class="src-sym">(</span><span class="src-var">$response</span><span class="src-sym">))</span><span class="src-sym">;</span></div></li>
<li><div class="src-line"><a name="a896"></a>&nbsp;&nbsp;&nbsp;&nbsp;</div></li>
<li><div class="src-line"><a name="a897"></a>&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-key">return&nbsp;</span><span class="src-var">$response</span><span class="src-sym">;</span></div></li>
<li><div class="src-line"><a name="a898"></a><span class="src-sym">}</span></div></li>
<li><div class="src-line"><a name="a899"></a>&nbsp;</div></li>
<li><div class="src-line"><a name="a900"></a><span class="src-doc">/**</span></div></li>
<li><div class="src-line"><a name="a901"></a><span class="src-doc">&nbsp;*&nbsp;Processes&nbsp;a&nbsp;direct&nbsp;verification&nbsp;request.&nbsp;&nbsp;This&nbsp;is&nbsp;used&nbsp;in&nbsp;the&nbsp;OpenID&nbsp;specification</span></div></li>
<li><div class="src-line"><a name="a902"></a><span class="src-doc">&nbsp;*&nbsp;to&nbsp;verify&nbsp;signatures&nbsp;generated&nbsp;using&nbsp;stateless&nbsp;mode.</span></div></li>
<li><div class="src-line"><a name="a903"></a><span class="src-doc">&nbsp;*</span></div></li>
<li><div class="src-line"><a name="a904"></a><span class="src-doc">&nbsp;*&nbsp;</span><span class="src-doc-coretag">@param&nbsp;</span><span class="src-doc-type">array&nbsp;</span><span class="src-doc-var">$request&nbsp;</span><span class="src-doc">the&nbsp;OpenID&nbsp;request</span></div></li>
<li><div class="src-line"><a name="a905"></a><span class="src-doc">&nbsp;*&nbsp;</span><span class="src-doc-coretag">@see</span><span class="src-doc">&nbsp;http://openid.net/specs/openid-authentication-1_1.html#mode_check_authentication,&nbsp;http://openid.net/specs/openid-authentication-2_0.html#verifying_signatures</span></div></li>
<li><div class="src-line"><a name="a906"></a><span class="src-doc">&nbsp;*/</span></div></li>
<li><div class="src-line"><a name="a907"></a><span class="src-key">function&nbsp;</span><a href="../simpleid/_www---index.php.html#functionsimpleid_check_authentication">simpleid_check_authentication</a><span class="src-sym">(</span><span class="src-var">$request</span><span class="src-sym">)&nbsp;</span><span class="src-sym">{</span></div></li>
<li><div class="src-line"><a name="a908"></a>&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-key">global&nbsp;</span><a href="../simpleid/_www---index.php.html#global$version">$version</a><span class="src-sym">;</span></div></li>
<li><div class="src-line"><a name="a909"></a>&nbsp;&nbsp;&nbsp;&nbsp;</div></li>
<li><div class="src-line"><a name="a910"></a>&nbsp;&nbsp;&nbsp;&nbsp;<a href="../simpleid/_www---log.inc.php.html#functionlog_info">log_info</a><span class="src-sym">(</span><span class="src-str">'OpenID&nbsp;direct&nbsp;verification:&nbsp;'&nbsp;</span>.&nbsp;<a href="../simpleid/_www---log.inc.php.html#functionlog_array">log_array</a><span class="src-sym">(</span><span class="src-var">$request</span><span class="src-sym">))</span><span class="src-sym">;</span></div></li>
<li><div class="src-line"><a name="a911"></a>&nbsp;&nbsp;&nbsp;&nbsp;</div></li>
<li><div class="src-line"><a name="a912"></a>&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-var">$is_valid&nbsp;</span>=&nbsp;<a href="../simpleid/_www---index.php.html#functionsimpleid_verify_signatures">simpleid_verify_signatures</a><span class="src-sym">(</span><span class="src-var">$request</span><span class="src-sym">)</span><span class="src-sym">;</span></div></li>
<li><div class="src-line"><a name="a913"></a>&nbsp;</div></li>
<li><div class="src-line"><a name="a914"></a>&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-key">if&nbsp;</span><span class="src-sym">(</span><span class="src-var">$is_valid</span><span class="src-sym">)&nbsp;</span><span class="src-sym">{</span></div></li>
<li><div class="src-line"><a name="a915"></a>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-var">$response&nbsp;</span>=&nbsp;<span class="src-key">array</span><span class="src-sym">(</span><span class="src-str">'is_valid'&nbsp;</span>=&gt;&nbsp;<span class="src-str">'true'</span><span class="src-sym">)</span><span class="src-sym">;</span></div></li>
<li><div class="src-line"><a name="a916"></a>&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-sym">}&nbsp;</span><span class="src-key">else&nbsp;</span><span class="src-sym">{</span></div></li>
<li><div class="src-line"><a name="a917"></a>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-var">$response&nbsp;</span>=&nbsp;<span class="src-key">array</span><span class="src-sym">(</span><span class="src-str">'is_valid'&nbsp;</span>=&gt;&nbsp;<span class="src-str">'false'</span><span class="src-sym">)</span><span class="src-sym">;</span></div></li>
<li><div class="src-line"><a name="a918"></a>&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-sym">}</span></div></li>
<li><div class="src-line"><a name="a919"></a>&nbsp;&nbsp;&nbsp;&nbsp;</div></li>
<li><div class="src-line"><a name="a920"></a>&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-comm">//&nbsp;RP&nbsp;wants&nbsp;to&nbsp;check&nbsp;whether&nbsp;a&nbsp;handle&nbsp;is&nbsp;invalid</span></div></li>
<li><div class="src-line"><a name="a921"></a>&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-key">if&nbsp;</span><span class="src-sym">(</span>isset<span class="src-sym">(</span><span class="src-var">$request</span><span class="src-sym">[</span><span class="src-str">'openid.invalidate_handle'</span><span class="src-sym">]</span><span class="src-sym">))&nbsp;</span><span class="src-sym">{</span></div></li>
<li><div class="src-line"><a name="a922"></a>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-var">$invalid_assoc&nbsp;</span>=&nbsp;<a href="../simpleid/_www---cache.inc.php.html#functioncache_get">cache_get</a><span class="src-sym">(</span><span class="src-str">'association'</span><span class="src-sym">,&nbsp;</span><span class="src-var">$request</span><span class="src-sym">[</span><span class="src-str">'openid.invalidate_handle'</span><span class="src-sym">]</span><span class="src-sym">)</span><span class="src-sym">;</span></div></li>
<li><div class="src-line"><a name="a923"></a>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</div></li>
<li><div class="src-line"><a name="a924"></a>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-key">if&nbsp;</span><span class="src-sym">(</span><span class="src-sym">!</span><span class="src-var">$invalid_assoc&nbsp;</span>||&nbsp;<span class="src-sym">(</span><span class="src-var">$invalid_assoc</span><span class="src-sym">[</span><span class="src-str">'created'</span><span class="src-sym">]&nbsp;</span>+&nbsp;<span class="src-id"><a href="../simpleid/_www---config.php.dist.html#defineSIMPLEID_ASSOC_EXPIRES_IN">SIMPLEID_ASSOC_EXPIRES_IN</a>&nbsp;</span>&lt;&nbsp;<a href="http://www.php.net/time">time</a><span class="src-sym">(</span><span class="src-sym">)))&nbsp;</span><span class="src-sym">{</span></div></li>
<li><div class="src-line"><a name="a925"></a>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-comm">//&nbsp;Yes,&nbsp;it's&nbsp;invalid</span></div></li>
<li><div class="src-line"><a name="a926"></a>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-var">$response</span><span class="src-sym">[</span><span class="src-str">'invalidate_handle'</span><span class="src-sym">]&nbsp;</span>=&nbsp;<span class="src-var">$request</span><span class="src-sym">[</span><span class="src-str">'openid.invalidate_handle'</span><span class="src-sym">]</span><span class="src-sym">;</span></div></li>
<li><div class="src-line"><a name="a927"></a>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-sym">}</span></div></li>
<li><div class="src-line"><a name="a928"></a>&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-sym">}</span></div></li>
<li><div class="src-line"><a name="a929"></a>&nbsp;</div></li>
<li><div class="src-line"><a name="a930"></a>&nbsp;&nbsp;&nbsp;&nbsp;<a href="../simpleid/_www---log.inc.php.html#functionlog_info">log_info</a><span class="src-sym">(</span><span class="src-str">'OpenID&nbsp;direct&nbsp;verification&nbsp;response:&nbsp;'&nbsp;</span>.&nbsp;<a href="../simpleid/_www---log.inc.php.html#functionlog_array">log_array</a><span class="src-sym">(</span><span class="src-var">$response</span><span class="src-sym">))</span><span class="src-sym">;</span></div></li>
<li><div class="src-line"><a name="a931"></a>&nbsp;&nbsp;&nbsp;&nbsp;</div></li>
<li><div class="src-line"><a name="a932"></a>&nbsp;&nbsp;&nbsp;&nbsp;<a href="../simpleid/_www---openid.inc.php.html#functionopenid_direct_response">openid_direct_response</a><span class="src-sym">(</span><a href="../simpleid/_www---openid.inc.php.html#functionopenid_direct_message">openid_direct_message</a><span class="src-sym">(</span><span class="src-var">$response</span><span class="src-sym">,&nbsp;</span><span class="src-var">$version</span><span class="src-sym">))</span><span class="src-sym">;</span></div></li>
<li><div class="src-line"><a name="a933"></a><span class="src-sym">}</span></div></li>
<li><div class="src-line"><a name="a934"></a>&nbsp;</div></li>
<li><div class="src-line"><a name="a935"></a><span class="src-doc">/**</span></div></li>
<li><div class="src-line"><a name="a936"></a><span class="src-doc">&nbsp;*&nbsp;Verifies&nbsp;the&nbsp;signature&nbsp;of&nbsp;a&nbsp;signed&nbsp;OpenID&nbsp;request/response.</span></div></li>
<li><div class="src-line"><a name="a937"></a><span class="src-doc">&nbsp;*</span></div></li>
<li><div class="src-line"><a name="a938"></a><span class="src-doc">&nbsp;*&nbsp;</span><span class="src-doc-coretag">@param&nbsp;</span><span class="src-doc-type">array&nbsp;</span><span class="src-doc-var">$request&nbsp;</span><span class="src-doc">the&nbsp;OpenID&nbsp;request/response</span></div></li>
<li><div class="src-line"><a name="a939"></a><span class="src-doc">&nbsp;*&nbsp;</span><span class="src-doc-coretag">@return&nbsp;</span><span class="src-doc-type">bool&nbsp;</span><span class="src-doc">true&nbsp;if&nbsp;the&nbsp;signature&nbsp;is&nbsp;verified</span></div></li>
<li><div class="src-line"><a name="a940"></a><span class="src-doc">&nbsp;*&nbsp;</span><span class="src-doc-coretag">@since</span><span class="src-doc">&nbsp;0.8</span></div></li>
<li><div class="src-line"><a name="a941"></a><span class="src-doc">&nbsp;*/</span></div></li>
<li><div class="src-line"><a name="a942"></a><span class="src-key">function&nbsp;</span><a href="../simpleid/_www---index.php.html#functionsimpleid_verify_signatures">simpleid_verify_signatures</a><span class="src-sym">(</span><span class="src-var">$request</span><span class="src-sym">)&nbsp;</span><span class="src-sym">{</span></div></li>
<li><div class="src-line"><a name="a943"></a>&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-key">global&nbsp;</span><a href="../simpleid/_www---index.php.html#global$version">$version</a><span class="src-sym">;</span></div></li>
<li><div class="src-line"><a name="a944"></a>&nbsp;&nbsp;&nbsp;&nbsp;</div></li>
<li><div class="src-line"><a name="a945"></a>&nbsp;&nbsp;&nbsp;&nbsp;<a href="../simpleid/_www---log.inc.php.html#functionlog_info">log_info</a><span class="src-sym">(</span><span class="src-str">'simpleid_verify_signatures'</span><span class="src-sym">)</span><span class="src-sym">;</span></div></li>
<li><div class="src-line"><a name="a946"></a>&nbsp;&nbsp;&nbsp;&nbsp;</div></li>
<li><div class="src-line"><a name="a947"></a>&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-var">$is_valid&nbsp;</span>=&nbsp;<span class="src-id">TRUE</span><span class="src-sym">;</span></div></li>
<li><div class="src-line"><a name="a948"></a>&nbsp;&nbsp;</div></li>
<li><div class="src-line"><a name="a949"></a>&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-var">$assoc&nbsp;</span>=&nbsp;<span class="src-sym">(</span>isset<span class="src-sym">(</span><span class="src-var">$request</span><span class="src-sym">[</span><span class="src-str">'openid.assoc_handle'</span><span class="src-sym">]</span><span class="src-sym">))&nbsp;</span>?&nbsp;<a href="../simpleid/_www---cache.inc.php.html#functioncache_get">cache_get</a><span class="src-sym">(</span><span class="src-str">'association'</span><span class="src-sym">,&nbsp;</span><span class="src-var">$request</span><span class="src-sym">[</span><span class="src-str">'openid.assoc_handle'</span><span class="src-sym">]</span><span class="src-sym">)&nbsp;</span>:&nbsp;<span class="src-id">NULL</span><span class="src-sym">;</span></div></li>
<li><div class="src-line"><a name="a950"></a>&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-var">$stateless&nbsp;</span>=&nbsp;<span class="src-sym">(</span>isset<span class="src-sym">(</span><span class="src-var">$request</span><span class="src-sym">[</span><span class="src-str">'openid.response_nonce'</span><span class="src-sym">]</span><span class="src-sym">))&nbsp;</span>?&nbsp;<a href="../simpleid/_www---cache.inc.php.html#functioncache_get">cache_get</a><span class="src-sym">(</span><span class="src-str">'stateless'</span><span class="src-sym">,&nbsp;</span><span class="src-var">$request</span><span class="src-sym">[</span><span class="src-str">'openid.response_nonce'</span><span class="src-sym">]</span><span class="src-sym">)&nbsp;</span>:&nbsp;<span class="src-id">NULL</span><span class="src-sym">;</span></div></li>
<li><div class="src-line"><a name="a951"></a>&nbsp;&nbsp;</div></li>
<li><div class="src-line"><a name="a952"></a>&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-key">if&nbsp;</span><span class="src-sym">(</span><span class="src-sym">!</span><span class="src-var">$assoc</span><span class="src-sym">)&nbsp;</span><span class="src-sym">{</span></div></li>
<li><div class="src-line"><a name="a953"></a>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a href="../simpleid/_www---log.inc.php.html#functionlog_notice">log_notice</a><span class="src-sym">(</span><span class="src-str">'simpleid_verify_signatures:&nbsp;Association&nbsp;not&nbsp;found.'</span><span class="src-sym">)</span><span class="src-sym">;</span></div></li>
<li><div class="src-line"><a name="a954"></a>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-var">$is_valid&nbsp;</span>=&nbsp;<span class="src-id">FALSE</span><span class="src-sym">;</span></div></li>
<li><div class="src-line"><a name="a955"></a>&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-sym">}&nbsp;</span><span class="src-key">elseif&nbsp;</span><span class="src-sym">(</span><span class="src-sym">!</span><span class="src-var">$assoc</span><span class="src-sym">[</span><span class="src-str">'assoc_type'</span><span class="src-sym">]</span><span class="src-sym">)&nbsp;</span><span class="src-sym">{</span></div></li>
<li><div class="src-line"><a name="a956"></a>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a href="../simpleid/_www---log.inc.php.html#functionlog_error">log_error</a><span class="src-sym">(</span><span class="src-str">'simpleid_verify_signatures:&nbsp;Association&nbsp;does&nbsp;not&nbsp;contain&nbsp;valid&nbsp;assoc_type.'</span><span class="src-sym">)</span><span class="src-sym">;</span></div></li>
<li><div class="src-line"><a name="a957"></a>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-var">$is_valid&nbsp;</span>=&nbsp;<span class="src-id">FALSE</span><span class="src-sym">;</span></div></li>
<li><div class="src-line"><a name="a958"></a>&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-sym">}&nbsp;</span><span class="src-key">elseif&nbsp;</span><span class="src-sym">(</span><span class="src-sym">!</span>isset<span class="src-sym">(</span><span class="src-var">$assoc</span><span class="src-sym">[</span><span class="src-str">'private'</span><span class="src-sym">]</span><span class="src-sym">)&nbsp;</span>||&nbsp;<span class="src-sym">(</span><span class="src-var">$assoc</span><span class="src-sym">[</span><span class="src-str">'private'</span><span class="src-sym">]&nbsp;</span>!=&nbsp;<span class="src-num">1</span><span class="src-sym">))&nbsp;</span><span class="src-sym">{</span></div></li>
<li><div class="src-line"><a name="a959"></a>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a href="../simpleid/_www---log.inc.php.html#functionlog_warn">log_warn</a><span class="src-sym">(</span><span class="src-str">'simpleid_verify_signatures:&nbsp;Attempting&nbsp;to&nbsp;verify&nbsp;an&nbsp;association&nbsp;with&nbsp;a&nbsp;shared&nbsp;key.'</span><span class="src-sym">)</span><span class="src-sym">;</span></div></li>
<li><div class="src-line"><a name="a960"></a>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-var">$is_valid&nbsp;</span>=&nbsp;<span class="src-id">FALSE</span><span class="src-sym">;</span></div></li>
<li><div class="src-line"><a name="a961"></a>&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-sym">}&nbsp;</span><span class="src-key">elseif&nbsp;</span><span class="src-sym">(</span><span class="src-sym">!</span><span class="src-var">$stateless&nbsp;</span>||&nbsp;<span class="src-sym">(</span><span class="src-var">$stateless</span><span class="src-sym">[</span><span class="src-str">'assoc_handle'</span><span class="src-sym">]&nbsp;</span>!=&nbsp;<span class="src-var">$request</span><span class="src-sym">[</span><span class="src-str">'openid.assoc_handle'</span><span class="src-sym">]</span><span class="src-sym">))&nbsp;</span><span class="src-sym">{</span></div></li>
<li><div class="src-line"><a name="a962"></a>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a href="../simpleid/_www---log.inc.php.html#functionlog_warn">log_warn</a><span class="src-sym">(</span><span class="src-str">'simpleid_verify_signatures:&nbsp;Attempting&nbsp;to&nbsp;verify&nbsp;a&nbsp;response_nonce&nbsp;more&nbsp;than&nbsp;once,&nbsp;or&nbsp;private&nbsp;association&nbsp;expired.'</span><span class="src-sym">)</span><span class="src-sym">;</span></div></li>
<li><div class="src-line"><a name="a963"></a>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-var">$is_valid&nbsp;</span>=&nbsp;<span class="src-id">FALSE</span><span class="src-sym">;</span></div></li>
<li><div class="src-line"><a name="a964"></a>&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-sym">}&nbsp;</span><span class="src-key">else&nbsp;</span><span class="src-sym">{</span></div></li>
<li><div class="src-line"><a name="a965"></a>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-var">$mac_key&nbsp;</span>=&nbsp;<span class="src-var">$assoc</span><span class="src-sym">[</span><span class="src-str">'mac_key'</span><span class="src-sym">]</span><span class="src-sym">;</span></div></li>
<li><div class="src-line"><a name="a966"></a>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-var">$assoc_types&nbsp;</span>=&nbsp;<a href="../simpleid/_www---openid.inc.php.html#functionopenid_association_types">openid_association_types</a><span class="src-sym">(</span><span class="src-sym">)</span><span class="src-sym">;</span></div></li>
<li><div class="src-line"><a name="a967"></a>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-var">$hmac_func&nbsp;</span>=&nbsp;<span class="src-var">$assoc_types</span><span class="src-sym">[</span><span class="src-var">$assoc</span><span class="src-sym">[</span><span class="src-str">'assoc_type'</span><span class="src-sym">]]</span><span class="src-sym">[</span><span class="src-str">'hmac_func'</span><span class="src-sym">]</span><span class="src-sym">;</span></div></li>
<li><div class="src-line"><a name="a968"></a>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</div></li>
<li><div class="src-line"><a name="a969"></a>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-var">$signed_keys&nbsp;</span>=&nbsp;<a href="http://www.php.net/explode">explode</a><span class="src-sym">(</span><span class="src-str">','</span><span class="src-sym">,&nbsp;</span><span class="src-var">$request</span><span class="src-sym">[</span><span class="src-str">'openid.signed'</span><span class="src-sym">]</span><span class="src-sym">)</span><span class="src-sym">;</span></div></li>
<li><div class="src-line"><a name="a970"></a>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-var">$signature&nbsp;</span>=&nbsp;<a href="../simpleid/_www---openid.inc.php.html#functionopenid_sign">openid_sign</a><span class="src-sym">(</span><span class="src-var">$request</span><span class="src-sym">,&nbsp;</span><span class="src-var">$signed_keys</span><span class="src-sym">,&nbsp;</span><span class="src-var">$mac_key</span><span class="src-sym">,&nbsp;</span><span class="src-var">$hmac_func</span><span class="src-sym">,&nbsp;</span><span class="src-var">$version</span><span class="src-sym">)</span><span class="src-sym">;</span></div></li>
<li><div class="src-line"><a name="a971"></a>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a href="../simpleid/_www---log.inc.php.html#functionlog_debug">log_debug</a><span class="src-sym">(</span><span class="src-str">'*****&nbsp;Signature:&nbsp;'&nbsp;</span>.&nbsp;<span class="src-var">$signature</span><span class="src-sym">)</span><span class="src-sym">;</span></div></li>
<li><div class="src-line"><a name="a972"></a>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</div></li>
<li><div class="src-line"><a name="a973"></a>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-key">if&nbsp;</span><span class="src-sym">(</span><span class="src-var">$signature&nbsp;</span>!=&nbsp;<span class="src-var">$request</span><span class="src-sym">[</span><span class="src-str">'openid.sig'</span><span class="src-sym">]</span><span class="src-sym">)&nbsp;</span><span class="src-sym">{</span></div></li>
<li><div class="src-line"><a name="a974"></a>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a href="../simpleid/_www---log.inc.php.html#functionlog_warn">log_warn</a><span class="src-sym">(</span><span class="src-str">'simpleid_verify_signatures:&nbsp;Signature&nbsp;supplied&nbsp;in&nbsp;request&nbsp;does&nbsp;not&nbsp;match&nbsp;the&nbsp;signatured&nbsp;generated.'</span><span class="src-sym">)</span><span class="src-sym">;</span></div></li>
<li><div class="src-line"><a name="a975"></a>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-var">$is_valid&nbsp;</span>=&nbsp;<span class="src-id">FALSE</span><span class="src-sym">;</span></div></li>
<li><div class="src-line"><a name="a976"></a>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-sym">}</span></div></li>
<li><div class="src-line"><a name="a977"></a>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</div></li>
<li><div class="src-line"><a name="a978"></a>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a href="../simpleid/_www---cache.inc.php.html#functioncache_delete">cache_delete</a><span class="src-sym">(</span><span class="src-str">'stateless'</span><span class="src-sym">,&nbsp;</span><span class="src-var">$request</span><span class="src-sym">[</span><span class="src-str">'openid.response_nonce'</span><span class="src-sym">]</span><span class="src-sym">)</span><span class="src-sym">;</span></div></li>
<li><div class="src-line"><a name="a979"></a>&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-sym">}</span></div></li>
<li><div class="src-line"><a name="a980"></a>&nbsp;&nbsp;&nbsp;&nbsp;</div></li>
<li><div class="src-line"><a name="a981"></a>&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-key">return&nbsp;</span><span class="src-var">$is_valid</span><span class="src-sym">;</span></div></li>
<li><div class="src-line"><a name="a982"></a><span class="src-sym">}</span></div></li>
<li><div class="src-line"><a name="a983"></a>&nbsp;</div></li>
<li><div class="src-line"><a name="a984"></a>&nbsp;</div></li>
<li><div class="src-line"><a name="a985"></a><span class="src-doc">/**</span></div></li>
<li><div class="src-line"><a name="a986"></a><span class="src-doc">&nbsp;*&nbsp;Continues&nbsp;an&nbsp;OpenID&nbsp;authentication&nbsp;request.</span></div></li>
<li><div class="src-line"><a name="a987"></a><span class="src-doc">&nbsp;*</span></div></li>
<li><div class="src-line"><a name="a988"></a><span class="src-doc">&nbsp;*&nbsp;This&nbsp;function&nbsp;decodes&nbsp;an&nbsp;OpenID&nbsp;authentication&nbsp;request&nbsp;specified&nbsp;in&nbsp;the</span></div></li>
<li><div class="src-line"><a name="a989"></a><span class="src-doc">&nbsp;*&nbsp;s&nbsp;request&nbsp;parameter&nbsp;and&nbsp;feeds&nbsp;it&nbsp;to&nbsp;the</span></div></li>
<li><div class="src-line"><a name="a990"></a><span class="src-doc">&nbsp;*&nbsp;</span><span class="src-doc-inlinetag">{@link&nbsp;simpleid_process_openid}</span><span class="src-doc">&nbsp;function.&nbsp;&nbsp;This&nbsp;allows&nbsp;SimpleID&nbsp;to&nbsp;preserve</span></div></li>
<li><div class="src-line"><a name="a991"></a><span class="src-doc">&nbsp;*&nbsp;the&nbsp;state&nbsp;of&nbsp;an&nbsp;OpenID&nbsp;request.</span></div></li>
<li><div class="src-line"><a name="a992"></a><span class="src-doc">&nbsp;*/</span></div></li>
<li><div class="src-line"><a name="a993"></a><span class="src-key">function&nbsp;</span><a href="../simpleid/_www---index.php.html#functionsimpleid_continue">simpleid_continue</a><span class="src-sym">(</span><span class="src-sym">)&nbsp;</span><span class="src-sym">{</span></div></li>
<li><div class="src-line"><a name="a994"></a>&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-key">global&nbsp;</span><a href="../simpleid/_www---index.php.html#global$GETPOST">$GETPOST</a><span class="src-sym">;</span></div></li>
<li><div class="src-line"><a name="a995"></a>&nbsp;&nbsp;&nbsp;&nbsp;</div></li>
<li><div class="src-line"><a name="a996"></a>&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-var">$request&nbsp;</span>=&nbsp;<a href="../simpleid/_www---common.inc.php.html#functionunpickle">unpickle</a><span class="src-sym">(</span><span class="src-var">$GETPOST</span><span class="src-sym">[</span><span class="src-str">'s'</span><span class="src-sym">]</span><span class="src-sym">)</span><span class="src-sym">;</span></div></li>
<li><div class="src-line"><a name="a997"></a>&nbsp;&nbsp;&nbsp;&nbsp;<a href="../simpleid/_www---openid.inc.php.html#functionopenid_parse_request">openid_parse_request</a><span class="src-sym">(</span><span class="src-var">$request</span><span class="src-sym">)</span><span class="src-sym">;</span></div></li>
<li><div class="src-line"><a name="a998"></a>&nbsp;&nbsp;&nbsp;&nbsp;<a href="../simpleid/_www---index.php.html#functionsimpleid_process_openid">simpleid_process_openid</a><span class="src-sym">(</span><span class="src-var">$request</span><span class="src-sym">)</span><span class="src-sym">;</span></div></li>
<li><div class="src-line"><a name="a999"></a><span class="src-sym">}</span></div></li>
<li><div class="src-line"><a name="a1000"></a>&nbsp;</div></li>
<li><div class="src-line"><a name="a1001"></a><span class="src-doc">/**</span></div></li>
<li><div class="src-line"><a name="a1002"></a><span class="src-doc">&nbsp;*&nbsp;Provides&nbsp;a&nbsp;form&nbsp;for&nbsp;user&nbsp;consent&nbsp;of&nbsp;an&nbsp;OpenID&nbsp;relying&nbsp;party,&nbsp;where&nbsp;the</span></div></li>
<li><div class="src-line"><a name="a1003"></a><span class="src-doc">&nbsp;*&nbsp;</span><span class="src-doc-inlinetag">{@link&nbsp;simpleid_checkid_identity()}</span><span class="src-doc">&nbsp;function&nbsp;returns&nbsp;a&nbsp;CHECKID_APPROVAL_REQUIRED</span></div></li>
<li><div class="src-line"><a name="a1004"></a><span class="src-doc">&nbsp;*&nbsp;or&nbsp;CHECKID_RETURN_TO_SUSPECT.</span></div></li>
<li><div class="src-line"><a name="a1005"></a><span class="src-doc">&nbsp;*</span></div></li>
<li><div class="src-line"><a name="a1006"></a><span class="src-doc">&nbsp;*&nbsp;Alternatively,&nbsp;provide&nbsp;a&nbsp;form&nbsp;for&nbsp;the&nbsp;user&nbsp;to&nbsp;rectify&nbsp;the&nbsp;situation&nbsp;where</span></div></li>
<li><div class="src-line"><a name="a1007"></a><span class="src-doc">&nbsp;*&nbsp;</span><span class="src-doc-inlinetag">{@link&nbsp;simpleid_checkid_identity()}</span><span class="src-doc">&nbsp;function&nbsp;returns&nbsp;a&nbsp;CHECKID_IDENTITIES_NOT_MATCHING</span></div></li>
<li><div class="src-line"><a name="a1008"></a><span class="src-doc">&nbsp;*&nbsp;or&nbsp;CHECKID_IDENTITY_NOT_EXIST</span></div></li>
<li><div class="src-line"><a name="a1009"></a><span class="src-doc">&nbsp;*</span></div></li>
<li><div class="src-line"><a name="a1010"></a><span class="src-doc">&nbsp;*&nbsp;</span><span class="src-doc-coretag">@param&nbsp;</span><span class="src-doc-type">array&nbsp;</span><span class="src-doc-var">$request&nbsp;</span><span class="src-doc">the&nbsp;original&nbsp;OpenID&nbsp;request</span></div></li>
<li><div class="src-line"><a name="a1011"></a><span class="src-doc">&nbsp;*&nbsp;</span><span class="src-doc-coretag">@param&nbsp;</span><span class="src-doc-type">array&nbsp;</span><span class="src-doc-var">$response&nbsp;</span><span class="src-doc">the&nbsp;proposed&nbsp;OpenID&nbsp;response,&nbsp;subject&nbsp;to&nbsp;user</span></div></li>
<li><div class="src-line"><a name="a1012"></a><span class="src-doc">&nbsp;*&nbsp;&nbsp;verification</span></div></li>
<li><div class="src-line"><a name="a1013"></a><span class="src-doc">&nbsp;*&nbsp;</span><span class="src-doc-coretag">@param&nbsp;</span><span class="src-doc-type">int&nbsp;</span><span class="src-doc-var">$reason&nbsp;</span><span class="src-doc">either&nbsp;CHECKID_APPROVAL_REQUIRED,&nbsp;CHECKID_RETURN_TO_SUSPECT,</span></div></li>
<li><div class="src-line"><a name="a1014"></a><span class="src-doc">&nbsp;*&nbsp;&nbsp;CHECKID_IDENTITIES_NOT_MATCHING&nbsp;or&nbsp;CHECKID_IDENTITY_NOT_EXIST</span></div></li>
<li><div class="src-line"><a name="a1015"></a><span class="src-doc">&nbsp;*/</span></div></li>
<li><div class="src-line"><a name="a1016"></a><span class="src-key">function&nbsp;</span><a href="../simpleid/_www---index.php.html#functionsimpleid_openid_consent_form">simpleid_openid_consent_form</a><span class="src-sym">(</span><span class="src-var">$request</span><span class="src-sym">,&nbsp;</span><span class="src-var">$response</span><span class="src-sym">,&nbsp;</span><span class="src-var">$reason&nbsp;</span>=&nbsp;<span class="src-id">CHECKID_APPROVAL_REQUIRED</span><span class="src-sym">)&nbsp;</span><span class="src-sym">{</span></div></li>
<li><div class="src-line"><a name="a1017"></a>&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-key">global&nbsp;</span><a href="../simpleid/_www---user.inc.php.html#global$user">$user</a><span class="src-sym">;</span></div></li>
<li><div class="src-line"><a name="a1018"></a>&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-key">global&nbsp;</span><a href="../simpleid/_www---index.php.html#global$xtpl">$xtpl</a><span class="src-sym">;</span></div></li>
<li><div class="src-line"><a name="a1019"></a>&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-key">global&nbsp;</span><a href="../simpleid/_www---index.php.html#global$version">$version</a><span class="src-sym">;</span></div></li>
<li><div class="src-line"><a name="a1020"></a>&nbsp;&nbsp;&nbsp;&nbsp;</div></li>
<li><div class="src-line"><a name="a1021"></a>&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-var">$request_state&nbsp;</span>=&nbsp;<a href="../simpleid/_www---common.inc.php.html#functionpickle">pickle</a><span class="src-sym">(</span><span class="src-var">$request</span><span class="src-sym">)</span><span class="src-sym">;</span></div></li>
<li><div class="src-line"><a name="a1022"></a>&nbsp;&nbsp;&nbsp;&nbsp;</div></li>
<li><div class="src-line"><a name="a1023"></a>&nbsp;&nbsp;&nbsp;&nbsp;<a href="../simpleid/_www---user.inc.php.html#functionuser_header">user_header</a><span class="src-sym">(</span><span class="src-var">$request_state</span><span class="src-sym">)</span><span class="src-sym">;</span></div></li>
<li><div class="src-line"><a name="a1024"></a>&nbsp;</div></li>
<li><div class="src-line"><a name="a1025"></a>&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-var">$realm&nbsp;</span>=&nbsp;<a href="../simpleid/_www---openid.inc.php.html#functionopenid_get_realm">openid_get_realm</a><span class="src-sym">(</span><span class="src-var">$request</span><span class="src-sym">,&nbsp;</span><span class="src-var">$version</span><span class="src-sym">)</span><span class="src-sym">;</span></div></li>
<li><div class="src-line"><a name="a1026"></a>&nbsp;&nbsp;&nbsp;&nbsp;</div></li>
<li><div class="src-line"><a name="a1027"></a>&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-var">$xtpl</span><span class="src-sym">-&gt;</span><span class="src-id">assign</span><span class="src-sym">(</span><span class="src-str">'token'</span><span class="src-sym">,&nbsp;</span><a href="../simpleid/_www---common.inc.php.html#functionget_form_token">get_form_token</a><span class="src-sym">(</span><span class="src-str">'rp'</span><span class="src-sym">))</span><span class="src-sym">;</span></div></li>
<li><div class="src-line"><a name="a1028"></a>&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-var">$xtpl</span><span class="src-sym">-&gt;</span><span class="src-id">assign</span><span class="src-sym">(</span><span class="src-str">'state'</span><span class="src-sym">,&nbsp;</span><a href="../simpleid/_www---common.inc.php.html#functionpickle">pickle</a><span class="src-sym">(</span><span class="src-var">$response</span><span class="src-sym">))</span><span class="src-sym">;</span></div></li>
<li><div class="src-line"><a name="a1029"></a>&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-var">$xtpl</span><span class="src-sym">-&gt;</span><span class="src-id">assign</span><span class="src-sym">(</span><span class="src-str">'realm'</span><span class="src-sym">,&nbsp;</span><a href="http://www.php.net/htmlspecialchars">htmlspecialchars</a><span class="src-sym">(</span><span class="src-var">$realm</span><span class="src-sym">,&nbsp;</span><span class="src-id">ENT_QUOTES</span><span class="src-sym">,&nbsp;</span><span class="src-str">'UTF-8'</span><span class="src-sym">))</span><span class="src-sym">;</span></div></li>
<li><div class="src-line"><a name="a1030"></a>&nbsp;&nbsp;&nbsp;&nbsp;</div></li>
<li><div class="src-line"><a name="a1031"></a>&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-var">$xtpl</span><span class="src-sym">-&gt;</span><span class="src-id">assign</span><span class="src-sym">(</span><span class="src-str">'cancel_button'</span><span class="src-sym">,&nbsp;</span><a href="../simpleid/_www---locale.inc.php.html#functiont">t</a><span class="src-sym">(</span><span class="src-str">'Cancel'</span><span class="src-sym">))</span><span class="src-sym">;</span></div></li>
<li><div class="src-line"><a name="a1032"></a>&nbsp;</div></li>
<li><div class="src-line"><a name="a1033"></a>&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-key">if&nbsp;</span><span class="src-sym">(</span><span class="src-var">$response</span><span class="src-sym">[</span><span class="src-str">'openid.mode'</span><span class="src-sym">]&nbsp;</span>==&nbsp;<span class="src-str">'cancel'</span><span class="src-sym">)&nbsp;</span><span class="src-sym">{</span></div></li>
<li><div class="src-line"><a name="a1034"></a>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-var">$xtpl</span><span class="src-sym">-&gt;</span><span class="src-id">assign</span><span class="src-sym">(</span><span class="src-str">'return_to'</span><span class="src-sym">,&nbsp;</span><a href="http://www.php.net/htmlspecialchars">htmlspecialchars</a><span class="src-sym">(</span><span class="src-var">$request</span><span class="src-sym">[</span><span class="src-str">'openid.return_to'</span><span class="src-sym">]</span><span class="src-sym">,&nbsp;</span><span class="src-id">ENT_QUOTES</span><span class="src-sym">,&nbsp;</span><span class="src-str">'UTF-8'</span><span class="src-sym">))</span><span class="src-sym">;</span></div></li>
<li><div class="src-line"><a name="a1035"></a>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</div></li>
<li><div class="src-line"><a name="a1036"></a>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-var">$xtpl</span><span class="src-sym">-&gt;</span><span class="src-id">assign</span><span class="src-sym">(</span><span class="src-str">'unable_label'</span><span class="src-sym">,&nbsp;</span><a href="../simpleid/_www---locale.inc.php.html#functiont">t</a><span class="src-sym">(</span><span class="src-str">'Unable&nbsp;to&nbsp;log&nbsp;into&nbsp;&lt;strong&nbsp;class=&quot;realm&quot;&gt;@realm&lt;/strong&gt;.'</span><span class="src-sym">,&nbsp;</span><span class="src-key">array</span><span class="src-sym">(</span><span class="src-str">'@realm'&nbsp;</span>=&gt;&nbsp;<span class="src-var">$realm</span><span class="src-sym">)))</span><span class="src-sym">;</span></div></li>
<li><div class="src-line"><a name="a1037"></a>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-var">$xtpl</span><span class="src-sym">-&gt;</span><span class="src-id">assign</span><span class="src-sym">(</span><span class="src-str">'identity_not_matching_label'</span><span class="src-sym">,&nbsp;</span><a href="../simpleid/_www---locale.inc.php.html#functiont">t</a><span class="src-sym">(</span><span class="src-str">'Your&nbsp;current&nbsp;identity&nbsp;does&nbsp;not&nbsp;match&nbsp;the&nbsp;requested&nbsp;identity&nbsp;%identity.'</span><span class="src-sym">,&nbsp;</span><span class="src-key">array</span><span class="src-sym">(</span><span class="src-str">'%identity'&nbsp;</span>=&gt;&nbsp;<span class="src-var">$request</span><span class="src-sym">[</span><span class="src-str">'openid.identity'</span><span class="src-sym">]</span><span class="src-sym">)))</span><span class="src-sym">;</span></div></li>
<li><div class="src-line"><a name="a1038"></a>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-var">$xtpl</span><span class="src-sym">-&gt;</span><span class="src-id">assign</span><span class="src-sym">(</span><span class="src-str">'switch_user_label'</span><span class="src-sym">,&nbsp;</span><a href="../simpleid/_www---locale.inc.php.html#functiont">t</a><span class="src-sym">(</span><span class="src-str">'&lt;a&nbsp;href=&quot;!url&quot;&gt;Switch&nbsp;to&nbsp;a&nbsp;different&nbsp;user&lt;/a&gt;&nbsp;and&nbsp;try&nbsp;again.'</span><span class="src-sym">,&nbsp;</span><span class="src-key">array</span><span class="src-sym">(</span><span class="src-str">'!url'&nbsp;</span>=&gt;&nbsp;<a href="../simpleid/_www---common.inc.php.html#functionsimpleid_url">simpleid_url</a><span class="src-sym">(</span><span class="src-str">'logout'</span><span class="src-sym">,&nbsp;</span><span class="src-str">'destination=continue&amp;s='&nbsp;</span>.&nbsp;<a href="http://www.php.net/rawurlencode">rawurlencode</a><span class="src-sym">(</span><span class="src-var">$request_state</span><span class="src-sym">)</span><span class="src-sym">,&nbsp;</span><span class="src-id">true</span><span class="src-sym">))))</span><span class="src-sym">;</span></div></li>
<li><div class="src-line"><a name="a1039"></a>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</div></li>
<li><div class="src-line"><a name="a1040"></a>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-var">$xtpl</span><span class="src-sym">-&gt;</span><span class="src-id">parse</span><span class="src-sym">(</span><span class="src-str">'main.openid_consent.cancel'</span><span class="src-sym">)</span><span class="src-sym">;</span></div></li>
<li><div class="src-line"><a name="a1041"></a>&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-sym">}&nbsp;</span><span class="src-key">else&nbsp;</span><span class="src-sym">{</span></div></li>
<li><div class="src-line"><a name="a1042"></a>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-var">$xtpl</span><span class="src-sym">-&gt;</span><span class="src-id">assign</span><span class="src-sym">(</span><span class="src-str">'javascript'</span><span class="src-sym">,&nbsp;</span><span class="src-str">'&lt;script&nbsp;src=&quot;'&nbsp;</span>.&nbsp;<a href="../simpleid/_www---common.inc.php.html#functionget_base_path">get_base_path</a><span class="src-sym">(</span><span class="src-sym">)&nbsp;</span>.&nbsp;<span class="src-str">'html/openid-consent.js&quot;&nbsp;type=&quot;text/javascript&quot;&gt;&lt;/script&gt;'</span><span class="src-sym">)</span><span class="src-sym">;</span></div></li>
<li><div class="src-line"><a name="a1043"></a>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</div></li>
<li><div class="src-line"><a name="a1044"></a>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-var">$rp&nbsp;</span>=&nbsp;<span class="src-sym">(</span>isset<span class="src-sym">(</span><span class="src-var">$user</span><span class="src-sym">[</span><span class="src-str">'rp'</span><span class="src-sym">]</span><span class="src-sym">[</span><span class="src-var">$realm</span><span class="src-sym">]</span><span class="src-sym">))&nbsp;</span>?&nbsp;<span class="src-var">$user</span><span class="src-sym">[</span><span class="src-str">'rp'</span><span class="src-sym">]</span><span class="src-sym">[</span><span class="src-var">$realm</span><span class="src-sym">]&nbsp;</span>:&nbsp;<span class="src-id">NULL</span><span class="src-sym">;</span></div></li>
<li><div class="src-line"><a name="a1045"></a>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</div></li>
<li><div class="src-line"><a name="a1046"></a>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-var">$extensions&nbsp;</span>=&nbsp;<a href="../simpleid/_www---common.inc.php.html#functionextension_invoke_all">extension_invoke_all</a><span class="src-sym">(</span><span class="src-str">'consent_form'</span><span class="src-sym">,&nbsp;</span><span class="src-var">$request</span><span class="src-sym">,&nbsp;</span><span class="src-var">$response</span><span class="src-sym">,&nbsp;</span><span class="src-var">$rp</span><span class="src-sym">)</span><span class="src-sym">;</span></div></li>
<li><div class="src-line"><a name="a1047"></a>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-var">$xtpl</span><span class="src-sym">-&gt;</span><span class="src-id">assign</span><span class="src-sym">(</span><span class="src-str">'extensions'</span><span class="src-sym">,&nbsp;</span><a href="http://www.php.net/implode">implode</a><span class="src-sym">(</span><span class="src-var">$extensions</span><span class="src-sym">))</span><span class="src-sym">;</span></div></li>
<li><div class="src-line"><a name="a1048"></a>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</div></li>
<li><div class="src-line"><a name="a1049"></a>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-key">if&nbsp;</span><span class="src-sym">(</span><span class="src-var">$reason&nbsp;</span>==&nbsp;<span class="src-id"><a href="../simpleid/_www---index.php.html#defineCHECKID_RETURN_TO_SUSPECT">CHECKID_RETURN_TO_SUSPECT</a></span><span class="src-sym">)&nbsp;</span><span class="src-sym">{</span></div></li>
<li><div class="src-line"><a name="a1050"></a>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-var">$xtpl</span><span class="src-sym">-&gt;</span><span class="src-id">assign</span><span class="src-sym">(</span><span class="src-str">'suspect_label'</span><span class="src-sym">,&nbsp;</span><a href="../simpleid/_www---locale.inc.php.html#functiont">t</a><span class="src-sym">(</span><span class="src-str">'Warning:&nbsp;This&nbsp;web&nbsp;site&nbsp;has&nbsp;not&nbsp;confirmed&nbsp;its&nbsp;identity&nbsp;and&nbsp;might&nbsp;be&nbsp;fraudulent.&nbsp;&nbsp;Do&nbsp;not&nbsp;share&nbsp;any&nbsp;personal&nbsp;information&nbsp;with&nbsp;this&nbsp;web&nbsp;site&nbsp;unless&nbsp;you&nbsp;are&nbsp;sure&nbsp;it&nbsp;is&nbsp;legitimate.&nbsp;See&nbsp;the&nbsp;&lt;a&nbsp;href=&quot;!url&quot;&nbsp;class=&quot;popup&quot;&gt;SimpleID&nbsp;documentation&nbsp;for&nbsp;details&lt;/a&gt;&nbsp;(OpenID&nbsp;version&nbsp;2.0&nbsp;return_to&nbsp;discovery&nbsp;failure)'</span><span class="src-sym">,</span></div></li>
<li><div class="src-line"><a name="a1051"></a>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-key">array</span><span class="src-sym">(</span><span class="src-str">'!url'&nbsp;</span>=&gt;&nbsp;<span class="src-str">'http://simpleid.koinic.net/documentation/troubleshooting/returnto-discovery-failure'</span><span class="src-sym">)))</span><span class="src-sym">;</span></div></li>
<li><div class="src-line"><a name="a1052"></a>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</div></li>
<li><div class="src-line"><a name="a1053"></a>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-var">$xtpl</span><span class="src-sym">-&gt;</span><span class="src-id">parse</span><span class="src-sym">(</span><span class="src-str">'main.openid_consent.setup.suspect'</span><span class="src-sym">)</span><span class="src-sym">;</span></div></li>
<li><div class="src-line"><a name="a1054"></a>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-var">$xtpl</span><span class="src-sym">-&gt;</span><span class="src-id">assign</span><span class="src-sym">(</span><span class="src-str">'realm_class'</span><span class="src-sym">,&nbsp;</span><span class="src-str">'return-to-suspect'</span><span class="src-sym">)</span><span class="src-sym">;</span></div></li>
<li><div class="src-line"><a name="a1055"></a>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-sym">}</span></div></li>
<li><div class="src-line"><a name="a1056"></a>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</div></li>
<li><div class="src-line"><a name="a1057"></a>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-var">$xtpl</span><span class="src-sym">-&gt;</span><span class="src-id">assign</span><span class="src-sym">(</span><span class="src-str">'realm_label'</span><span class="src-sym">,&nbsp;</span><a href="../simpleid/_www---locale.inc.php.html#functiont">t</a><span class="src-sym">(</span><span class="src-str">'You&nbsp;are&nbsp;being&nbsp;logged&nbsp;into&nbsp;&lt;strong&nbsp;class=&quot;realm&quot;&gt;@realm&lt;/strong&gt;.'</span><span class="src-sym">,&nbsp;</span><span class="src-key">array</span><span class="src-sym">(</span><span class="src-str">'@realm'&nbsp;</span>=&gt;&nbsp;<span class="src-var">$realm</span><span class="src-sym">)))</span><span class="src-sym">;</span></div></li>
<li><div class="src-line"><a name="a1058"></a>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-var">$xtpl</span><span class="src-sym">-&gt;</span><span class="src-id">assign</span><span class="src-sym">(</span><span class="src-str">'auto_release_label'</span><span class="src-sym">,&nbsp;</span><a href="../simpleid/_www---locale.inc.php.html#functiont">t</a><span class="src-sym">(</span><span class="src-str">'Automatically&nbsp;send&nbsp;my&nbsp;information&nbsp;to&nbsp;this&nbsp;site&nbsp;for&nbsp;any&nbsp;future&nbsp;requests.'</span><span class="src-sym">))</span><span class="src-sym">;</span></div></li>
<li><div class="src-line"><a name="a1059"></a>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-var">$xtpl</span><span class="src-sym">-&gt;</span><span class="src-id">assign</span><span class="src-sym">(</span><span class="src-str">'ok_button'</span><span class="src-sym">,&nbsp;</span><a href="../simpleid/_www---locale.inc.php.html#functiont">t</a><span class="src-sym">(</span><span class="src-str">'OK'</span><span class="src-sym">))</span><span class="src-sym">;</span></div></li>
<li><div class="src-line"><a name="a1060"></a>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</div></li>
<li><div class="src-line"><a name="a1061"></a>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-var">$xtpl</span><span class="src-sym">-&gt;</span><span class="src-id">parse</span><span class="src-sym">(</span><span class="src-str">'main.openid_consent.setup'</span><span class="src-sym">)</span><span class="src-sym">;</span></div></li>
<li><div class="src-line"><a name="a1062"></a>&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-sym">}</span></div></li>
<li><div class="src-line"><a name="a1063"></a>&nbsp;&nbsp;&nbsp;&nbsp;</div></li>
<li><div class="src-line"><a name="a1064"></a>&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-var">$xtpl</span><span class="src-sym">-&gt;</span><span class="src-id">parse</span><span class="src-sym">(</span><span class="src-str">'main.openid_consent'</span><span class="src-sym">)</span><span class="src-sym">;</span></div></li>
<li><div class="src-line"><a name="a1065"></a>&nbsp;&nbsp;&nbsp;&nbsp;</div></li>
<li><div class="src-line"><a name="a1066"></a>&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-var">$xtpl</span><span class="src-sym">-&gt;</span><span class="src-id">assign</span><span class="src-sym">(</span><span class="src-key">array</span><span class="src-sym">(</span><span class="src-str">'js_locale_label'&nbsp;</span>=&gt;&nbsp;<span class="src-str">'openid_suspect'</span><span class="src-sym">,&nbsp;</span><span class="src-str">'js_locale_text'&nbsp;</span>=&gt;&nbsp;<a href="http://www.php.net/addslashes">addslashes</a><span class="src-sym">(</span><a href="../simpleid/_www---locale.inc.php.html#functiont">t</a><span class="src-sym">(</span><span class="src-str">'This&nbsp;web&nbsp;site&nbsp;has&nbsp;not&nbsp;confirmed&nbsp;its&nbsp;identity&nbsp;and&nbsp;might&nbsp;be&nbsp;fraudulent.'</span><span class="src-sym">))&nbsp;</span>.&nbsp;<span class="src-str">'\n\n'&nbsp;</span>.&nbsp;<a href="http://www.php.net/addslashes">addslashes</a><span class="src-sym">(</span><a href="../simpleid/_www---locale.inc.php.html#functiont">t</a><span class="src-sym">(</span><span class="src-str">'Are&nbsp;you&nbsp;sure&nbsp;you&nbsp;wish&nbsp;to&nbsp;automatically&nbsp;send&nbsp;your&nbsp;information&nbsp;to&nbsp;this&nbsp;site&nbsp;for&nbsp;any&nbsp;future&nbsp;requests?'</span><span class="src-sym">))))</span><span class="src-sym">;</span></div></li>
<li><div class="src-line"><a name="a1067"></a>&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-var">$xtpl</span><span class="src-sym">-&gt;</span><span class="src-id">parse</span><span class="src-sym">(</span><span class="src-str">'main.js_locale'</span><span class="src-sym">)</span><span class="src-sym">;</span></div></li>
<li><div class="src-line"><a name="a1068"></a>&nbsp;&nbsp;&nbsp;&nbsp;</div></li>
<li><div class="src-line"><a name="a1069"></a>&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-var">$xtpl</span><span class="src-sym">-&gt;</span><span class="src-id">parse</span><span class="src-sym">(</span><span class="src-str">'main.framekiller'</span><span class="src-sym">)</span><span class="src-sym">;</span></div></li>
<li><div class="src-line"><a name="a1070"></a>&nbsp;&nbsp;&nbsp;&nbsp;</div></li>
<li><div class="src-line"><a name="a1071"></a>&nbsp;&nbsp;&nbsp;&nbsp;<a href="http://www.php.net/header">header</a><span class="src-sym">(</span><span class="src-str">'X-Frame-Options:&nbsp;DENY'</span><span class="src-sym">)</span><span class="src-sym">;</span></div></li>
<li><div class="src-line"><a name="a1072"></a>&nbsp;&nbsp;&nbsp;&nbsp;</div></li>
<li><div class="src-line"><a name="a1073"></a>&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-var">$xtpl</span><span class="src-sym">-&gt;</span><span class="src-id">assign</span><span class="src-sym">(</span><span class="src-str">'title'</span><span class="src-sym">,&nbsp;</span><a href="../simpleid/_www---locale.inc.php.html#functiont">t</a><span class="src-sym">(</span><span class="src-str">'OpenID&nbsp;Login'</span><span class="src-sym">))</span><span class="src-sym">;</span></div></li>
<li><div class="src-line"><a name="a1074"></a>&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-var">$xtpl</span><span class="src-sym">-&gt;</span><span class="src-id">assign</span><span class="src-sym">(</span><span class="src-str">'page_class'</span><span class="src-sym">,&nbsp;</span><span class="src-str">'dialog-page'</span><span class="src-sym">)</span><span class="src-sym">;</span></div></li>
<li><div class="src-line"><a name="a1075"></a>&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-var">$xtpl</span><span class="src-sym">-&gt;</span><span class="src-id">parse</span><span class="src-sym">(</span><span class="src-str">'main'</span><span class="src-sym">)</span><span class="src-sym">;</span></div></li>
<li><div class="src-line"><a name="a1076"></a>&nbsp;&nbsp;&nbsp;&nbsp;</div></li>
<li><div class="src-line"><a name="a1077"></a>&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-var">$xtpl</span><span class="src-sym">-&gt;</span><span class="src-id">out</span><span class="src-sym">(</span><span class="src-str">'main'</span><span class="src-sym">)</span><span class="src-sym">;</span></div></li>
<li><div class="src-line"><a name="a1078"></a><span class="src-sym">}</span></div></li>
<li><div class="src-line"><a name="a1079"></a>&nbsp;</div></li>
<li><div class="src-line"><a name="a1080"></a>&nbsp;</div></li>
<li><div class="src-line"><a name="a1081"></a><span class="src-doc">/**</span></div></li>
<li><div class="src-line"><a name="a1082"></a><span class="src-doc">&nbsp;*&nbsp;Processes&nbsp;a&nbsp;user&nbsp;response&nbsp;from&nbsp;the&nbsp;</span><span class="src-doc-inlinetag">{@link&nbsp;simpleid_openid_consent_form()}</span><span class="src-doc">&nbsp;function.</span></div></li>
<li><div class="src-line"><a name="a1083"></a><span class="src-doc">&nbsp;*</span></div></li>
<li><div class="src-line"><a name="a1084"></a><span class="src-doc">&nbsp;*&nbsp;If&nbsp;the&nbsp;user&nbsp;verifies&nbsp;the&nbsp;relying&nbsp;party,&nbsp;an&nbsp;OpenID&nbsp;response&nbsp;will&nbsp;be&nbsp;sent&nbsp;to</span></div></li>
<li><div class="src-line"><a name="a1085"></a><span class="src-doc">&nbsp;*&nbsp;the&nbsp;relying&nbsp;party.&nbsp;&nbsp;Otherwise,&nbsp;the&nbsp;dashboard&nbsp;will&nbsp;be&nbsp;displayed&nbsp;to&nbsp;the&nbsp;user.</span></div></li>
<li><div class="src-line"><a name="a1086"></a><span class="src-doc">&nbsp;*</span></div></li>
<li><div class="src-line"><a name="a1087"></a><span class="src-doc">&nbsp;*/</span></div></li>
<li><div class="src-line"><a name="a1088"></a><span class="src-key">function&nbsp;</span><a href="../simpleid/_www---index.php.html#functionsimpleid_openid_consent">simpleid_openid_consent</a><span class="src-sym">(</span><span class="src-sym">)&nbsp;</span><span class="src-sym">{</span></div></li>
<li><div class="src-line"><a name="a1089"></a>&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-key">global&nbsp;</span><a href="../simpleid/_www---index.php.html#global$xtpl">$xtpl</a><span class="src-sym">,&nbsp;</span><a href="../simpleid/_www---user.inc.php.html#global$user">$user</a><span class="src-sym">,&nbsp;</span><a href="../simpleid/_www---index.php.html#global$version">$version</a><span class="src-sym">,&nbsp;</span><a href="../simpleid/_www---index.php.html#global$GETPOST">$GETPOST</a><span class="src-sym">;</span></div></li>
<li><div class="src-line"><a name="a1090"></a>&nbsp;&nbsp;&nbsp;&nbsp;</div></li>
<li><div class="src-line"><a name="a1091"></a>&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-key">if&nbsp;</span><span class="src-sym">(</span><span class="src-var">$user&nbsp;</span>==&nbsp;<span class="src-id">NULL</span><span class="src-sym">)&nbsp;</span><span class="src-sym">{</span></div></li>
<li><div class="src-line"><a name="a1092"></a>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a href="../simpleid/_www---user.inc.php.html#functionuser_login_form">user_login_form</a><span class="src-sym">(</span><span class="src-str">''</span><span class="src-sym">)</span><span class="src-sym">;</span></div></li>
<li><div class="src-line"><a name="a1093"></a>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-key">return</span><span class="src-sym">;</span></div></li>
<li><div class="src-line"><a name="a1094"></a>&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-sym">}</span></div></li>
<li><div class="src-line"><a name="a1095"></a>&nbsp;&nbsp;&nbsp;&nbsp;</div></li>
<li><div class="src-line"><a name="a1096"></a>&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-key">if&nbsp;</span><span class="src-sym">(</span><span class="src-sym">!</span><a href="../simpleid/_www---common.inc.php.html#functionvalidate_form_token">validate_form_token</a><span class="src-sym">(</span><span class="src-var">$GETPOST</span><span class="src-sym">[</span><span class="src-str">'tk'</span><span class="src-sym">]</span><span class="src-sym">,&nbsp;</span><span class="src-str">'rp'</span><span class="src-sym">))&nbsp;</span><span class="src-sym">{</span></div></li>
<li><div class="src-line"><a name="a1097"></a>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a href="../simpleid/_www---common.inc.php.html#functionset_message">set_message</a><span class="src-sym">(</span><a href="../simpleid/_www---locale.inc.php.html#functiont">t</a><span class="src-sym">(</span><span class="src-str">'SimpleID&nbsp;detected&nbsp;a&nbsp;potential&nbsp;security&nbsp;attack.&nbsp;&nbsp;Please&nbsp;try&nbsp;again.'</span><span class="src-sym">))</span><span class="src-sym">;</span></div></li>
<li><div class="src-line"><a name="a1098"></a>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-var">$xtpl</span><span class="src-sym">-&gt;</span><span class="src-id">assign</span><span class="src-sym">(</span><span class="src-str">'title'</span><span class="src-sym">,&nbsp;</span><a href="../simpleid/_www---locale.inc.php.html#functiont">t</a><span class="src-sym">(</span><span class="src-str">'OpenID&nbsp;Login'</span><span class="src-sym">))</span><span class="src-sym">;</span></div></li>
<li><div class="src-line"><a name="a1099"></a>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-var">$xtpl</span><span class="src-sym">-&gt;</span><span class="src-id">parse</span><span class="src-sym">(</span><span class="src-str">'main'</span><span class="src-sym">)</span><span class="src-sym">;</span></div></li>
<li><div class="src-line"><a name="a1100"></a>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-var">$xtpl</span><span class="src-sym">-&gt;</span><span class="src-id">out</span><span class="src-sym">(</span><span class="src-str">'main'</span><span class="src-sym">)</span><span class="src-sym">;</span></div></li>
<li><div class="src-line"><a name="a1101"></a>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-key">return</span><span class="src-sym">;</span></div></li>
<li><div class="src-line"><a name="a1102"></a>&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-sym">}</span></div></li>
<li><div class="src-line"><a name="a1103"></a>&nbsp;&nbsp;&nbsp;&nbsp;</div></li>
<li><div class="src-line"><a name="a1104"></a>&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-var">$uid&nbsp;</span>=&nbsp;<span class="src-var">$user</span><span class="src-sym">[</span><span class="src-str">'uid'</span><span class="src-sym">]</span><span class="src-sym">;</span></div></li>
<li><div class="src-line"><a name="a1105"></a>&nbsp;&nbsp;&nbsp;&nbsp;</div></li>
<li><div class="src-line"><a name="a1106"></a>&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-var">$response&nbsp;</span>=&nbsp;<a href="../simpleid/_www---common.inc.php.html#functionunpickle">unpickle</a><span class="src-sym">(</span><span class="src-var">$GETPOST</span><span class="src-sym">[</span><span class="src-str">'s'</span><span class="src-sym">]</span><span class="src-sym">)</span><span class="src-sym">;</span></div></li>
<li><div class="src-line"><a name="a1107"></a>&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-var">$version&nbsp;</span>=&nbsp;<a href="../simpleid/_www---openid.inc.php.html#functionopenid_get_version">openid_get_version</a><span class="src-sym">(</span><span class="src-var">$response</span><span class="src-sym">)</span><span class="src-sym">;</span></div></li>
<li><div class="src-line"><a name="a1108"></a>&nbsp;&nbsp;&nbsp;&nbsp;<a href="../simpleid/_www---openid.inc.php.html#functionopenid_parse_request">openid_parse_request</a><span class="src-sym">(</span><span class="src-var">$response</span><span class="src-sym">)</span><span class="src-sym">;</span></div></li>
<li><div class="src-line"><a name="a1109"></a>&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-var">$return_to&nbsp;</span>=&nbsp;<span class="src-var">$response</span><span class="src-sym">[</span><span class="src-str">'openid.return_to'</span><span class="src-sym">]</span><span class="src-sym">;</span></div></li>
<li><div class="src-line"><a name="a1110"></a>&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-key">if&nbsp;</span><span class="src-sym">(</span><span class="src-sym">!</span><span class="src-var">$return_to</span><span class="src-sym">)&nbsp;</span><span class="src-var">$return_to&nbsp;</span>=&nbsp;<span class="src-var">$GETPOST</span><span class="src-sym">[</span><span class="src-str">'openid.return_to'</span><span class="src-sym">]</span><span class="src-sym">;</span></div></li>
<li><div class="src-line"><a name="a1111"></a>&nbsp;&nbsp;&nbsp;&nbsp;</div></li>
<li><div class="src-line"><a name="a1112"></a>&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-key">if&nbsp;</span><span class="src-sym">(</span><span class="src-var">$GETPOST</span><span class="src-sym">[</span><span class="src-str">'op'</span><span class="src-sym">]&nbsp;</span>==&nbsp;<a href="../simpleid/_www---locale.inc.php.html#functiont">t</a><span class="src-sym">(</span><span class="src-str">'Cancel'</span><span class="src-sym">))&nbsp;</span><span class="src-sym">{</span></div></li>
<li><div class="src-line"><a name="a1113"></a>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-var">$response&nbsp;</span>=&nbsp;<a href="../simpleid/_www---index.php.html#functionsimpleid_checkid_error">simpleid_checkid_error</a><span class="src-sym">(</span><span class="src-id">false</span><span class="src-sym">)</span><span class="src-sym">;</span></div></li>
<li><div class="src-line"><a name="a1114"></a>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-key">if&nbsp;</span><span class="src-sym">(</span><span class="src-sym">!</span><span class="src-var">$return_to</span><span class="src-sym">)&nbsp;</span><a href="../simpleid/_www---common.inc.php.html#functionset_message">set_message</a><span class="src-sym">(</span><a href="../simpleid/_www---locale.inc.php.html#functiont">t</a><span class="src-sym">(</span><span class="src-str">'Log&nbsp;in&nbsp;cancelled.'</span><span class="src-sym">))</span><span class="src-sym">;</span></div></li>
<li><div class="src-line"><a name="a1115"></a>&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-sym">}&nbsp;</span><span class="src-key">else&nbsp;</span><span class="src-sym">{</span></div></li>
<li><div class="src-line"><a name="a1116"></a>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-var">$now&nbsp;</span>=&nbsp;<a href="http://www.php.net/time">time</a><span class="src-sym">(</span><span class="src-sym">)</span><span class="src-sym">;</span></div></li>
<li><div class="src-line"><a name="a1117"></a>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-var">$realm&nbsp;</span>=&nbsp;<span class="src-var">$GETPOST</span><span class="src-sym">[</span><span class="src-str">'openid.realm'</span><span class="src-sym">]</span><span class="src-sym">;</span></div></li>
<li><div class="src-line"><a name="a1118"></a>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</div></li>
<li><div class="src-line"><a name="a1119"></a>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-key">if&nbsp;</span><span class="src-sym">(</span>isset<span class="src-sym">(</span><span class="src-var">$user</span><span class="src-sym">[</span><span class="src-str">'rp'</span><span class="src-sym">]</span><span class="src-sym">[</span><span class="src-var">$realm</span><span class="src-sym">]</span><span class="src-sym">))&nbsp;</span><span class="src-sym">{</span></div></li>
<li><div class="src-line"><a name="a1120"></a>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-var">$rp&nbsp;</span>=&nbsp;<span class="src-var">$user</span><span class="src-sym">[</span><span class="src-str">'rp'</span><span class="src-sym">]</span><span class="src-sym">[</span><span class="src-var">$realm</span><span class="src-sym">]</span><span class="src-sym">;</span></div></li>
<li><div class="src-line"><a name="a1121"></a>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-sym">}&nbsp;</span><span class="src-key">else&nbsp;</span><span class="src-sym">{</span></div></li>
<li><div class="src-line"><a name="a1122"></a>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-var">$rp&nbsp;</span>=&nbsp;<span class="src-key">array</span><span class="src-sym">(</span><span class="src-str">'realm'&nbsp;</span>=&gt;&nbsp;<span class="src-var">$realm</span><span class="src-sym">,&nbsp;</span><span class="src-str">'first_time'&nbsp;</span>=&gt;&nbsp;<span class="src-var">$now</span><span class="src-sym">)</span><span class="src-sym">;</span></div></li>
<li><div class="src-line"><a name="a1123"></a>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-sym">}</span></div></li>
<li><div class="src-line"><a name="a1124"></a>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-var">$rp</span><span class="src-sym">[</span><span class="src-str">'last_time'</span><span class="src-sym">]&nbsp;</span>=&nbsp;<span class="src-var">$now</span><span class="src-sym">;</span></div></li>
<li><div class="src-line"><a name="a1125"></a>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-var">$rp</span><span class="src-sym">[</span><span class="src-str">'auto_release'</span><span class="src-sym">]&nbsp;</span>=&nbsp;<span class="src-sym">(</span>isset<span class="src-sym">(</span><span class="src-var">$GETPOST</span><span class="src-sym">[</span><span class="src-str">'autorelease'</span><span class="src-sym">]</span><span class="src-sym">)&nbsp;</span>&amp;&amp;&nbsp;<span class="src-var">$GETPOST</span><span class="src-sym">[</span><span class="src-str">'autorelease'</span><span class="src-sym">]</span><span class="src-sym">)&nbsp;</span>?&nbsp;<span class="src-num">1&nbsp;</span>:&nbsp;<span class="src-num">0</span><span class="src-sym">;</span></div></li>
<li><div class="src-line"><a name="a1126"></a>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</div></li>
<li><div class="src-line"><a name="a1127"></a>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-comm">//&nbsp;Mimic&nbsp;extension_invoke_all,&nbsp;but&nbsp;allow&nbsp;for&nbsp;passing&nbsp;by&nbsp;reference&nbsp;{{</span></div></li>
<li><div class="src-line"><a name="a1128"></a>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-key">global&nbsp;</span><a href="../simpleid/_www---common.inc.php.html#global$simpleid_extensions">$simpleid_extensions</a><span class="src-sym">;</span></div></li>
<li><div class="src-line"><a name="a1129"></a>&nbsp;&nbsp;&nbsp;&nbsp;</div></li>
<li><div class="src-line"><a name="a1130"></a>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-key">foreach&nbsp;</span><span class="src-sym">(</span><span class="src-var">$simpleid_extensions&nbsp;</span><span class="src-key">as&nbsp;</span><span class="src-var">$extension</span><span class="src-sym">)&nbsp;</span><span class="src-sym">{</span></div></li>
<li><div class="src-line"><a name="a1131"></a>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-var">$consent_function&nbsp;</span>=&nbsp;<span class="src-var">$extension&nbsp;</span>.&nbsp;<span class="src-str">'_consent'</span><span class="src-sym">;</span></div></li>
<li><div class="src-line"><a name="a1132"></a>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-key">if&nbsp;</span><span class="src-sym">(</span><a href="http://www.php.net/function_exists">function_exists</a><span class="src-sym">(</span><span class="src-var">$consent_function</span><span class="src-sym">))&nbsp;</span><span class="src-sym">{</span></div></li>
<li><div class="src-line"><a name="a1133"></a>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-var">$consent_function</span><span class="src-sym">(</span><span class="src-var">$GETPOST</span><span class="src-sym">,&nbsp;</span><span class="src-var">$response</span><span class="src-sym">,&nbsp;</span><span class="src-var">$rp</span><span class="src-sym">)</span><span class="src-sym">;</span></div></li>
<li><div class="src-line"><a name="a1134"></a>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-sym">}</span></div></li>
<li><div class="src-line"><a name="a1135"></a>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-sym">}</span></div></li>
<li><div class="src-line"><a name="a1136"></a>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-comm">//&nbsp;}}</span></div></li>
<li><div class="src-line"><a name="a1137"></a>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</div></li>
<li><div class="src-line"><a name="a1138"></a>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-var">$user</span><span class="src-sym">[</span><span class="src-str">'rp'</span><span class="src-sym">]</span><span class="src-sym">[</span><span class="src-var">$realm</span><span class="src-sym">]&nbsp;</span>=&nbsp;<span class="src-var">$rp</span><span class="src-sym">;</span></div></li>
<li><div class="src-line"><a name="a1139"></a>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a href="../simpleid/_www---user.inc.php.html#functionuser_save">user_save</a><span class="src-sym">(</span><span class="src-var">$user</span><span class="src-sym">)</span><span class="src-sym">;</span></div></li>
<li><div class="src-line"><a name="a1140"></a>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</div></li>
<li><div class="src-line"><a name="a1141"></a>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-var">$response&nbsp;</span>=&nbsp;<a href="../simpleid/_www---index.php.html#functionsimpleid_sign">simpleid_sign</a><span class="src-sym">(</span><span class="src-var">$response</span><span class="src-sym">,&nbsp;</span>isset<span class="src-sym">(</span><span class="src-var">$response</span><span class="src-sym">[</span><span class="src-str">'openid.assoc_handle'</span><span class="src-sym">]</span><span class="src-sym">)&nbsp;</span>?&nbsp;<span class="src-var">$response</span><span class="src-sym">[</span><span class="src-str">'openid.assoc_handle'</span><span class="src-sym">]&nbsp;</span>:&nbsp;<span class="src-id">NULL</span><span class="src-sym">)</span><span class="src-sym">;</span></div></li>
<li><div class="src-line"><a name="a1142"></a>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-key">if&nbsp;</span><span class="src-sym">(</span><span class="src-sym">!</span><span class="src-var">$return_to</span><span class="src-sym">)&nbsp;</span><a href="../simpleid/_www---common.inc.php.html#functionset_message">set_message</a><span class="src-sym">(</span><a href="../simpleid/_www---locale.inc.php.html#functiont">t</a><span class="src-sym">(</span><span class="src-str">'You&nbsp;were&nbsp;logged&nbsp;in&nbsp;successfully.'</span><span class="src-sym">))</span><span class="src-sym">;</span></div></li>
<li><div class="src-line"><a name="a1143"></a>&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-sym">}</span></div></li>
<li><div class="src-line"><a name="a1144"></a>&nbsp;</div></li>
<li><div class="src-line"><a name="a1145"></a>&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-key">if&nbsp;</span><span class="src-sym">(</span><span class="src-var">$return_to</span><span class="src-sym">)&nbsp;</span><span class="src-sym">{</span></div></li>
<li><div class="src-line"><a name="a1146"></a>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a href="../simpleid/_www---index.php.html#functionsimpleid_assertion_response">simpleid_assertion_response</a><span class="src-sym">(</span><span class="src-var">$response</span><span class="src-sym">,&nbsp;</span><span class="src-var">$return_to</span><span class="src-sym">)</span><span class="src-sym">;</span></div></li>
<li><div class="src-line"><a name="a1147"></a>&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-sym">}&nbsp;</span><span class="src-key">else&nbsp;</span><span class="src-sym">{</span></div></li>
<li><div class="src-line"><a name="a1148"></a>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a href="../simpleid/_www---page.inc.php.html#functionpage_dashboard">page_dashboard</a><span class="src-sym">(</span><span class="src-sym">)</span><span class="src-sym">;</span></div></li>
<li><div class="src-line"><a name="a1149"></a>&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-sym">}</span></div></li>
<li><div class="src-line"><a name="a1150"></a><span class="src-sym">}</span></div></li>
<li><div class="src-line"><a name="a1151"></a>&nbsp;</div></li>
<li><div class="src-line"><a name="a1152"></a><span class="src-doc">/**</span></div></li>
<li><div class="src-line"><a name="a1153"></a><span class="src-doc">&nbsp;*&nbsp;Sends&nbsp;an&nbsp;OpenID&nbsp;assertion&nbsp;response.</span></div></li>
<li><div class="src-line"><a name="a1154"></a><span class="src-doc">&nbsp;*</span></div></li>
<li><div class="src-line"><a name="a1155"></a><span class="src-doc">&nbsp;*&nbsp;The&nbsp;OpenID&nbsp;specification&nbsp;version&nbsp;2.0&nbsp;provides&nbsp;for&nbsp;the&nbsp;sending&nbsp;of&nbsp;assertions</span></div></li>
<li><div class="src-line"><a name="a1156"></a><span class="src-doc">&nbsp;*&nbsp;via&nbsp;indirect&nbsp;communication.&nbsp;&nbsp;However,&nbsp;future&nbsp;versions&nbsp;of&nbsp;the&nbsp;OpenID</span></div></li>
<li><div class="src-line"><a name="a1157"></a><span class="src-doc">&nbsp;*&nbsp;specification&nbsp;may&nbsp;provide&nbsp;for&nbsp;sending&nbsp;of&nbsp;assertions&nbsp;via&nbsp;direct&nbsp;communication.</span></div></li>
<li><div class="src-line"><a name="a1158"></a><span class="src-doc">&nbsp;*</span></div></li>
<li><div class="src-line"><a name="a1159"></a><span class="src-doc">&nbsp;*&nbsp;</span><span class="src-doc-coretag">@param&nbsp;</span><span class="src-doc-type">array&nbsp;</span><span class="src-doc-var">$response&nbsp;</span><span class="src-doc">the&nbsp;signed&nbsp;OpenID&nbsp;assertion&nbsp;response&nbsp;to&nbsp;send</span></div></li>
<li><div class="src-line"><a name="a1160"></a><span class="src-doc">&nbsp;*&nbsp;</span><span class="src-doc-coretag">@param&nbsp;</span><span class="src-doc-type">string&nbsp;</span><span class="src-doc-var">$indirect_url&nbsp;</span><span class="src-doc">the&nbsp;URL&nbsp;to&nbsp;which&nbsp;the&nbsp;OpenID&nbsp;response&nbsp;is&nbsp;sent.&nbsp;&nbsp;If</span></div></li>
<li><div class="src-line"><a name="a1161"></a><span class="src-doc">&nbsp;*&nbsp;&nbsp;this&nbsp;is&nbsp;an&nbsp;empty&nbsp;string,&nbsp;the&nbsp;response&nbsp;is&nbsp;sent&nbsp;via&nbsp;direct&nbsp;communication</span></div></li>
<li><div class="src-line"><a name="a1162"></a><span class="src-doc">&nbsp;*/</span></div></li>
<li><div class="src-line"><a name="a1163"></a><span class="src-key">function&nbsp;</span><a href="../simpleid/_www---index.php.html#functionsimpleid_assertion_response">simpleid_assertion_response</a><span class="src-sym">(</span><span class="src-var">$response</span><span class="src-sym">,&nbsp;</span><span class="src-var">$indirect_url&nbsp;</span>=&nbsp;<span class="src-id">NULL</span><span class="src-sym">)&nbsp;</span><span class="src-sym">{</span></div></li>
<li><div class="src-line"><a name="a1164"></a>&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-key">global&nbsp;</span><a href="../simpleid/_www---index.php.html#global$xtpl">$xtpl</a><span class="src-sym">,&nbsp;</span><a href="../simpleid/_www---index.php.html#global$version">$version</a><span class="src-sym">;</span></div></li>
<li><div class="src-line"><a name="a1165"></a>&nbsp;&nbsp;&nbsp;&nbsp;</div></li>
<li><div class="src-line"><a name="a1166"></a>&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-key">if&nbsp;</span><span class="src-sym">(</span><span class="src-var">$indirect_url</span><span class="src-sym">)&nbsp;</span><span class="src-sym">{</span></div></li>
<li><div class="src-line"><a name="a1167"></a>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-comm">//&nbsp;We&nbsp;want&nbsp;to&nbsp;see&nbsp;if&nbsp;the&nbsp;extensions&nbsp;want&nbsp;to&nbsp;change&nbsp;the&nbsp;way&nbsp;indirect&nbsp;responses&nbsp;are&nbsp;made</span></div></li>
<li><div class="src-line"><a name="a1168"></a>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-var">$results&nbsp;</span>=&nbsp;<a href="../simpleid/_www---common.inc.php.html#functionextension_invoke_all">extension_invoke_all</a><span class="src-sym">(</span><span class="src-str">'indirect_response'</span><span class="src-sym">,&nbsp;</span><span class="src-var">$indirect_url</span><span class="src-sym">,&nbsp;</span><span class="src-var">$response</span><span class="src-sym">)</span><span class="src-sym">;</span></div></li>
<li><div class="src-line"><a name="a1169"></a>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-var">$results&nbsp;</span>=&nbsp;<a href="http://www.php.net/array_filter">array_filter</a><span class="src-sym">(</span><span class="src-var">$results</span><span class="src-sym">,&nbsp;</span><span class="src-str">'is_null'</span><span class="src-sym">)</span><span class="src-sym">;</span></div></li>
<li><div class="src-line"><a name="a1170"></a>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-var">$component&nbsp;</span>=&nbsp;<span class="src-sym">(</span><span class="src-var">$results</span><span class="src-sym">)&nbsp;</span>?&nbsp;<a href="http://www.php.net/max">max</a><span class="src-sym">(</span><span class="src-var">$results</span><span class="src-sym">)&nbsp;</span>:&nbsp;<span class="src-id"><a href="../simpleid/_www---openid.inc.php.html#defineOPENID_RESPONSE_QUERY">OPENID_RESPONSE_QUERY</a></span><span class="src-sym">;</span></div></li>
<li><div class="src-line"><a name="a1171"></a>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</div></li>
<li><div class="src-line"><a name="a1172"></a>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a href="../simpleid/_www---openid.inc.php.html#functionopenid_indirect_response">openid_indirect_response</a><span class="src-sym">(</span><span class="src-var">$indirect_url</span><span class="src-sym">,&nbsp;</span><span class="src-var">$response</span><span class="src-sym">,&nbsp;</span><span class="src-var">$component</span><span class="src-sym">)</span><span class="src-sym">;</span></div></li>
<li><div class="src-line"><a name="a1173"></a>&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-sym">}&nbsp;</span><span class="src-key">else&nbsp;</span><span class="src-sym">{</span></div></li>
<li><div class="src-line"><a name="a1174"></a>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a href="../simpleid/_www---openid.inc.php.html#functionopenid_direct_response">openid_direct_response</a><span class="src-sym">(</span><a href="../simpleid/_www---openid.inc.php.html#functionopenid_direct_message">openid_direct_message</a><span class="src-sym">(</span><span class="src-var">$response</span><span class="src-sym">,&nbsp;</span><span class="src-var">$version</span><span class="src-sym">))</span><span class="src-sym">;</span></div></li>
<li><div class="src-line"><a name="a1175"></a>&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-sym">}</span></div></li>
<li><div class="src-line"><a name="a1176"></a><span class="src-sym">}</span></div></li>
<li><div class="src-line"><a name="a1177"></a>&nbsp;</div></li>
<li><div class="src-line"><a name="a1178"></a><span class="src-doc">/**</span></div></li>
<li><div class="src-line"><a name="a1179"></a><span class="src-doc">&nbsp;*&nbsp;Displays&nbsp;the&nbsp;XRDS&nbsp;document&nbsp;for&nbsp;this&nbsp;SimpleID&nbsp;installation.</span></div></li>
<li><div class="src-line"><a name="a1180"></a><span class="src-doc">&nbsp;*&nbsp;</span></div></li>
<li><div class="src-line"><a name="a1181"></a><span class="src-doc">&nbsp;*/</span></div></li>
<li><div class="src-line"><a name="a1182"></a><span class="src-key">function&nbsp;</span><a href="../simpleid/_www---index.php.html#functionsimpleid_xrds">simpleid_xrds</a><span class="src-sym">(</span><span class="src-sym">)&nbsp;</span><span class="src-sym">{</span></div></li>
<li><div class="src-line"><a name="a1183"></a>&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-key">global&nbsp;</span><a href="../simpleid/_www---index.php.html#global$xtpl">$xtpl</a><span class="src-sym">;</span></div></li>
<li><div class="src-line"><a name="a1184"></a>&nbsp;&nbsp;&nbsp;&nbsp;</div></li>
<li><div class="src-line"><a name="a1185"></a>&nbsp;&nbsp;&nbsp;&nbsp;<a href="../simpleid/_www---log.inc.php.html#functionlog_debug">log_debug</a><span class="src-sym">(</span><span class="src-str">'Providing&nbsp;XRDS.'</span><span class="src-sym">)</span><span class="src-sym">;</span></div></li>
<li><div class="src-line"><a name="a1186"></a>&nbsp;&nbsp;&nbsp;&nbsp;</div></li>
<li><div class="src-line"><a name="a1187"></a>&nbsp;&nbsp;&nbsp;&nbsp;<a href="http://www.php.net/header">header</a><span class="src-sym">(</span><span class="src-str">'Content-Type:&nbsp;application/xrds+xml'</span><span class="src-sym">)</span><span class="src-sym">;</span></div></li>
<li><div class="src-line"><a name="a1188"></a>&nbsp;&nbsp;&nbsp;&nbsp;<a href="http://www.php.net/header">header</a><span class="src-sym">(</span><span class="src-str">'Content-Disposition:&nbsp;inline;&nbsp;filename=yadis.xml'</span><span class="src-sym">)</span><span class="src-sym">;</span></div></li>
<li><div class="src-line"><a name="a1189"></a>&nbsp;&nbsp;&nbsp;&nbsp;</div></li>
<li><div class="src-line"><a name="a1190"></a>&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-var">$types&nbsp;</span>=&nbsp;<a href="../simpleid/_www---common.inc.php.html#functionextension_invoke_all">extension_invoke_all</a><span class="src-sym">(</span><span class="src-str">'xrds_types'</span><span class="src-sym">)</span><span class="src-sym">;</span></div></li>
<li><div class="src-line"><a name="a1191"></a>&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-key">foreach&nbsp;</span><span class="src-sym">(</span><span class="src-var">$types&nbsp;</span><span class="src-key">as&nbsp;</span><span class="src-var">$type</span><span class="src-sym">)&nbsp;</span><span class="src-sym">{</span></div></li>
<li><div class="src-line"><a name="a1192"></a>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-var">$xtpl</span><span class="src-sym">-&gt;</span><span class="src-id">assign</span><span class="src-sym">(</span><span class="src-str">'uri'</span><span class="src-sym">,&nbsp;</span><a href="http://www.php.net/htmlspecialchars">htmlspecialchars</a><span class="src-sym">(</span><span class="src-var">$type</span><span class="src-sym">,&nbsp;</span><span class="src-id">ENT_QUOTES</span><span class="src-sym">,&nbsp;</span><span class="src-str">'UTF-8'</span><span class="src-sym">))</span><span class="src-sym">;</span></div></li>
<li><div class="src-line"><a name="a1193"></a>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-var">$xtpl</span><span class="src-sym">-&gt;</span><span class="src-id">parse</span><span class="src-sym">(</span><span class="src-str">'xrds.op_xrds.type'</span><span class="src-sym">)</span><span class="src-sym">;</span></div></li>
<li><div class="src-line"><a name="a1194"></a>&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-sym">}</span></div></li>
<li><div class="src-line"><a name="a1195"></a>&nbsp;&nbsp;&nbsp;&nbsp;</div></li>
<li><div class="src-line"><a name="a1196"></a>&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-var">$xtpl</span><span class="src-sym">-&gt;</span><span class="src-id">assign</span><span class="src-sym">(</span><span class="src-str">'simpleid_base_url'</span><span class="src-sym">,&nbsp;</span><a href="http://www.php.net/htmlspecialchars">htmlspecialchars</a><span class="src-sym">(</span><a href="../simpleid/_www---common.inc.php.html#functionsimpleid_url">simpleid_url</a><span class="src-sym">(</span><span class="src-sym">)</span><span class="src-sym">,&nbsp;</span><span class="src-id">ENT_QUOTES</span><span class="src-sym">,&nbsp;</span><span class="src-str">'UTF-8'</span><span class="src-sym">)</span><span class="src-sym">,&nbsp;</span><span class="src-id">false</span><span class="src-sym">,&nbsp;</span><span class="src-str">'detect'</span><span class="src-sym">)</span><span class="src-sym">;</span></div></li>
<li><div class="src-line"><a name="a1197"></a>&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-var">$xtpl</span><span class="src-sym">-&gt;</span><span class="src-id">parse</span><span class="src-sym">(</span><span class="src-str">'xrds.op_xrds'</span><span class="src-sym">)</span><span class="src-sym">;</span></div></li>
<li><div class="src-line"><a name="a1198"></a>&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-var">$xtpl</span><span class="src-sym">-&gt;</span><span class="src-id">parse</span><span class="src-sym">(</span><span class="src-str">'xrds'</span><span class="src-sym">)</span><span class="src-sym">;</span></div></li>
<li><div class="src-line"><a name="a1199"></a>&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-var">$xtpl</span><span class="src-sym">-&gt;</span><span class="src-id">out</span><span class="src-sym">(</span><span class="src-str">'xrds'</span><span class="src-sym">)</span><span class="src-sym">;</span></div></li>
<li><div class="src-line"><a name="a1200"></a><span class="src-sym">}</span></div></li>
<li><div class="src-line"><a name="a1201"></a>&nbsp;</div></li>
<li><div class="src-line"><a name="a1202"></a>&nbsp;</div></li>
<li><div class="src-line"><a name="a1203"></a><span class="src-php">?&gt;</span></div></li>
</ol></div>
</div>
	<p class="notes" id="credit">
		Documentation generated on Mon, 06 Apr 2015 15:24:42 +1000 by <a href="http://www.phpdoc.org" target="_blank">phpDocumentor 1.4.1</a>
	</p>
	</body>
</html>